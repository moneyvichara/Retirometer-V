<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="description" content="Retirometer V ‚Äî PFRDA Hackathon 2026. Nine-module retirement planning calculator: NPS projection, goal finder, corpus integrator, annuity optimizer, risk dashboard and more.">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Retirometer V - From Retirement Corpus to Regular Pension: Plan Your Meaningful Retirement</title>
<meta property="og:title" content="Retirometer V ‚Äî PFRDA Hackathon 2026">
<meta property="og:description" content="From Retirement Corpus to Regular Pension: Plan Your Meaningful Retirement. Nine intelligent modules powered by real financial formulas.">
<meta property="og:type" content="website">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&family=Noto+Sans+Devanagari:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{
  /* PFRDA-aligned palette: deep navy authority + saffron energy */
  --bg:#F4F6F9;--bg2:#EBEEf4;--card:#FFFFFF;
  --navy:#0A2342;--navy2:#143260;--navy3:#1C4080;
  --pfrda-saffron:#E8640A;--pfrda-saffron2:#FF7A20;--saffron-dim:rgba(232,100,10,.10);
  --teal:#0A7C6E;--teal2:#0EA68F;--teal-dim:rgba(14,166,143,.10);
  --gold:#B8860B;--gold2:#D4A017;--gold-dim:rgba(184,134,11,.10);
  --purple:#5B21B6;--purple-dim:rgba(91,33,182,.10);
  --orange:#E8640A;--orange-dim:rgba(232,100,10,.10);
  --blue:#1A56C4;--blue-dim:rgba(26,86,196,.10);
  --coral:#C82020;--coral-dim:rgba(200,32,32,.08);
  --green:#15803D;--amber:#D97706;--red:#DC2626;
  --text:#1A2B3C;--muted:#5A6E82;--faint:#8FA3B8;--light:#DDE4ED;
  --shadow:0 4px 24px rgba(10,35,66,.08);--shadow-lg:0 12px 48px rgba(10,35,66,.14);
  --r:16px;--r-sm:10px;--r-xs:6px;
  --font:'Plus Jakarta Sans',sans-serif;--mono:'JetBrains Mono',monospace;--serif:'Playfair Display',serif;
  /* Retirometer V brand highlight */
  --rv-accent:#FFB800;--rv-accent2:#FF8C00;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;font-size:14px;line-height:1.5;background-image:radial-gradient(circle at 1px 1px, rgba(10,35,66,.04) 1px, transparent 0);background-size:24px 24px}
.hdr{position:sticky;top:0;z-index:200;background:linear-gradient(135deg,var(--navy) 0%,var(--navy2) 60%,var(--navy3) 100%);border-bottom:3px solid var(--pfrda-saffron);padding:0 32px;display:flex;justify-content:space-between;align-items:center;height:52px;box-shadow:0 3px 20px rgba(10,35,66,.3)}
.hdr-title{display:flex;align-items:center;gap:12px;overflow:hidden}
.hdr-brand{font-family:var(--serif);font-size:18px;font-weight:900;letter-spacing:.5px;white-space:nowrap;flex-shrink:0;
  background:linear-gradient(135deg,#FFD700,#FF8C00,#FFB800);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  filter:drop-shadow(0 0 8px rgba(255,184,0,.5));animation:brandGlow 3s ease-in-out infinite}
@keyframes brandGlow{0%,100%{filter:drop-shadow(0 0 6px rgba(255,184,0,.4))}50%{filter:drop-shadow(0 0 14px rgba(255,140,0,.7))}}
.hdr-sep{width:1px;height:22px;background:rgba(255,255,255,.2);flex-shrink:0}
.hdr-subtitle{font-family:var(--font);font-size:11.5px;font-weight:500;color:rgba(255,255,255,.72);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:.1px}
.hdr-right{display:flex;align-items:center;gap:10px;flex-shrink:0}
.lang-toggle{display:flex;gap:2px;background:rgba(255,255,255,.1);border-radius:8px;padding:3px}
.lang-btn{padding:3px 10px;border-radius:5px;font-size:11px;font-weight:700;border:none;cursor:pointer;background:transparent;color:rgba(255,255,255,.6);transition:all .2s;font-family:var(--font)}
.lang-btn.active{background:var(--pfrda-saffron);color:#fff;box-shadow:0 1px 4px rgba(232,100,10,.4)}
.print-btn{width:30px;height:30px;border-radius:7px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);cursor:pointer;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.7);font-size:13px;transition:all .2s}
.print-btn:hover{border-color:var(--pfrda-saffron);color:var(--pfrda-saffron)}
.hero{background:linear-gradient(150deg,#071526 0%,#0D2137 45%,#193a6a 100%);position:relative;overflow:hidden;padding:36px 32px 28px}
.hero::after{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 60% 80% at 90% 50%,rgba(18,179,156,.12) 0%,transparent 60%),radial-gradient(ellipse 40% 40% at 10% 80%,rgba(200,146,42,.08) 0%,transparent 50%);pointer-events:none}
.hero-inner{max-width:1100px;margin:0 auto;position:relative;z-index:1}
.hero-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(18,179,156,.15);border:1px solid rgba(18,179,156,.3);color:var(--teal2);font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:4px 13px;border-radius:20px;margin-bottom:12px}
.hero-title{font-family:var(--serif);font-size:clamp(24px,4vw,42px);font-weight:900;color:#fff;line-height:1.1;margin-bottom:8px}
.hero-title span{background:linear-gradient(135deg,var(--gold2),var(--teal2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero-sub{font-size:13px;color:rgba(255,255,255,.52);max-width:500px;line-height:1.65;margin-bottom:12px}
.hero-pills{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:10px}
.hero-pill{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);color:rgba(255,255,255,.6);font-size:10.5px;padding:3px 11px;border-radius:20px}
.hero-disc{font-size:10.5px;color:rgba(255,255,255,.28);line-height:1.65;max-width:580px}

.tabs-bar{background:var(--navy2);border-bottom:none;position:sticky;top:52px;z-index:100;box-shadow:0 3px 16px rgba(10,35,66,.25)}
.tabs-outer{max-width:1100px;margin:0 auto;display:flex;align-items:stretch;position:relative}
.tabs-inner{flex:1;display:flex;overflow-x:auto;scrollbar-width:none;padding:0 4px;scroll-behavior:smooth}
.tabs-inner::-webkit-scrollbar{display:none}
.tab-arrow{width:32px;flex-shrink:0;border:none;background:rgba(255,255,255,.07);cursor:pointer;color:rgba(255,255,255,.55);font-size:15px;display:flex;align-items:center;justify-content:center;transition:all .2s;z-index:2}
.tab-arrow:hover{color:#fff;background:rgba(232,100,10,.3)}
.tab-arrow.left{border-right:1px solid rgba(255,255,255,.1)}
.tab-arrow.right{border-left:1px solid rgba(255,255,255,.1)}
/* Module completion dots */
.mod-progress{background:var(--navy2);padding:2px 0;border-top:1px solid rgba(255,255,255,.05)}
.mod-prog-inner{max-width:1100px;margin:0 auto;display:flex;justify-content:center;gap:6px;padding:4px 24px}
.mod-dot{width:7px;height:7px;border-radius:50%;background:rgba(255,255,255,.15);transition:all .4s;cursor:default;title:''}
.mod-dot.done{background:var(--teal2);box-shadow:0 0 6px rgba(14,166,143,.5)}
.mod-dot.active{background:var(--pfrda-saffron);box-shadow:0 0 8px rgba(232,100,10,.5)}
/* GPS ‚Äî Global Profile Sync bar */
.gps-bar{background:linear-gradient(135deg,#f0f4fa,#f8fafc);border-bottom:2px solid var(--light);position:sticky;top:96px;z-index:90;box-shadow:0 2px 8px rgba(10,35,66,.06)}
.gps-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:6px;padding:7px 24px;flex-wrap:wrap}
.gps-badge{display:flex;align-items:center;gap:6px;padding:4px 10px;background:var(--navy);color:#fff;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:.5px;white-space:nowrap;flex-shrink:0}
.gps-field{display:flex;flex-direction:column;gap:2px;min-width:68px}
.gps-field label{font-size:8.5px;font-weight:700;color:var(--faint);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap}
.gps-field input{background:#fff;border:1.5px solid var(--light);border-radius:5px;color:var(--navy);font-family:var(--mono);font-size:11px;font-weight:600;padding:4px 6px;width:100%;outline:none;transition:border-color .2s}
.gps-field input:focus{border-color:var(--pfrda-saffron);box-shadow:0 0 0 2px rgba(232,100,10,.12)}
.gps-sync-dot{width:7px;height:7px;border-radius:50%;background:var(--pfrda-saffron);animation:blink 2s infinite;flex-shrink:0}
.gps-divider{width:1px;height:28px;background:var(--light);flex-shrink:0;margin:0 4px}
@media(max-width:768px){.gps-inner{padding:6px 12px;gap:5px}.gps-field{min-width:58px}}
.tab{flex-shrink:0;display:flex;align-items:center;gap:6px;padding:11px 15px;font-size:11.5px;font-weight:600;color:rgba(255,255,255,.55);cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;white-space:nowrap;background:none;border-top:none;border-left:none;border-right:none;font-family:var(--font)}
.tab:hover{color:rgba(255,255,255,.92);background:rgba(232,100,10,.12)}
.tab.active{color:#fff;border-bottom-color:var(--pfrda-saffron);background:rgba(232,100,10,.15)}
.tab-num{width:20px;height:20px;border-radius:6px;background:rgba(255,255,255,.12);color:rgba(255,255,255,.6);font-size:9.5px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;border:1px solid rgba(255,255,255,.1)}
.tab.active .tab-num{background:var(--pfrda-saffron);color:#fff;border-color:transparent;box-shadow:0 2px 6px rgba(232,100,10,.4)}
.main{max-width:1100px;margin:0 auto;padding:26px 32px 80px}
/* Tooltip help system */
.help-icon{display:inline-flex;align-items:center;justify-content:center;width:15px;height:15px;border-radius:50%;background:var(--faint);color:#fff;font-size:9px;font-weight:700;cursor:help;margin-left:5px;flex-shrink:0;transition:background .2s;vertical-align:middle;position:relative}
.help-icon:hover{background:var(--pfrda-saffron)}
.tooltip-wrap{position:relative;display:inline-flex;align-items:center}
.tooltip-box{visibility:hidden;opacity:0;position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:var(--navy);color:#fff;font-size:10.5px;font-weight:400;line-height:1.55;padding:9px 13px;border-radius:8px;width:240px;z-index:500;pointer-events:none;transition:opacity .2s;box-shadow:0 4px 18px rgba(10,35,66,.3);border:1px solid rgba(255,255,255,.1)}
.tooltip-box::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:var(--navy)}
.help-icon:hover+.tooltip-box,.tooltip-wrap:hover .tooltip-box{visibility:visible;opacity:1}
/* Metric explanation panel */
.metric-explainer{background:linear-gradient(135deg,rgba(10,35,66,.03),rgba(20,50,96,.05));border:1.5px solid rgba(10,35,66,.12);border-left:4px solid var(--pfrda-saffron);border-radius:var(--r-sm);padding:14px 16px;margin-bottom:16px;font-size:12px;line-height:1.7;color:var(--text)}
.metric-explainer h4{font-size:12px;font-weight:700;color:var(--navy);margin-bottom:8px;display:flex;align-items:center;gap:7px}
.me-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
@media(max-width:680px){.me-grid{grid-template-columns:1fr}}
.me-item{background:#fff;border:1px solid var(--light);border-radius:8px;padding:10px 12px}
.me-item-name{font-size:10px;font-weight:700;color:var(--navy);text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px}
.me-item-formula{font-family:var(--mono);font-size:10.5px;color:var(--pfrda-saffron);margin-bottom:4px;font-weight:600}
.me-item-desc{font-size:10.5px;color:var(--muted);line-height:1.5}
.me-item-bands{margin-top:6px;display:flex;flex-direction:column;gap:2px}
.me-band{display:flex;align-items:center;gap:5px;font-size:9.5px}
.me-band-dot{width:8px;height:8px;border-radius:2px;flex-shrink:0}
.page{display:none}
.page.active{display:block;animation:fadeUp .3s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.sec-hd{margin-bottom:22px}
.sec-tag{display:inline-block;font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:3px 10px;border-radius:20px;margin-bottom:7px}
.sec-hd h2{font-family:var(--serif);font-size:23px;color:var(--navy);margin-bottom:4px;padding-bottom:8px;border-bottom:2px solid var(--light);display:inline-block}
.sec-hd p{font-size:12.5px;color:var(--muted);max-width:620px;line-height:1.65}
.tag-teal{background:var(--teal-dim);color:var(--teal);border:1px solid rgba(10,124,110,.2)}
.tag-gold{background:var(--gold-dim);color:var(--gold);border:1px solid rgba(200,146,42,.2)}
.tag-purple{background:var(--purple-dim);color:var(--purple);border:1px solid rgba(109,40,217,.2)}
.tag-orange{background:var(--orange-dim);color:var(--orange);border:1px solid rgba(217,119,6,.2)}
.tag-coral{background:var(--coral-dim);color:var(--coral);border:1px solid rgba(220,38,38,.2)}
.tag-blue{background:var(--blue-dim);color:var(--blue);border:1px solid rgba(29,78,216,.2)}
.card{background:var(--card);border-radius:var(--r);padding:22px;box-shadow:var(--shadow);border:1px solid rgba(226,232,240,.8);margin-bottom:16px;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.bt-teal::before{background:linear-gradient(90deg,var(--teal2),var(--teal))}
.bt-gold::before{background:linear-gradient(90deg,var(--gold),var(--gold2))}
.bt-purple::before{background:linear-gradient(90deg,var(--purple),#8B5CF6)}
.bt-orange::before{background:linear-gradient(90deg,var(--orange),#F59E0B)}
.bt-coral::before{background:linear-gradient(90deg,var(--coral),#F97316)}
.bt-blue::before{background:linear-gradient(90deg,var(--blue),#3B82F6)}
.card-title{font-family:var(--serif);font-size:16.5px;color:var(--navy);margin-bottom:4px;display:flex;align-items:center;gap:8px}
.card-desc{font-size:12px;color:var(--muted);margin-bottom:18px;line-height:1.6}
.ig{display:grid;grid-template-columns:repeat(auto-fill,minmax(195px,1fr));gap:13px;margin-bottom:18px}
.ig3{display:grid;grid-template-columns:repeat(3,1fr);gap:13px;margin-bottom:18px}
.ig2{display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-bottom:18px}
@media(max-width:640px){.ig3,.ig2{grid-template-columns:1fr}}
.if{display:flex;flex-direction:column;gap:4px}
.if label{font-size:10px;font-weight:700;color:var(--muted);letter-spacing:.5px;text-transform:uppercase}
.if input,.if select{background:var(--bg2);border:1.5px solid var(--light);border-radius:var(--r-xs);color:var(--text);font-family:var(--mono);font-size:13px;padding:8px 11px;transition:border-color .2s;width:100%;outline:none}
.if input:focus,.if select:focus{border-color:var(--teal2);box-shadow:0 0 0 3px rgba(18,179,156,.1)}
.if .hint{font-size:10px;color:var(--faint);line-height:1.5;font-family:var(--font)}
.if input[type=range]{padding:0;height:4px;accent-color:var(--teal2);cursor:pointer;background:transparent;border:none;box-shadow:none}
.sl-row{display:flex;align-items:center;gap:10px}
.sl-row input[type=range]{flex:1}
.sl-val{font-family:var(--mono);font-size:12px;color:var(--teal2);min-width:38px;text-align:right;font-weight:600}
.btn-row{display:flex;gap:9px;flex-wrap:wrap;margin-top:6px}
.btn{background:linear-gradient(135deg,var(--pfrda-saffron2),var(--pfrda-saffron));color:#fff;border:none;border-radius:var(--r-sm);font-family:var(--font);font-size:13px;font-weight:700;padding:10px 22px;cursor:pointer;transition:all .2s;box-shadow:0 2px 8px rgba(232,100,10,.25)}
.btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(232,100,10,.35);letter-spacing:.3px}
.btn-s{background:#fff;border:1.5px solid var(--light);color:var(--muted);border-radius:var(--r-sm);font-family:var(--font);font-size:12px;padding:9px 16px;cursor:pointer;transition:all .2s}
.btn-s:hover{border-color:var(--pfrda-saffron);color:var(--pfrda-saffron)}
.btn-next{background:var(--navy);color:#fff;border:none;border-radius:var(--r-sm);font-family:var(--font);font-size:12px;font-weight:700;padding:9px 18px;cursor:pointer;transition:all .2s}
.btn-next:hover{background:var(--navy3)}
.rg{display:grid;grid-template-columns:repeat(auto-fill,minmax(158px,1fr));gap:11px;margin-top:16px}
.rc{background:var(--bg2);border:1.5px solid var(--light);border-radius:var(--r-sm);padding:14px;transition:all .2s}
.rc:hover{border-color:rgba(232,100,10,.25);transform:translateY(-1px)}
.rc-lbl{font-size:9.5px;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px;font-weight:600}
.rc-val{font-family:var(--mono);font-size:16px;font-weight:600;color:var(--navy)}
.rc-sub{font-size:9.5px;color:var(--faint);margin-top:2px}
.rc.hl{background:linear-gradient(135deg,rgba(14,166,143,.08),rgba(10,124,110,.04));border-color:rgba(14,166,143,.3);border-left:3px solid var(--teal2)}
.rc.hl .rc-val{color:var(--teal)}
.rc.hl .rc-lbl{color:var(--teal)}
.sc-row{display:grid;grid-template-columns:repeat(3,1fr);gap:11px;margin:14px 0}
@media(max-width:600px){.sc-row{grid-template-columns:1fr}}
.sc{background:var(--bg2);border:2px solid var(--light);border-radius:var(--r-sm);padding:18px 14px;text-align:center;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.sc:hover{border-color:var(--faint);transform:translateY(-2px)}
.sc.selected{border-color:var(--teal2);background:rgba(18,179,156,.05)}
.sc-top{height:3px;position:absolute;top:0;left:0;right:0}
.sc-lbl{font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:7px;font-weight:600}
.sc-val{font-family:var(--serif);font-size:20px;font-weight:900;color:var(--navy)}
.sc-rate{font-size:10.5px;color:var(--muted);margin-top:3px}
.sc-real{font-size:9.5px;color:var(--faint);margin-top:5px}
.sc-best{position:absolute;top:7px;right:9px;font-size:8.5px;font-weight:700;background:var(--teal2);color:#fff;border-radius:20px;padding:2px 6px}
.cw{background:var(--bg2);border:1px solid var(--light);border-radius:var(--r-sm);padding:18px;margin-top:14px;overflow:hidden}
.cw canvas{display:block;width:100%}
.cw-title{font-size:11.5px;color:var(--navy);margin-bottom:12px;font-weight:700;display:flex;align-items:center;gap:7px;padding-left:10px;border-left:3px solid var(--pfrda-saffron)}
.ib{border-radius:var(--r-sm);padding:11px 15px;font-size:12px;line-height:1.7;margin-bottom:14px}
.ib-teal{background:var(--teal-dim);border:1px solid rgba(10,124,110,.2);color:var(--text)}
.ib-teal strong{color:var(--teal)}
.ib-gold{background:var(--gold-dim);border:1px solid rgba(200,146,42,.2);color:var(--text)}
.ib-gold strong{color:var(--gold)}
.ib-coral{background:var(--coral-dim);border:1px solid rgba(220,38,38,.2);color:var(--text)}
.ib-coral strong{color:var(--coral)}
.divider{display:flex;align-items:center;gap:10px;margin:18px 0 14px}
.divider span{font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:1.5px;white-space:nowrap;font-weight:600}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--light)}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.three-col{display:grid;grid-template-columns:repeat(3,1fr);gap:13px}
@media(max-width:680px){.two-col,.three-col{grid-template-columns:1fr}}
.timeline{position:relative;padding:8px 0 8px 38px}
.tl-line{position:absolute;left:16px;top:0;bottom:0;width:2px;background:linear-gradient(180deg,var(--teal2),var(--gold));border-radius:2px}
.tl-item{display:flex;gap:14px;margin-bottom:18px;position:relative}
.tl-dot{width:13px;height:13px;border-radius:50%;flex-shrink:0;position:absolute;left:-27px;top:4px;border:2px solid #fff;box-shadow:0 0 0 2px var(--light)}
.tl-content{flex:1;background:#fff;border:1px solid var(--light);border-radius:var(--r-sm);padding:10px 14px;box-shadow:var(--shadow)}
.tl-age{font-size:9.5px;color:var(--faint);margin-bottom:2px;font-family:var(--mono)}
.tl-title{font-size:12.5px;font-weight:700;color:var(--navy);margin-bottom:2px}
.tl-val{font-size:11.5px;color:var(--muted)}
/* RETIROMETER GAUGE */
.gauge-section{background:#fff;border:1px solid var(--light);border-radius:var(--r);padding:22px;box-shadow:var(--shadow);margin-bottom:16px}
.gauge-lbl-top{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:14px;text-align:center}
.gauge-bar{display:grid;grid-template-columns:repeat(6,1fr);border-radius:8px;overflow:hidden;height:30px}
.gs{display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:#fff;text-align:center;padding:0 3px}
.gs1{background:#16A34A}.gs2{background:#4ADE80;color:#14532D}.gs3{background:#FACC15;color:#713F12}
.gs4{background:#F97316}.gs5{background:#EF4444}.gs6{background:#991B1B}
.gauge-ind{position:relative;height:18px;margin-top:3px}
.gauge-arr{position:absolute;transform:translateX(-50%);transition:left .7s cubic-bezier(.34,1.56,.64,1)}
.gauge-arr::before{content:'‚ñ≤';font-size:13px;color:var(--navy)}
.gauge-labs{display:grid;grid-template-columns:repeat(6,1fr);margin-top:1px}
.gauge-lab{font-size:8.5px;color:var(--faint);text-align:center;font-family:var(--mono)}
.gauge-verdict{margin-top:14px;padding:9px 16px;border-radius:20px;font-size:12.5px;font-weight:700;text-align:center;transition:all .4s}
.gauge-score-tag{display:block;margin-top:5px;font-size:10.5px;color:var(--muted);text-align:center}
.ratio-section{margin-top:16px}
.ratio-row{margin-bottom:12px}
.ratio-head{display:flex;justify-content:space-between;margin-bottom:4px}
.ratio-name{font-size:11px;font-weight:600;color:var(--navy)}
.ratio-val{font-family:var(--mono);font-size:11px;font-weight:600}
.ratio-track{background:var(--bg2);border-radius:6px;height:7px;overflow:hidden}
.ratio-fill{height:100%;border-radius:6px;transition:width .8s ease}
/* ARC GAUGE */
.arc-wrap{display:flex;flex-direction:column;align-items:center;padding:12px 8px 4px}
.arc-num{font-family:var(--serif);font-size:36px;font-weight:900;text-align:center;line-height:1;margin-top:-2px}
.arc-lbl{font-size:10.5px;color:var(--muted);margin-top:3px;text-align:center;font-weight:600}
.arc-verdict{margin-top:7px;padding:3px 13px;border-radius:20px;font-size:10.5px;font-weight:700;text-align:center}
/* SCORE CARDS */
.score-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:14px}
@media(max-width:680px){.score-grid{grid-template-columns:1fr}}
.score-card{background:var(--bg2);border:1.5px solid var(--light);border-radius:var(--r-sm);padding:18px;text-align:center}
.score-card-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--faint);margin-bottom:3px}
.score-card-meaning{font-size:9px;color:var(--muted);margin-top:2px;line-height:1.4}
.score-card-abbr{font-size:12px;font-weight:700;color:var(--navy);margin-bottom:10px}
.score-card-num{font-family:var(--serif);font-size:38px;font-weight:900;line-height:1;margin-bottom:5px}
.score-card-desc{font-size:10px;color:var(--muted);line-height:1.5}
.score-chip{display:inline-block;padding:3px 11px;border-radius:20px;font-size:9.5px;font-weight:700;margin-top:7px}
/* COMPARE */
.compare-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:13px;margin-bottom:18px}
@media(max-width:700px){.compare-grid{grid-template-columns:1fr}}
.compare-col{background:#fff;border:2px solid var(--light);border-radius:var(--r-sm);padding:16px}
.compare-col:nth-child(1){border-top:3px solid var(--blue)}
.compare-col:nth-child(2){border-top:3px solid var(--gold)}
.compare-col:nth-child(3){border-top:3px solid var(--green)}
.compare-col-head{font-size:12px;font-weight:700;margin-bottom:13px;padding-bottom:9px;border-bottom:1px solid var(--light)}
.winner-chip{background:linear-gradient(135deg,var(--teal2),var(--teal));color:#fff;padding:9px 18px;border-radius:10px;font-size:12.5px;font-weight:700;text-align:center;margin-bottom:14px}
/* ANNUITY TYPE */
.at-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;margin-bottom:14px}
@media(max-width:560px){.at-grid{grid-template-columns:repeat(2,1fr)}}
.at-opt{background:var(--bg2);border:1.5px solid var(--light);border-radius:7px;padding:9px;text-align:center;cursor:pointer;transition:all .2s;font-size:10.5px;font-weight:600;color:var(--muted)}
.at-opt.sel{border-color:var(--teal2);background:var(--teal-dim);color:var(--teal)}
/* SOURCE ROWS */
.src-row{display:flex;align-items:center;gap:10px;padding:11px 0;border-bottom:1px solid var(--light);flex-wrap:wrap}
.src-row:last-child{border-bottom:none}
.src-icon{font-size:18px;width:26px;flex-shrink:0}
.src-name-wrap{min-width:100px;flex:0 0 auto}
.src-name{font-size:12.5px;font-weight:600;color:var(--navy)}
.src-type{font-size:9.5px;color:var(--faint)}
.src-inputs{display:flex;gap:7px;flex:1;flex-wrap:wrap}
.src-input{background:var(--bg2);border:1.5px solid var(--light);border-radius:6px;color:var(--text);font-family:var(--mono);font-size:12px;padding:7px 9px;outline:none;transition:border-color .2s;min-width:0;flex:1}
.src-input:focus{border-color:var(--teal2)}
.src-ret{width:76px;flex:0 0 76px !important}
/* STRAT CARDS */
.strat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:13px;margin:14px 0}
@media(max-width:600px){.strat-grid{grid-template-columns:1fr}}
.strat-card{background:var(--bg2);border:2px solid var(--light);border-radius:var(--r-sm);padding:16px}
.strat-name{font-size:12px;font-weight:700;color:var(--navy);margin-bottom:3px}
.strat-desc{font-size:10.5px;color:var(--muted);margin-bottom:10px;line-height:1.5}
.strat-y1{font-family:var(--mono);font-size:19px;font-weight:600;color:var(--teal)}
.strat-yr-lbl{font-size:9px;color:var(--faint);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.strat-tag{display:inline-block;margin-top:7px;font-size:9px;font-weight:700;padding:2px 9px;border-radius:20px;text-transform:uppercase;letter-spacing:.5px}
/* SHOCK CARDS */
.shock-grid{display:grid;grid-template-columns:1fr 1fr;gap:13px;margin:13px 0}
@media(max-width:600px){.shock-grid{grid-template-columns:1fr}}
.shock-card{border-radius:var(--r-sm);padding:14px;border:1px solid}
.shock-base{background:rgba(22,163,74,.05);border-color:rgba(22,163,74,.2)}
.shock-shocked{background:rgba(220,38,38,.05);border-color:rgba(220,38,38,.2)}
.shock-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:7px}
.shock-base .shock-lbl{color:var(--green)}
.shock-shocked .shock-lbl{color:var(--coral)}
.shock-num{font-family:var(--mono);font-size:17px;font-weight:600;color:var(--navy)}
.shock-sub{font-size:10.5px;color:var(--muted);margin-top:2px}
.placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:44px 20px;background:var(--bg2);border:2px dashed var(--light);border-radius:var(--r-sm);text-align:center;color:var(--faint);gap:9px}
.placeholder .ph-icon{font-size:34px;opacity:.35}
.placeholder p{font-size:12.5px;line-height:1.6}
@media print{
  .hdr,.tabs-bar,.gps-bar,.btn-row,.mod-progress,button,.tab-arrow,footer{display:none!important}
  .print-name-header{display:block!important}
  .page{display:block!important;page-break-after:always}
  body{background:#fff;font-size:12px}
  .main{padding:10px}
  .card,.cw,.rg,.sc-row{box-shadow:none!important;border:1px solid #ccc}
  canvas{max-width:100%!important}
  .two-col,.three-col,.score-grid,.compare-grid,.sc-row{grid-template-columns:1fr 1fr!important}
  @page{margin:15mm}
  .disclaimer-banner{display:block!important;font-size:9px}
}
.print-name-header{display:none;padding:10px 0 6px;border-bottom:2px solid #0A2342;margin-bottom:12px;font-family:'Plus Jakarta Sans',sans-serif}
.print-name-header .pnh-brand{font-size:18px;font-weight:900;color:#0A2342;letter-spacing:.5px}
.print-name-header .pnh-user{font-size:13px;color:#5A6E82;margin-top:2px}
.print-name-header .pnh-meta{font-size:10px;color:#8FA3B8;margin-top:1px}
</style>
</head>
<body>
<!-- PRINT HEADER ‚Äî only visible when printing -->
<div class="print-name-header" id="print-name-header">
  <div class="pnh-brand">Retirometer V &nbsp;¬∑&nbsp; PFRDA Hackathon 2026</div>
  <div class="pnh-user" id="print-name-user"></div>
  <div class="pnh-meta" id="print-name-meta"></div>
</div>
<header class="hdr">
  <div class="hdr-title">
    <div class="hdr-brand">Retirometer V</div>
    <div style="background:rgba(232,100,10,.2);border:1px solid rgba(232,100,10,.4);color:var(--pfrda-saffron2);font-size:9px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;padding:2px 8px;border-radius:20px;white-space:nowrap;flex-shrink:0">PFRDA 2026</div>
    <div class="hdr-sep"></div>
    <div class="hdr-subtitle">From Retirement Corpus to Regular Pension ‚Äî Plan Your Meaningful Retirement</div>
  </div>
  <div class="hdr-right">
    <div class="lang-toggle">
      <button type="button" class="lang-btn active" id="btn-en" onclick="setLang('en')">EN</button>
      <button type="button" class="lang-btn" id="btn-hi" onclick="setLang('hi')">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
    </div>
    <button type="button" class="print-btn" onclick="if(typeof updatePrintHeader==='function')updatePrintHeader();window.print()" title="Print / Export">üñ®Ô∏è</button>
  </div>
</header>


<div class="tabs-bar">
  <div class="tabs-outer">
    <button type="button" class="tab-arrow left" id="tab-arr-l" onclick="scrollTabs(-1)" title="Scroll tabs left">‚Äπ</button>
    <div class="tabs-inner" id="tabs-scroll">
      <button type="button" class="tab active" onclick="switchTab(0)"><span class="tab-num">1</span> üìà <span data-t="tab1">NPS Simulator</span></button>
      <button type="button" class="tab" onclick="switchTab(1)"><span class="tab-num">2</span> üéØ <span data-t="tab2">Goal Finder</span></button>
      <button type="button" class="tab" onclick="switchTab(2)"><span class="tab-num">3</span> üß© <span data-t="tab3">Corpus Integrator</span></button>
      <button type="button" class="tab" onclick="switchTab(3)"><span class="tab-num">4</span> üè¶ <span data-t="tab4">Annuity Optimizer</span></button>
      <button type="button" class="tab" onclick="switchTab(4)"><span class="tab-num">5</span> ‚ö° <span data-t="tab5">Risk Dashboard</span></button>
      <button type="button" class="tab" onclick="switchTab(5)"><span class="tab-num">6</span> üîÄ <span data-t="tab6">Scenario Lab</span></button>
      <button type="button" class="tab" onclick="switchTab(6)"><span class="tab-num">7</span> üß¨ <span data-t="tab7">Fund Optimizer</span></button>
      <button type="button" class="tab" onclick="switchTab(7)"><span class="tab-num">8</span> ‚è≥ <span data-t="tab8">Sustainability</span></button>
      <button type="button" class="tab" onclick="switchTab(8)"><span class="tab-num">9</span> üè• <span data-t="tab9">Health Check</span></button>
    </div>
    <button type="button" class="tab-arrow right" id="tab-arr-r" onclick="scrollTabs(1)" title="Scroll tabs right">‚Ä∫</button>
  </div>
</div>

<!-- MODULE PROGRESS INDICATOR -->
<div class="mod-progress" id="mod-progress-bar">
  <div class="mod-prog-inner" title="Module completion ‚Äî green = calculated, orange = active">
    <div class="mod-dot active" id="mpd-0" title="M1: NPS Simulator"></div>
    <div class="mod-dot" id="mpd-1" title="M2: Goal Finder"></div>
    <div class="mod-dot" id="mpd-2" title="M3: Corpus Integrator"></div>
    <div class="mod-dot" id="mpd-3" title="M4: Annuity Optimizer"></div>
    <div class="mod-dot" id="mpd-4" title="M5: Risk Dashboard"></div>
    <div class="mod-dot" id="mpd-5" title="M6: Scenario Lab"></div>
    <div class="mod-dot" id="mpd-6" title="M7: Fund Optimizer"></div>
    <div class="mod-dot" id="mpd-7" title="M8: Sustainability"></div>
    <div class="mod-dot" id="mpd-8" title="M9: Health Check"></div>
  </div>
</div>
<!-- GLOBAL PROFILE SYNC BAR -->
<div class="gps-bar">
  <div class="gps-inner">
    <div class="gps-badge" title="Edit any field ‚Äî changes sync automatically to all linked modules">üë§ User Profile</div>
    <div class="gps-field" style="min-width:110px"><label title="Your name ‚Äî appears on printed reports">Name <span style="font-weight:400;color:var(--faint)">(Optional)</span></label><input type="text" id="gps-name" placeholder="e.g. Rahul Sharma" style="font-family:var(--font);font-size:11px"></div>
    <div class="gps-divider"></div>
    <div class="gps-field"><label title="Your current age">Current Age</label><input type="number" id="gps-age" value="32" min="18" max="70" data-gs="age"></div>
    <div class="gps-field"><label title="Your planned retirement age">Target Retire</label><input type="number" id="gps-ret" value="60" min="30" max="85" data-gs="ret"></div>
    <div class="gps-field"><label title="Planning horizon age ‚Äî how long your plan should cover. Conservative: use 90‚Äì92. Half of all people outlive their expected lifespan! Must be greater than Target Retire.">Plan To Age</label><input type="number" id="gps-le" value="90" min="60" max="100" data-gs="le" oninput="const rv=parseInt(this.value),rr=parseInt(document.getElementById('gps-ret').value);this.style.borderColor=(rv&&rr&&rv<=rr)?'#DC2626':'';"></div>
    <div class="gps-divider"></div>
    <div class="gps-field" style="min-width:96px"><label title="Current accumulated NPS balance only ‚Äî enter EPF/MF balances separately in Module 3">NPS Balance (‚Çπ)</label><input type="number" id="gps-cc" value="500000" step="10000" data-gs="cc"></div>
    <div class="gps-field" style="min-width:96px"><label title="Monthly amount you contribute to NPS only ‚Äî not EPF, SIP, or other instruments">NPS Contrib/mo (‚Çπ)</label><input type="number" id="gps-mc" value="15000" step="500" data-gs="mc"></div>
    <div class="gps-field"><label title="Annual % increase in NPS contribution">NPS Step-up %</label><input type="number" id="gps-su" value="5" step="1" min="0" max="25" data-gs="su"></div>
    <div class="gps-divider"></div>
    <div class="gps-field" style="min-width:90px"><label title="Current monthly household expenses in today's rupees">Monthly Exp (‚Çπ)</label><input type="number" id="gps-exp" value="40000" step="5000" data-gs="exp"></div>
    <div class="gps-field"><label title="Expected price inflation rate">Inflation %</label><input type="number" id="gps-inf" value="6" step="0.5" min="1" max="15" data-gs="inf"></div>
    <div class="gps-field"><label title="Expected blended portfolio return ‚Äî used in Goal Finder & Health Check">Expected Return %</label><input type="number" id="gps-rr" value="10" step="0.5" min="1" max="20" data-gs="rr"></div>
    <div style="font-size:9px;color:var(--faint);line-height:1.6;margin-left:8px;flex-shrink:0;max-width:110px;background:rgba(232,100,10,.07);border:1px solid rgba(232,100,10,.15);border-radius:6px;padding:5px 8px"><span style="color:var(--pfrda-saffron);font-weight:700">‚ö° Live Sync</span><br>Changes instantly update all 9 modules</div>
  </div>
</div>

<!-- LIVE STATS STRIP -->

<!-- DISCLAIMER BANNER -->
<div class="disclaimer-banner" style="background:linear-gradient(90deg,rgba(10,35,66,.04),rgba(10,35,66,.02));border-bottom:1px solid var(--light);padding:6px 32px;font-size:10.5px;color:var(--muted);display:flex;align-items:center;gap:8px;flex-wrap:wrap">
  <span style="font-size:12px;flex-shrink:0">üìã</span>
  <span><strong style="color:var(--navy)">Illustrative projections only.</strong> Assumes constant returns; actual market returns vary annually. NPS withdrawals: 60% lump sum is tax-free, annuity income taxed at slab. Equity LTCG &gt;‚Çπ1.25L taxed @12.5%. <strong style="color:var(--coral)">Consult a SEBI-registered financial advisor before investing.</strong></span>
</div>

<div class="main">
<!-- MODULE 1 -->
<div class="page active" id="page-0">
  <div class="sec-hd">
    <span class="sec-tag tag-teal" data-t="m1tag">Module 01 ¬∑ NPS Accumulation</span>
    <h2 data-t="m1h">NPS Growth Simulator</h2>
    <p data-t="m1p">Project your NPS corpus under three market scenarios. See the real power of compounding and identify your ideal retirement age.</p>
  </div>
  <div class="two-col">
    <div>
      <div class="card bt-teal">
        <div class="card-title" data-t="m1ct1">üìä Your NPS Profile</div>
        <div class="card-desc" data-t="m1cd1">Enter your details. Results update when you click Calculate. Annuity % is editable from 40‚Äì100% ‚Äî PFRDA mandates minimum 40% annuity purchase at NPS exit.</div>
        <div class="ig">
          <div class="if"><label data-t="l_age">Current Age</label><input type="number" id="m1-age" value="32" min="18" max="75"></div>
          <div class="if"><label data-t="l_ret">Retirement Age</label><input type="number" id="m1-ret" value="60" min="30" max="85"></div>
          <div class="if"><label data-t="l_cc">Current NPS Corpus (‚Çπ)</label><input type="number" id="m1-cc" value="500000" step="10000"></div>
          <div class="if"><label data-t="l_mc">Monthly Contribution (‚Çπ)</label><input type="number" id="m1-mc" value="15000" step="500"></div>
          <div class="if"><label data-t="l_su">Annual Step-up (%)</label><input type="number" id="m1-su" value="5" min="0" max="25"></div>
          <div class="if"><label data-t="l_inf">Inflation Rate (% p.a.)</label><input type="number" id="m1-inf" value="6" min="1" max="15"></div>
          <div class="if"><label data-t="l_exp">Current Monthly Expenses (‚Çπ, today's value)</label><input type="number" id="m1-exp" value="40000" step="5000"><span class="hint">Enter in today's rupees ‚Äî automatically inflated to retirement date</span></div>
          <div class="if"><label data-t="l_le">Plan To Age <span style="font-size:9px;color:var(--amber);font-weight:600">üìå Use 90‚Äì92 for conservative planning</span></label><input type="number" id="m1-le" value="90" min="60" max="100"><span class="hint">50% of people outlive their expected lifespan ‚Äî plan to age 90+ for safety</span></div>
          <div class="if"><label data-t="l_fund">Fund / Asset Mix</label>
            <select id="m1-fund" onchange="m1FundChange()">
              <option value="lc75" data-t="f75">LC-75 Aggressive (~12%)</option>
              <option value="lc50" selected data-t="f50">LC-50 Moderate (~10%)</option>
              <option value="lc25" data-t="f25">LC-25 Conservative (~8%)</option>
              <option value="custom" data-t="fcustom">Custom Return</option>
            </select>
          </div>
          <div class="if" id="m1-custom-row" style="display:none"><label data-t="l_cr">Custom Return (% p.a.)</label><input type="number" id="m1-cr" value="10" min="1" max="20"></div>
        </div>
        <div class="divider"><span data-t="div_corpus_split">Corpus Split at Retirement</span></div>
        <div class="ig2">
          <div class="if">
            <label data-t="l_apct">Annuity Allocation %</label>
            <div class="sl-row"><input type="range" id="m1-apct" min="40" max="100" value="40" step="5" oninput="updSl('m1-apct','m1-apct-v')"><span class="sl-val" id="m1-apct-v">40%</span></div>
            <div style="font-size:9.5px;color:#C2410C;margin-top:3px">‚öñÔ∏è PFRDA mandates minimum 40% annuity purchase at NPS exit (before age 75).</div>
            <span class="hint" data-t="h_apct">Your chosen allocation to guaranteed pension</span>
          </div>
          <div class="if">
            <label data-t="l_ar">Annuity Rate (% p.a.)</label>
            <div class="sl-row"><input type="range" id="m1-ar" min="3" max="10" value="6" step="0.25" oninput="updSl('m1-ar','m1-ar-v')"><span class="sl-val" id="m1-ar-v">6%</span></div>
            <span class="hint" data-t="h_ar">Check current rates with your annuity provider</span>
          </div>
        </div>
        <div class="btn-row">
          <button type="button" class="btn" onclick="calcM1()" data-t="btn_calc">Calculate ‚Üí</button>
          <button type="button" class="btn-s" onclick="resetM1()" data-t="btn_reset">Reset</button>
          <button type="button" class="btn-next" onclick="sendToM2();switchTab(1)" data-t="btn_next">Use in Goal Finder ‚Üí</button>
        </div>
      </div>
    </div>
    <div id="m1-right-ph"><div class="placeholder"><div class="ph-icon">üìà</div><p data-t="ph1">Enter your details and click <strong>Calculate</strong> to see your NPS corpus projection, withdrawal rate, and retirement risk score.</p><div style="font-size:10px;color:var(--faint);margin-top:6px">üí° Tip: Your User Profile fields auto-populate the inputs above</div></div></div>
  </div>

  <div id="m1-results" style="display:none">
    <div id="m1-tax-note" style="display:none;font-size:11px;line-height:1.7;padding:9px 14px;margin-bottom:12px;background:#fffbeb;border:1px solid #fde68a;border-radius:8px;border-left:4px solid #f59e0b;color:#92400e"></div>
    <div style="font-size:10px;color:var(--faint);text-align:center;margin-bottom:6px;font-style:italic">All corpus values shown in nominal future ‚Çπ ‚Äî see "Real" row below each for today's purchasing power equivalent</div>
    <div class="sc-row">
      <div class="sc" id="sc-cons" onclick="selSc('cons')">
        <div class="sc-top" style="background:linear-gradient(90deg,#60A5FA,#818CF8)"></div>
        <div class="sc-lbl" data-t="sc_cons">Conservative</div>
        <div class="sc-val" id="sc-cons-v">‚Äî</div>
        <div class="sc-rate" id="sc-cons-r"></div>
        <div class="sc-real" id="sc-cons-real"></div>
      </div>
      <div class="sc selected" id="sc-mod" onclick="selSc('mod')">
        <div class="sc-top" style="background:linear-gradient(90deg,var(--gold),var(--gold2))"></div>
        <div class="sc-lbl" data-t="sc_mod">Moderate ‚òÖ</div>
        <div class="sc-val" id="sc-mod-v">‚Äî</div>
        <div class="sc-rate" id="sc-mod-r"></div>
        <div class="sc-real" id="sc-mod-real"></div>
        <span class="sc-best" data-t="sc_best">BASE</span>
      </div>
      <div class="sc" id="sc-agg" onclick="selSc('agg')">
        <div class="sc-top" style="background:linear-gradient(90deg,var(--teal2),#10B981)"></div>
        <div class="sc-lbl" data-t="sc_agg">Aggressive</div>
        <div class="sc-val" id="sc-agg-v">‚Äî</div>
        <div class="sc-rate" id="sc-agg-r"></div>
        <div class="sc-real" id="sc-agg-real"></div>
      </div>
    </div>
    <div class="rg" id="m1-rg"></div>

    <!-- RETIROMETER GAUGE -->
    <div class="gauge-section">
      <div class="gauge-lbl-top" data-t="gauge_title">RETIROMETER ‚Äî RETIREMENT RISK GAUGE</div>
      <div style="font-size:11px;line-height:1.65;text-align:center;margin:-6px 0 12px;padding:7px 14px;background:rgba(232,100,10,.07);border:1px solid rgba(232,100,10,.2);border-radius:8px;color:#92400E">
        <strong>‚ö†Ô∏è NPS Pension Only ‚Äî</strong> This gauge measures risk based on your <strong>NPS corpus alone</strong> vs your total retirement expenses. EPF, PPF, Mutual Funds and other savings are <em>not included here</em>. Your actual risk position is likely better than shown. <span style="color:var(--teal);font-weight:700">‚Üí Add all your assets in Module 3 (Corpus Integrator) to get your complete multi-asset retirement score.</span>
      </div>
      <div class="gauge-bar">
        <div class="gs gs1" data-t="g1">Comfortable</div><div class="gs gs2" data-t="g2">Secure</div>
        <div class="gs gs3" data-t="g3">Stable</div><div class="gs gs4" data-t="g4">Mod Risk</div>
        <div class="gs gs5" data-t="g5">At Risk</div><div class="gs gs6" data-t="g6">Critical</div>
      </div>
      <div class="gauge-ind"><div class="gauge-arr" id="m1-gauge-arr" style="left:8%"></div></div>
      <div class="gauge-labs">
        <div class="gauge-lab" title="First-year withdrawal &lt;2% of corpus">&lt;2%</div>
        <div class="gauge-lab" title="First-year withdrawal 2‚Äì3% of corpus">2‚Äì3%</div>
        <div class="gauge-lab" title="First-year withdrawal 3‚Äì4% of corpus">3‚Äì4%</div>
        <div class="gauge-lab" title="First-year withdrawal 4‚Äì5% of corpus">4‚Äì5%</div>
        <div class="gauge-lab" title="First-year withdrawal 5‚Äì7% of corpus">5‚Äì7%</div>
        <div class="gauge-lab" title="First-year withdrawal &gt;7% of corpus ‚Äî high depletion risk">&gt;7%</div>
      </div>
      <div style="font-size:9px;color:var(--faint);text-align:center;margin-top:3px">SWR = First-year withdrawal √∑ Corpus ¬∑ Lower = Safer ¬∑ Hover bands for details</div>
      <div class="gauge-verdict" id="m1-verdict"></div>
      <span class="gauge-score-tag" id="m1-swr-tag"></span>
      <div style="font-size:10.5px;line-height:1.7;margin:10px 0 4px;padding:8px 14px;background:rgba(14,166,143,.07);border:1px solid rgba(14,166,143,.25);border-radius:8px;color:var(--teal)">
        üí° <strong>Remember:</strong> This score reflects NPS pension income only. In retirement, you can also draw from EPF, PPF, FD, Mutual Funds and other investments to supplement your expenses ‚Äî which will significantly improve your real-world score. Evaluate your full picture in <strong>Module 3 ‚Üí Corpus Integrator</strong>.
      </div>
      <div class="ratio-section">
        <div class="ratio-row">
          <div class="ratio-head"><span class="ratio-name" data-t="swr_lbl">Safe Withdrawal Rate (SWR)</span><span class="ratio-val" id="m1-swr-val"></span></div>
          <div class="ratio-track"><div class="ratio-fill" id="m1-swr-fill"></div></div>
        </div>
        <div class="ratio-row">
          <div class="ratio-head"><span class="ratio-name" data-t="wcr_lbl">Withdrawal Coverage Ratio (WCR)</span><span class="ratio-val" id="m1-wcr-val"></span></div>
          <div class="ratio-track"><div class="ratio-fill" id="m1-wcr-fill"></div></div>
        </div>
      </div>
    </div>

    <div class="cw">
      <div class="cw-title"><span>üìà</span> <span data-t="ch1_t">Corpus Growth ‚Äî Three Scenarios with Uncertainty Band</span></div>
      <canvas id="chart-m1-growth" height="260"></canvas>
    </div>
    <div class="two-col" style="margin-top:14px">
      <div class="cw" style="margin-top:0">
        <div class="cw-title"><span>üìä</span> <span data-t="ch1b_t">Contributions vs Investment Returns</span></div>
        <canvas id="chart-m1-stack" height="210"></canvas>
      </div>
      <div class="cw" style="margin-top:0">
        <div class="cw-title"><span>üóìÔ∏è</span> <span data-t="ch1c_t">Retirement Journey Milestones</span></div>
        <div id="m1-timeline" class="timeline"><div class="tl-line"></div></div>
      </div>
    </div>
    <div class="ib ib-teal" style="margin-top:14px"><strong data-t="m1_note_h">Note:</strong> <span data-t="m1_note">Three scenarios model Conservative/Moderate/Aggressive fund performance. The shaded band represents the full range of plausible outcomes ‚Äî your personal uncertainty band.</span></div>
  </div>
</div>
<!-- MODULE 2 -->
<div class="page" id="page-1">
  <div class="sec-hd">
    <span class="sec-tag tag-gold">Module 02 ¬∑ Goal Planning</span>
    <h2 data-t="m2h">Goal Finder ‚Äî Reverse Calculator</h2>
    <p data-t="m2p">Set your desired monthly pension. We reverse-engineer exactly what corpus and monthly contribution you need ‚Äî and show the penalty of waiting.</p>
  </div>
  <div class="two-col">
    <div class="card bt-gold">
      <div class="card-title" data-t="m2ct">üéØ Your Pension Goal</div>
      <div class="card-desc" data-t="m2cd">Enter your target monthly income in today's rupees. We inflate it to retirement date automatically and build the full calculation chain.</div>
      <div style="font-size:11px;line-height:1.7;margin:10px 0 4px;padding:10px 14px;background:rgba(184,134,11,.08);border:1px dashed rgba(184,134,11,.4);border-radius:8px;color:#78350F">
        <strong>üìå What counts as "pension" here?</strong> Pension is <em>ready, regular cash inflow</em> ‚Äî NPS annuity, EPF pension, interest from FD/PPF ‚Äî income that arrives automatically without selling any asset. While you can also <strong>withdraw from Mutual Funds, equity, or property</strong> in retirement, those are supplementary drawdowns, not guaranteed income.<br>
        <span style="display:block;margin-top:5px;color:#92400E"><strong>üí° Planning thumb-rule:</strong> Aim for at least <strong>60‚Äì70% of your monthly expenses to be covered through guaranteed pension income</strong> (NPS annuity + EPF + FD interest). The remainder can be drawn from market-linked investments ‚Äî but a strong guaranteed floor gives you security regardless of how markets perform.</span>
      </div>
      <div class="ig">
        <div class="if"><label data-t="l_dp">Desired Monthly Pension (‚Çπ today)</label><input type="number" id="m2-dp" value="60000" step="5000"></div>
        <div class="if"><label data-t="l_le">Life Expectancy</label><input type="number" id="m2-le" value="90" min="65" max="100"></div>
        <div class="if"><label data-t="l_age">Current Age</label><input type="number" id="m2-age" value="32" min="18" max="70"></div>
        <div class="if"><label data-t="l_ret">Retirement Age</label><input type="number" id="m2-ret" value="60" min="30" max="85"></div>
        <div class="if"><label data-t="l_cc">Existing NPS Corpus (‚Çπ)</label><input type="number" id="m2-cc" value="500000" step="10000"></div>
        <div class="if"><label data-t="l_mc_cur">Current Monthly Contribution (‚Çπ)</label><input type="number" id="m2-mc" value="15000" step="500"></div>
        <div class="if"><label data-t="l_su">Annual Step-up (%)</label><input type="number" id="m2-su" value="5" min="0" max="25"></div>
        <div class="if"><label data-t="l_inf">Inflation Rate (%)</label><input type="number" id="m2-inf" value="6" min="1" max="15"></div>
        <div class="if"><label data-t="l_rr">Expected Return (%)</label><input type="number" id="m2-rr" value="10" step="0.5"></div>
        <div class="if">
          <label data-t="l_apct">Annuity Allocation %</label>
          <div class="sl-row"><input type="range" id="m2-apct" min="40" max="100" value="40" step="5" oninput="updSl('m2-apct','m2-apct-v')"><span class="sl-val" id="m2-apct-v">40%</span></div>
          <div style="font-size:9.5px;color:#C2410C;margin-top:3px">‚öñÔ∏è PFRDA mandates minimum 40% annuity purchase at exit.</div>
        </div>
        <div class="if"><label data-t="l_ar">Annuity Rate (% p.a.)</label><input type="number" id="m2-ar" value="6" step="0.25" min="3" max="12"></div>
      </div>
      <div class="btn-row">
        <button type="button" class="btn" style="background:linear-gradient(135deg,var(--gold2),var(--gold))" onclick="calcM2()" data-t="btn_calc">Find My Goal ‚Üí</button>
        <button type="button" class="btn-s" onclick="resetM2()" data-t="btn_reset">Reset</button>
      </div>
    </div>
    <div id="m2-right-ph"><div class="placeholder"><div class="ph-icon">üéØ</div><p data-t="ph2">Set your desired pension and click <strong>Find My Goal</strong> to see what you need.</p></div></div>
  </div>

  <div id="m2-results" style="display:none">
    <div class="rg" id="m2-rg"></div>
    <div class="ib ib-gold" id="m2-chain" style="margin-top:14px"></div>
    <div class="two-col" style="margin-top:14px">
      <div class="cw" style="margin-top:0">
        <div class="cw-title"><span>üéØ</span> <span data-t="ch2a_t">Pension Adequacy</span></div>
        <div class="arc-wrap">
          <svg width="200" height="120" viewBox="0 0 200 120">
            <defs><linearGradient id="arcG" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color:#EF4444"/><stop offset="50%" style="stop-color:#F59E0B"/><stop offset="100%" style="stop-color:#16A34A"/>
            </linearGradient></defs>
            <path d="M24,108 A76,76 0 0,1 176,108" fill="none" stroke="#E2E8F0" stroke-width="16" stroke-linecap="round"/>
            <path id="arc-track" d="M24,108 A76,76 0 0,1 176,108" fill="none" stroke="url(#arcG)" stroke-width="16" stroke-linecap="round" stroke-dasharray="239" stroke-dashoffset="239" style="transition:stroke-dashoffset .9s ease"/>
            <circle id="arc-dot" cx="24" cy="108" r="8" fill="var(--teal2)" style="transition:all .9s ease"/>
          </svg>
          <div class="arc-num" id="m2-arc-num" style="color:var(--teal)">‚Äî</div>
          <div class="arc-lbl" data-t="arc_lbl">Current Plan Adequacy</div>
          <div class="arc-verdict" id="m2-arc-verdict"></div>
        </div>
      </div>
      <div class="cw" style="margin-top:0">
        <div class="cw-title"><span>‚è∞</span> <span data-t="ch2b_t">Cost of Delay</span></div>
        <canvas id="chart-m2-delay" height="210"></canvas>
      </div>
    </div>
    <div class="two-col" style="margin-top:14px">
      <div class="cw" style="margin-top:0">
        <div class="cw-title"><span>üí∞</span> <span data-t="ch2c_t">Monthly Pension vs Contribution Change</span></div>
        <div style="font-size:10px;color:var(--muted);margin-bottom:6px;line-height:1.5">Same retirement age ¬∑ Pension if you contribute <em>more or less</em> than your current plan</div>
        <canvas id="chart-m2-contrib" height="280"></canvas>
      </div>
      <div class="cw" style="margin-top:0">
        <div class="cw-title"><span>üìÖ</span> <span data-t="ch2d_t">Monthly Pension vs Retirement Age</span></div>
        <div style="font-size:10px;color:var(--muted);margin-bottom:6px;line-height:1.5">Same contribution ¬∑ Pension if you retire <em>earlier or later</em> than planned</div>
        <canvas id="chart-m2-retage" height="280"></canvas>
      </div>
    </div>
  </div>
</div>
<!-- MODULE 3 -->
<div class="page" id="page-2">
  <div class="sec-hd">
    <span class="sec-tag tag-purple">Module 03 ¬∑ Holistic Wealth</span>
    <h2 data-t="m3h">Holistic Corpus Integrator</h2>
    <p data-t="m3p">Your complete retirement picture across all savings instruments. Calculate your true Pension Stability Index (PSI).</p>
  </div>
  <div class="card bt-purple">
    <div class="card-title" data-t="m3ct">üß© All Retirement Assets</div>
    <div class="card-desc" data-t="m3cd">Enter current balance, monthly contribution, and expected return for each. All return rates are editable. <span style="color:var(--amber);font-weight:600">Note:</span> Monthly contributions are assumed flat (no step-up) for non-NPS sources ‚Äî this may slightly understate EPF/SIP corpus if your salary grows. All projected figures are in <strong>nominal future rupees</strong>.</div>
    <div style="display:grid;grid-template-columns:1fr 2fr 80px;gap:8px;margin-bottom:8px;padding:0 4px">
      <div style="font-size:9.5px;font-weight:700;color:var(--faint);text-transform:uppercase;letter-spacing:.8px" data-t="col_asset">Asset</div>
      <div style="font-size:9.5px;font-weight:700;color:var(--faint);text-transform:uppercase;letter-spacing:.8px" data-t="col_balance">Balance (‚Çπ) + Monthly Contribution (‚Çπ)</div>
      <div style="font-size:9.5px;font-weight:700;color:var(--faint);text-transform:uppercase;letter-spacing:.8px" data-t="col_return">Return %</div>
    </div>
    <div id="m3-sources">
      <div class="src-row"><div class="src-icon">üèõÔ∏è</div><div class="src-name-wrap"><div class="src-name" data-t="src_nps">NPS</div><div class="src-type" style="color:var(--purple)" data-t="src_nps_t">Market-linked</div></div><div class="src-inputs"><input class="src-input" type="number" id="s-nps-b" value="500000" placeholder="Balance"><input class="src-input" type="number" id="s-nps-m" value="15000" placeholder="Monthly"></div><input class="src-input src-ret" type="number" id="s-nps-r" value="10" step="0.5"></div>
      <div class="src-row"><div class="src-icon">üè¢</div><div class="src-name-wrap"><div class="src-name" data-t="src_epf">EPF / Gratuity</div><div class="src-type" style="color:var(--green)" data-t="src_epf_t">Guaranteed</div></div><div class="src-inputs"><input class="src-input" type="number" id="s-epf-b" value="300000" placeholder="Balance"><input class="src-input" type="number" id="s-epf-m" value="4500" placeholder="Monthly"></div><input class="src-input src-ret" type="number" id="s-epf-r" value="8.25" step="0.25"></div>
      <div class="src-row"><div class="src-icon">üìÆ</div><div class="src-name-wrap"><div class="src-name" data-t="src_ppf">PPF</div><div class="src-type" style="color:var(--green)" data-t="src_ppf_t">Guaranteed</div></div><div class="src-inputs"><input class="src-input" type="number" id="s-ppf-b" value="100000" placeholder="Balance"><input class="src-input" type="number" id="s-ppf-m" value="2000" placeholder="Monthly"></div><input class="src-input src-ret" type="number" id="s-ppf-r" value="7.1" step="0.1"></div>
      <div class="src-row"><div class="src-icon">üìà</div><div class="src-name-wrap"><div class="src-name">Mutual Funds</div><div class="src-type" style="color:var(--purple)">Market-linked</div></div><div class="src-inputs"><input class="src-input" type="number" id="s-mf-b" value="150000" placeholder="Balance"><input class="src-input" type="number" id="s-mf-m" value="3000" placeholder="Monthly SIP"></div><input class="src-input src-ret" type="number" id="s-mf-r" value="12" step="0.5"></div>
      <div class="src-row"><div class="src-icon">üìä</div><div class="src-name-wrap"><div class="src-name">Stocks / Equity</div><div class="src-type" style="color:#8B5CF6">Market-linked</div></div><div class="src-inputs"><input class="src-input" type="number" id="s-stk-b" value="0" placeholder="Balance"><input class="src-input" type="number" id="s-stk-m" value="0" placeholder="Monthly"></div><input class="src-input src-ret" type="number" id="s-stk-r" value="13" step="0.5"></div>
      <div class="src-row"><div class="src-icon">üè†</div><div class="src-name-wrap"><div class="src-name" data-t="src_prop">Property (Investable)</div><div class="src-type" style="color:var(--orange)" data-t="src_prop_t">Market-linked</div></div><div class="src-inputs"><input class="src-input" type="number" id="s-prop-b" value="0" placeholder="Value"><input class="src-input" type="number" id="s-prop-m" value="0" placeholder="Rental/mo"></div><input class="src-input src-ret" type="number" id="s-prop-r" value="7" step="0.5"></div>
      <div class="src-row"><div class="src-icon">üè¶</div><div class="src-name-wrap"><div class="src-name" data-t="src_fd">FD / Bonds</div><div class="src-type" style="color:var(--green)" data-t="src_fd_t">Guaranteed</div></div><div class="src-inputs"><input class="src-input" type="number" id="s-fd-b" value="50000" placeholder="Balance"><input class="src-input" type="number" id="s-fd-m" value="0" placeholder="Monthly"></div><input class="src-input src-ret" type="number" id="s-fd-r" value="7" step="0.25"></div>
      <div class="src-row"><div class="src-icon">ü•á</div><div class="src-name-wrap"><div class="src-name">Gold / Commodities</div><div class="src-type" style="color:#D97706">Market-linked</div></div><div class="src-inputs"><input class="src-input" type="number" id="s-gold-b" value="0" placeholder="Balance"><input class="src-input" type="number" id="s-gold-m" value="0" placeholder="Monthly"></div><input class="src-input src-ret" type="number" id="s-gold-r" value="8" step="0.5"></div>
      <div class="src-row"><div class="src-icon">üåê</div><div class="src-name-wrap"><div class="src-name">International / Crypto</div><div class="src-type" style="color:#EC4899">Market-linked (High Risk)</div></div><div class="src-inputs"><input class="src-input" type="number" id="s-intl-b" value="0" placeholder="Balance"><input class="src-input" type="number" id="s-intl-m" value="0" placeholder="Monthly"></div><input class="src-input src-ret" type="number" id="s-intl-r" value="12" step="0.5"></div>
      <div class="src-row"><div class="src-icon">üíº</div><div class="src-name-wrap"><div class="src-name" data-t="src_oth">Other Savings</div><div class="src-type" style="color:var(--faint)" data-t="src_oth_t">Mixed</div></div><div class="src-inputs"><input class="src-input" type="number" id="s-oth-b" value="0" placeholder="Balance"><input class="src-input" type="number" id="s-oth-m" value="0" placeholder="Monthly"></div><input class="src-input src-ret" type="number" id="s-oth-r" value="7" step="0.5"></div>
    </div>
    <div class="divider"><span data-t="div_params">Planning Parameters</span></div>
    <div class="ig3">
      <div class="if"><label data-t="l_age">Current Age</label><input type="number" id="m3-age" value="32"></div>
      <div class="if"><label data-t="l_ret">Retirement Age</label><input type="number" id="m3-ret" value="60"></div>
      <div class="if"><label data-t="l_le">Life Expectancy</label><input type="number" id="m3-le" value="90"></div>
      <div class="if"><label data-t="l_exp">Monthly Expenses (‚Çπ today)</label><input type="number" id="m3-exp" value="40000" step="5000"></div>
      <div class="if"><label data-t="l_inf">Inflation (%)</label><input type="number" id="m3-inf" value="6"></div>
      <div class="if"><label data-t="l_apct">Annuity % of NPS</label><div class="sl-row"><input type="range" id="m3-apct" min="40" max="100" value="40" step="5" oninput="updSl('m3-apct','m3-apct-v')"><span class="sl-val" id="m3-apct-v">40%</span></div>
      <div style="font-size:9.5px;color:#C2410C;margin-top:2px">‚öñÔ∏è PFRDA min 40%.</div></div>
      <div class="if"><label data-t="l_ar">NPS Annuity Rate (% p.a.)<span style="font-size:9.5px;font-weight:400;color:var(--faint);display:block">Consistent with Module 1. Check with your annuity provider.</span></label><input type="number" id="m3-ar" value="6" step="0.25" min="3" max="12"></div>
      <div class="if"><label>Post-Ret. Drawdown Return (%)<span style="font-size:9.5px;font-weight:400;color:var(--faint);display:block">Used for EPF/PPF/FD annual withdrawal calc. Default 7%.</span></label><input type="number" id="m3-post-ret-r" value="7" step="0.5" min="1" max="15"></div>
    </div>
    <div class="btn-row">
      <button type="button" class="btn" style="background:linear-gradient(135deg,var(--purple),#8B5CF6)" onclick="calcM3()" data-t="btn_calc">Analyse Portfolio ‚Üí</button>
      <button type="button" class="btn-s" onclick="resetM3()" data-t="btn_reset">Reset</button>
      <button type="button" class="btn-next" onclick="pushToM5();switchTab(4)" data-t="btn_push_m5">Push to Risk Dashboard ‚Üí</button>
      <button type="button" class="btn-next" onclick="pushToM4();switchTab(3)" style="background:linear-gradient(135deg,var(--orange),#F59E0B)" data-t="btn_push_m4">Push to Annuity Optimizer ‚Üí</button>
    </div>
  </div>
  <div id="m3-results" style="display:none">
    <div style="background:linear-gradient(135deg,#eff6ff,#f0fdf4);border:1.5px solid #bfdbfe;border-radius:10px;padding:12px 16px;margin-bottom:14px;font-size:11.5px;line-height:1.75;color:var(--navy)">
      <strong>üìñ Score Guide:</strong>
      <span style="display:inline-block;margin:0 8px"><strong style="color:var(--teal)">PSI</strong> = Guaranteed income √∑ Expenses. Higher = safer floor. Target ‚â• 75%.</span>¬∑
      <span style="display:inline-block;margin:0 8px"><strong style="color:var(--purple)">RSR</strong> = Total income √∑ Expenses. Target ‚â• 100%.</span>¬∑
      <span style="display:inline-block;margin:0 4px;color:var(--muted);font-size:10.5px">‚ö†Ô∏è All income figures are in today-inflated nominal rupees ‚Äî real purchasing power erodes with inflation. See Module 5 for full stress-tested risk scores.</span>
    </div>
    <div class="rg" id="m3-rg"></div>

    <!-- Asset Growth Section with tabs -->
    <div class="card bt-purple" style="margin-top:14px">
      <div class="card-title">üìà Asset Growth Journey ‚Äî Current to Retirement</div>
      <div class="card-desc">How each asset class grows over your accumulation period, with current allocation vs retirement-day allocation.</div>
      <!-- Sub-tabs for growth views -->
      <div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap" id="m3-growth-tabs">
        <button type="button" class="m3-gtab active" onclick="showM3GrowthTab('table')" style="font-size:11px;font-weight:700;padding:7px 16px;border-radius:20px;border:2px solid var(--purple);background:var(--purple);color:#fff;cursor:pointer;transition:all .2s">üìã Growth Table</button>
        <button type="button" class="m3-gtab" onclick="showM3GrowthTab('chart')" style="font-size:11px;font-weight:700;padding:7px 16px;border-radius:20px;border:2px solid var(--light);background:#fff;color:var(--muted);cursor:pointer;transition:all .2s">üìà Growth Chart</button>
        <button type="button" class="m3-gtab" onclick="showM3GrowthTab('alloc')" style="font-size:11px;font-weight:700;padding:7px 16px;border-radius:20px;border:2px solid var(--light);background:#fff;color:var(--muted);cursor:pointer;transition:all .2s">ü•ß Allocation Shift</button>
      </div>
      <!-- Growth Table -->
      <div id="m3-growth-table" style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse;min-width:580px;font-size:12px" id="m3-asset-tbl">
          <thead><tr style="background:var(--bg2)">
            <th style="padding:10px 13px;font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:.8px;text-align:left;font-weight:700;border-bottom:1.5px solid var(--light)">Asset Class</th>
            <th style="padding:10px 13px;font-size:9.5px;color:var(--purple);text-align:right;border-bottom:1.5px solid var(--light);font-weight:700">Current Balance</th>
            <th style="padding:10px 13px;font-size:9.5px;color:var(--gold);text-align:right;border-bottom:1.5px solid var(--light);font-weight:700">Monthly Contrib</th>
            <th style="padding:10px 13px;font-size:9.5px;color:var(--teal);text-align:right;border-bottom:1.5px solid var(--light);font-weight:700">Return %</th>
            <th style="padding:10px 13px;font-size:9.5px;color:var(--navy);text-align:right;border-bottom:1.5px solid var(--light);font-weight:700">At Retirement</th>
            <th style="padding:10px 13px;font-size:9.5px;color:var(--green);text-align:right;border-bottom:1.5px solid var(--light);font-weight:700">Growth Multiple</th>
            <th style="padding:10px 13px;font-size:9.5px;color:var(--faint);text-align:right;border-bottom:1.5px solid var(--light);font-weight:700">% of Total</th>
          </tr></thead>
          <tbody id="m3-asset-tbody"></tbody>
          <tfoot id="m3-asset-tfoot"></tfoot>
        </table>
      </div>
      <!-- Growth Chart -->
      <div id="m3-growth-chart" style="display:none">
        <div class="cw" style="margin-top:0;background:transparent;border:none;padding:0">
          <div style="font-size:10px;color:var(--faint);margin-bottom:6px">üìå Market-linked assets (NPS, MF, Equity) include your GPS step-up rate. Fixed instruments (EPF, PPF, FD) use flat monthly contributions.</div>
          <canvas id="chart-m3-growth" height="280"></canvas>
        </div>
      </div>
      <!-- Allocation Shift -->
      <div id="m3-growth-alloc" style="display:none">
        <div class="two-col" style="margin-top:0">
          <div>
            <div style="font-size:11px;font-weight:700;color:var(--navy);margin-bottom:10px;text-align:center">Current Allocation</div>
            <canvas id="chart-m3-alloc-now" height="220"></canvas>
          </div>
          <div>
            <div style="font-size:11px;font-weight:700;color:var(--navy);margin-bottom:10px;text-align:center">Allocation at Retirement</div>
            <canvas id="chart-m3-alloc-ret" height="220"></canvas>
          </div>
        </div>
        <div style="margin-top:12px;font-size:10.5px;color:var(--muted);line-height:1.7;background:var(--bg2);border-radius:8px;padding:10px 14px" id="m3-alloc-insight"></div>
      </div>
    </div>

    <div class="two-col" style="margin-top:14px">
      <div class="cw" style="margin-top:0"><div class="cw-title"><span>ü•ß</span> <span data-t="ch3a_t">Asset Allocation</span></div><canvas id="chart-m3-donut" height="240"></canvas></div>
      <div class="cw" style="margin-top:0"><div class="cw-title"><span>üìä</span> <span data-t="ch3b_t">Guaranteed vs Market-Linked Income (‚Çπ Nominal ¬∑ Market income depletes with corpus)</span></div><canvas id="chart-m3-stack" height="240"></canvas>
        <div id="m3-crossover-note" style="display:none;font-size:11.5px;line-height:1.7;padding:9px 13px;margin-top:8px;background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;border-left:4px solid #f97316"></div>
      </div>
    </div>
    <div class="gauge-section">
      <div class="gauge-lbl-top" data-t="psi_gauge_title">PENSION STABILITY INDEX (PSI) ‚Äî RETIROMETER GAUGE</div>
      <div class="gauge-bar">
        <div class="gs gs1" data-t="g1">Comfortable</div><div class="gs gs2" data-t="g2">Secure</div>
        <div class="gs gs3" data-t="g3">Stable</div><div class="gs gs4" data-t="g4">Mod Risk</div>
        <div class="gs gs5" data-t="g5">At Risk</div><div class="gs gs6" data-t="g6">Critical</div>
      </div>
      <div class="gauge-ind"><div class="gauge-arr" id="m3-gauge-arr" style="left:8%"></div></div>
      <div class="gauge-labs">
        <div class="gauge-lab">&gt;75%</div><div class="gauge-lab">60‚Äì75%</div><div class="gauge-lab">50‚Äì60%</div>
        <div class="gauge-lab">40‚Äì50%</div><div class="gauge-lab">25‚Äì40%</div><div class="gauge-lab">&lt;25%</div>
      </div>
      <div class="gauge-verdict" id="m3-verdict"></div>
      <span class="gauge-score-tag" id="m3-psi-tag"></span>
    </div>
  </div>
</div>

<!-- MODULE 4 -->
<div class="page" id="page-3">
  <div class="sec-hd">
    <span class="sec-tag tag-orange">Module 04 ¬∑ Pension Strategy</span>
    <h2 data-t="m4h">Annuity Optimizer</h2>
    <p data-t="m4p">Compare four pension structuring strategies at retirement. See income at Year 1, Year 10, Year 20 ‚Äî and when each strategy's corpus runs out.</p>
  </div>
  <div class="two-col">
    <div class="card bt-orange">
      <div class="card-title" data-t="m4ct">üè¶ Retirement Corpus Details</div>
      <div class="card-desc" data-t="m4cd">All allocation percentages are fully editable. No mandatory rules locked in ‚Äî explore freely.</div>
      <div class="ig">
        <div class="if"><label data-t="l_corpus">Retirement Corpus (‚Çπ)</label><input type="number" id="m4-corp" value="10000000" step="100000"></div>
        <div class="if"><label data-t="l_ar">Annuity Rate (% p.a.)</label><input type="number" id="m4-ar" value="6" step="0.25" min="3" max="12"></div>
        <div class="if"><label data-t="l_lr">Lump Sum Return (% p.a.)</label><input type="number" id="m4-lr" value="8" step="0.5"></div>
        <div class="if"><label data-t="l_inf">Inflation Rate (%)</label><input type="number" id="m4-inf" value="6"></div>
        <div class="if"><label data-t="l_ret_age">Retirement Age</label><input type="number" id="m4-ret" value="60"></div>
        <div class="if"><label data-t="l_le">Life Expectancy</label><input type="number" id="m4-le" value="90"></div>
      </div>
      <div class="divider"><span data-t="div_ann_type">Annuity Type</span></div>
      <div class="at-grid">
        <div class="at-opt sel" data-v="life" onclick="selAt(this)" data-t="at_life" title="Pays for your lifetime only ‚Äî highest payout rate. Stops on death.">Life Annuity<br><span style="font-size:8.5px;font-weight:400;opacity:.7">Highest payout ¬∑ Single life</span></div>
        <div class="at-opt" data-v="joint" onclick="selAt(this)" data-t="at_joint" title="Continues for surviving spouse ‚Äî ~10% lower payout than single life.">Joint Life<br><span style="font-size:8.5px;font-weight:400;opacity:.7">~10% lower ¬∑ Covers spouse</span></div>
        <div class="at-opt" data-v="rop" onclick="selAt(this)" data-t="at_rop" title="Purchase price returned to nominee on death ‚Äî ~8% lower payout.">Return of Purchase<br><span style="font-size:8.5px;font-weight:400;opacity:.7">~8% lower ¬∑ Nominee benefit</span></div>
        <div class="at-opt" data-v="inc" onclick="selAt(this)" data-t="at_inc" title="Payout grows 3% p.a. to offset inflation ‚Äî ~15% lower starting payout.">Increasing 3% p.a.<br><span style="font-size:8.5px;font-weight:400;opacity:.7">~15% lower ¬∑ Inflation hedge</span></div>
      </div>
      <div class="divider"><span data-t="div_custom_split">Custom Balanced Split</span></div>
      <div class="if">
        <label data-t="l_apct">Your Annuity % (for Balanced strategy)</label>
        <div class="sl-row"><input type="range" id="m4-apct" min="40" max="100" value="40" step="5" oninput="updSl('m4-apct','m4-apct-v')"><span class="sl-val" id="m4-apct-v">40%</span></div>
        <div style="font-size:9.5px;color:#C2410C;margin-top:3px">‚öñÔ∏è PFRDA mandates minimum 40% annuity purchase at NPS exit.</div>
      </div>
      <div class="btn-row">
        <button type="button" class="btn" style="background:linear-gradient(135deg,var(--orange),#F59E0B)" onclick="calcM4()" data-t="btn_calc">Compare Strategies ‚Üí</button>
        <button type="button" class="btn-s" onclick="resetM4()" data-t="btn_reset">Reset</button>
      </div>
    </div>
    <div id="m4-ph"><div class="placeholder"><div class="ph-icon">üè¶</div><p data-t="ph4">Enter corpus details and click <strong>Compare Strategies</strong> to see all four options.</p></div></div>
  </div>
  <div id="m4-results" style="display:none">
    <div class="strat-grid" id="m4-strats"></div>
    <div class="cw"><div class="cw-title"><span>üìä</span> <span data-t="ch4a_t">Monthly Income ‚Äî Year 1, Year 10, Year 20 by Strategy</span></div><canvas id="chart-m4-income" height="270"></canvas></div>
    <div class="two-col" style="margin-top:14px">
      <div class="cw" style="margin-top:0"><div class="cw-title"><span>üìâ</span> <span data-t="ch4b_t">Corpus Depletion Over Time</span></div><canvas id="chart-m4-deplete" height="210"></canvas></div>
      <div class="cw" style="margin-top:0"><div class="cw-title"><span>üå°Ô∏è</span> <span data-t="ch4c_t">Inflation Erosion of Fixed Annuity Income</span></div><canvas id="chart-m4-erosion" height="210"></canvas></div>
    </div>
  </div>
</div>

<!-- MODULE 5 -->
<div class="page" id="page-4">
  <div class="sec-hd">
    <span class="sec-tag" style="background:rgba(232,100,10,.12);color:var(--pfrda-saffron);border:1px solid rgba(232,100,10,.25)">Module 05 ¬∑ Risk Analysis</span>
    <h2 data-t="m5h">Retirement Risk Dashboard</h2>
    <p data-t="m5p">Three proprietary scores ‚Äî PSI, RSR, LCS ‚Äî plus the full Retirometer Risk Gauge, 6-dimension health radar, and market shock analysis.</p>
  </div>
  <div class="card bt-coral">
    <div class="card-title" data-t="m5ct">‚ö° Risk Assessment Inputs</div>
    <div class="card-desc" data-t="m5cd">Auto-populated from Module 3 when you use "Push to Risk Dashboard". Edit any field independently.</div>
    <div class="ig">
      <div class="if"><label data-t="l_corpus">Total Retirement Corpus (‚Çπ)</label><input type="number" id="m5-corp" value="10000000" step="100000"></div>
      <div class="if"><label data-t="l_gi">Guaranteed Annual Income (‚Çπ)</label><input type="number" id="m5-gi" value="240000" step="10000"><span class="hint" data-t="h_gi">Annuity + EPF pension + FD interest</span></div>
      <div class="if"><label data-t="l_ti">Total Annual Income (‚Çπ)</label><input type="number" id="m5-ti" value="600000" step="10000"><span class="hint" data-t="h_ti">All sources combined</span></div>
      <div class="if"><label data-t="l_exp">Annual Expenses at Retirement (‚Çπ)</label><input type="number" id="m5-exp" value="480000" step="10000"></div>
      <div class="if"><label data-t="l_pr">Post-Retirement Return (%)</label><input type="number" id="m5-pr" value="7" step="0.5"></div>
      <div class="if"><label data-t="l_inf">Inflation Rate (%)</label><input type="number" id="m5-inf" value="6"></div>
      <div class="if"><label data-t="l_le">Life Expectancy</label><input type="number" id="m5-le" value="90"></div>
      <div class="if"><label data-t="l_ret_age">Retirement Age</label><input type="number" id="m5-ret" value="60"></div>
    </div>
    <div class="btn-row">
      <button type="button" class="btn" style="background:linear-gradient(135deg,var(--coral),#F97316)" onclick="calcM5()" data-t="btn_calc">Analyse Risk ‚Üí</button>
      <button type="button" class="btn-s" onclick="resetM5()" data-t="btn_reset">Reset</button>
    </div>
  </div>

  <div id="m5-results" style="display:none">
    <!-- Metric Explainer Panel -->
    <div class="metric-explainer">
      <h4>üìê How to Read These Scores <span style="font-weight:400;color:var(--muted);font-size:11px">(click Analyse Risk to populate)</span></h4>
      <div class="me-grid">
        <div class="me-item">
          <div class="me-item-name">PSI ‚Äî Pension Stability Index</div>
          <div class="me-item-formula">Guaranteed Income √∑ Annual Expenses</div>
          <div class="me-item-desc">What % of your expenses are covered by <em>guaranteed</em> sources (annuity, EPF pension, FD interest) ‚Äî income that never stops regardless of markets.</div>
          <div class="me-item-bands">
            <div class="me-band"><div class="me-band-dot" style="background:#16A34A"></div><span style="color:#15803D;font-weight:700">&gt;75%</span> ‚Äî Comfortable</div>
            <div class="me-band"><div class="me-band-dot" style="background:#D97706"></div><span style="color:#92400E;font-weight:700">40‚Äì60%</span> ‚Äî Moderate Risk</div>
            <div class="me-band"><div class="me-band-dot" style="background:#DC2626"></div><span style="color:#B91C1C;font-weight:700">&lt;25%</span> ‚Äî Critical</div>
          </div>
        </div>
        <div class="me-item">
          <div class="me-item-name">RSR ‚Äî Retirement Sufficiency Ratio</div>
          <div class="me-item-formula">Total Income (all sources) √∑ Annual Expenses</div>
          <div class="me-item-desc">Whether your <em>total</em> retirement income (guaranteed + market-linked) is enough to cover expenses. 100% = exactly sufficient; above 100% = surplus.</div>
          <div class="me-item-bands">
            <div class="me-band"><div class="me-band-dot" style="background:#16A34A"></div><span style="color:#15803D;font-weight:700">&gt;130%</span> ‚Äî Surplus</div>
            <div class="me-band"><div class="me-band-dot" style="background:#D97706"></div><span style="color:#92400E;font-weight:700">80‚Äì100%</span> ‚Äî Partial Gap</div>
            <div class="me-band"><div class="me-band-dot" style="background:#DC2626"></div><span style="color:#B91C1C;font-weight:700">&lt;80%</span> ‚Äî Critical Shortfall</div>
          </div>
        </div>
        <div class="me-item">
          <div class="me-item-name">LCS ‚Äî Longevity Coverage Score</div>
          <div class="me-item-formula">Years corpus survives under stress conditions</div>
          <div class="me-item-desc">Simulates a <em>worst-case</em> scenario: returns 3% lower, inflation 2% higher than your inputs. Shows how many years your corpus lasts before running out.</div>
          <div class="me-item-bands">
            <div class="me-band"><div class="me-band-dot" style="background:#16A34A"></div><span style="color:#15803D;font-weight:700">Full period</span> ‚Äî Stress-proof</div>
            <div class="me-band"><div class="me-band-dot" style="background:#D97706"></div><span style="color:#92400E;font-weight:700">75% of period</span> ‚Äî Moderate</div>
            <div class="me-band"><div class="me-band-dot" style="background:#DC2626"></div><span style="color:#B91C1C;font-weight:700">&lt;50%</span> ‚Äî Longevity Risk</div>
          </div>
        </div>
      </div>
      <div style="margin-top:10px;font-size:11px;color:var(--muted);border-top:1px solid var(--light);padding-top:8px">
        <strong>üìä Retirometer Gauge</strong> measures the PSI score on a 6-band colour scale. The arrow shows your position ‚Äî aim to keep it in the green zone.
        &nbsp;|&nbsp; <strong>üí• Market Shock Test</strong> simulates what happens if markets fall 40% in your first year of retirement ‚Äî the most dangerous scenario (sequence-of-returns risk).
        &nbsp;|&nbsp; <strong>üï∏Ô∏è Radar note:</strong> Liquidity and Sequence Risk are trade-offs ‚Äî more market income improves flexibility (Liquidity ‚Üë) but increases sequence risk (Seq. Risk ‚Üì). Both cannot be maximised simultaneously; the ideal is a balanced mix. Diversification score peaks at 50-50 guaranteed/market split; 100% guaranteed income scores low here despite being safest ‚Äî use PSI and RSR as primary safety metrics.
      </div>
    </div>

    <div class="gauge-section">
      <div class="gauge-lbl-top" data-t="gauge_title_full">RETIROMETER ‚Äî PENSION STABILITY INDEX GAUGE</div>
      <div style="font-size:11px;color:var(--muted);text-align:center;margin:4px 0 10px;line-height:1.6">
        The arrow shows your <strong>PSI</strong> (Guaranteed Income as % of Expenses). 
        Aim for the <span style="color:#15803D;font-weight:700">green zone (‚â•75%)</span> ‚Äî it means your non-negotiable expenses are covered even if markets crash.
        The gauge does <em>not</em> account for market-linked income or corpus drawdown (see RSR and LCS below for that).
      </div>
      <div class="gauge-bar">
        <div class="gs gs1" data-t="g1">Comfortable</div><div class="gs gs2" data-t="g2">Secure</div>
        <div class="gs gs3" data-t="g3">Stable</div><div class="gs gs4" data-t="g4">Mod Risk</div>
        <div class="gs gs5" data-t="g5">At Risk</div><div class="gs gs6" data-t="g6">Critical</div>
      </div>
      <div class="gauge-ind"><div class="gauge-arr" id="m5-gauge-arr" style="left:8%"></div></div>
      <div class="gauge-labs">
        <div class="gauge-lab">&gt;75%</div><div class="gauge-lab">60‚Äì75%</div><div class="gauge-lab">50‚Äì60%</div>
        <div class="gauge-lab">40‚Äì50%</div><div class="gauge-lab">25‚Äì40%</div><div class="gauge-lab">&lt;25%</div>
      </div>
      <div class="gauge-verdict" id="m5-verdict"></div>
      <span class="gauge-score-tag" id="m5-gauge-sub"></span>
      <div class="ratio-section">
        <div class="ratio-row"><div class="ratio-head"><span class="ratio-name">PSI ‚Äî <span data-t="psi_name">Pension Stability Index</span></span><span class="ratio-val" id="m5-psi-val"></span></div><div class="ratio-track"><div class="ratio-fill" id="m5-psi-fill"></div></div></div>
        <div class="ratio-row"><div class="ratio-head"><span class="ratio-name">RSR ‚Äî <span data-t="rsr_name">Retirement Sufficiency Ratio</span></span><span class="ratio-val" id="m5-rsr-val"></span></div><div class="ratio-track"><div class="ratio-fill" id="m5-rsr-fill"></div></div></div>
        <div class="ratio-row"><div class="ratio-head"><span class="ratio-name">SWR ‚Äî <span data-t="swr_name">Safe Withdrawal Rate</span></span><span class="ratio-val" id="m5-swr-val"></span></div><div class="ratio-track"><div class="ratio-fill" id="m5-swr-fill"></div></div></div>
      </div>
    </div>

    <div class="score-grid">
      <div class="score-card">
        <div class="score-card-lbl">PSI ‚Äî Pension Stability Index</div>
        <div class="score-card-abbr" style="color:var(--teal)">PSI</div>
        <div class="score-card-num" id="m5-psi-num" style="color:var(--teal)">‚Äî</div>
        <div class="score-card-desc">
          <strong>Formula:</strong> Guaranteed Income √∑ Annual Expenses √ó 100<br>
          <strong>What it measures:</strong> The % of your expenses covered by income that <em>cannot stop</em> ‚Äî annuity, EPF pension, FD interest, PPF withdrawals.<br>
          <strong>Target:</strong> ‚â•75% for a stress-free retirement
        </div>
        <div class="score-chip" id="m5-psi-chip"></div>
      </div>
      <div class="score-card">
        <div class="score-card-lbl">RSR ‚Äî Retirement Sufficiency Ratio</div>
        <div class="score-card-abbr" style="color:var(--gold)">RSR</div>
        <div class="score-card-num" id="m5-rsr-num" style="color:var(--gold)">‚Äî</div>
        <div class="score-card-desc">
          <strong>Formula:</strong> Total Income (all sources) √∑ Annual Expenses √ó 100<br>
          <strong>What it measures:</strong> Overall retirement income coverage from <em>all</em> sources ‚Äî both guaranteed and market-linked.<br>
          <strong>Target:</strong> ‚â•130% (surplus), 100% = break-even
        </div>
        <div class="score-chip" id="m5-rsr-chip"></div>
      </div>
      <div class="score-card">
        <div class="score-card-lbl">LCS ‚Äî Longevity Coverage Score</div>
        <div class="score-card-abbr" style="color:var(--purple)">LCS</div>
        <div class="score-card-num" id="m5-lcs-num" style="color:var(--purple)">‚Äî</div>
        <div class="score-card-desc">
          <strong>Stress test:</strong> Return ‚àí3%, Inflation +2% vs your inputs<br>
          <strong>What it measures:</strong> Years your corpus survives in worst-case conditions, with guaranteed income still flowing to offset withdrawals.<br>
          <strong>Target:</strong> ‚â• full retirement period (cover to life expectancy)
        </div>
        <div class="score-chip" id="m5-lcs-chip"></div>
      </div>
    </div>

    <div class="two-col" style="margin-top:14px">
      <div class="cw" style="margin-top:0;background:#fff;border:1px solid var(--light)"><div class="cw-title"><span>üï∏Ô∏è</span> <span data-t="ch5a_t">6-Dimension Retirement Health Radar</span></div><canvas id="chart-m5-radar" height="270"></canvas></div>
    <div class="cw"><div class="cw-title"><span>üí•</span> <span data-t="ch5b_t">Market Shock Test ‚Äî Base vs ‚àí40% Crash in Year 1</span></div>
      <div style="font-size:10.5px;color:var(--muted);margin-bottom:8px;padding:6px 10px;background:rgba(220,32,32,.05);border-radius:6px;border-left:3px solid #DC2626">‚ö†Ô∏è <strong>Sequence-of-Returns Risk:</strong> A market crash in your first year of retirement is the most damaging scenario ‚Äî you sell units at a low price to fund expenses, permanently reducing your corpus base. This chart shows how your corpus diverges between normal and shocked conditions over your full retirement horizon.</div>
      <canvas id="chart-m5-shock" height="270"></canvas></div>
    </div>
    <div class="cw"><div class="cw-title"><span>üå°Ô∏è</span> <span data-t="ch5c_t">Inflation Erosion ‚Äî Real Value of ‚Çπ1 Lakh Fixed Annual Income</span></div><canvas id="chart-m5-erosion" height="190"></canvas></div>
    <div class="shock-grid">
      <div class="shock-card shock-base"><div class="shock-lbl" data-t="shock_base">üìä Base Scenario</div><div class="shock-num" id="m5-base-80">‚Äî</div><div class="shock-sub" data-t="shock_at80">Corpus at Age 80</div><div class="shock-num" id="m5-base-85" style="margin-top:8px">‚Äî</div><div class="shock-sub" data-t="shock_at85">Corpus at Age 85</div></div>
      <div class="shock-card shock-shocked"><div class="shock-lbl" data-t="shock_shocked">üí• After Market Shock (‚àí40% Year 1)</div><div class="shock-num" id="m5-shock-80">‚Äî</div><div class="shock-sub" data-t="shock_at80">Corpus at Age 80</div><div class="shock-num" id="m5-shock-85" style="margin-top:8px">‚Äî</div><div class="shock-sub" data-t="shock_at85">Corpus at Age 85</div></div>
    </div>
    <div class="ib ib-coral" id="m5-advice" style="margin-top:12px"></div>
  </div>
</div>

<!-- MODULE 6 -->
<div class="page" id="page-5">
  <div class="sec-hd">
    <span class="sec-tag tag-blue">Module 06 ¬∑ Scenario Planning</span>
    <h2 data-t="m6h">Scenario Lab</h2>
    <p data-t="m6p">Create three custom scenarios and compare side by side ‚Äî different contribution levels, start ages, return assumptions, or retirement ages.</p>
  </div>
  <div class="compare-grid">
    <div class="compare-col">
      <div class="compare-col-head" style="color:var(--blue)">üîµ <span data-t="sc_a">Scenario A</span></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_name">Name</label><input type="text" id="sca-name" value="Current Plan" style="background:var(--bg2);border:1.5px solid var(--light);border-radius:6px;color:var(--text);font-family:var(--font);font-size:13px;padding:8px 10px;width:100%;outline:none"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_age">Start Age</label><input type="number" id="sca-age" value="32"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_ret">Retire Age</label><input type="number" id="sca-ret" value="60"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_cc">Current Corpus (‚Çπ)</label><input type="number" id="sca-cc" value="500000"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_mc">Monthly Contrib (‚Çπ)</label><input type="number" id="sca-mc" value="15000"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_su">Step-up (%)</label><input type="number" id="sca-su" value="5"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_ret_rate">Return Rate (%)</label><input type="number" id="sca-r" value="10"></div>
      <div class="if"><label data-t="l_inf">Inflation (%)</label><input type="number" id="sca-inf" value="6"></div>
    </div>
    <div class="compare-col">
      <div class="compare-col-head" style="color:var(--gold)">üü° <span data-t="sc_b">Scenario B</span></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_name">Name</label><input type="text" id="scb-name" value="Higher Contribution" style="background:var(--bg2);border:1.5px solid var(--light);border-radius:6px;color:var(--text);font-family:var(--font);font-size:13px;padding:8px 10px;width:100%;outline:none"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_age">Start Age</label><input type="number" id="scb-age" value="32"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_ret">Retire Age</label><input type="number" id="scb-ret" value="60"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_cc">Current Corpus (‚Çπ)</label><input type="number" id="scb-cc" value="200000"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_mc">Monthly Contrib (‚Çπ)</label><input type="number" id="scb-mc" value="15000"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_su">Step-up (%)</label><input type="number" id="scb-su" value="5"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_ret_rate">Return Rate (%)</label><input type="number" id="scb-r" value="10"></div>
      <div class="if"><label data-t="l_inf">Inflation (%)</label><input type="number" id="scb-inf" value="6"></div>
    </div>
    <div class="compare-col">
      <div class="compare-col-head" style="color:var(--green)">üü¢ <span data-t="sc_c">Scenario C</span></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_name">Name</label><input type="text" id="scc-name" value="Early Start" style="background:var(--bg2);border:1.5px solid var(--light);border-radius:6px;color:var(--text);font-family:var(--font);font-size:13px;padding:8px 10px;width:100%;outline:none"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_age">Start Age</label><input type="number" id="scc-age" value="25"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_ret">Retire Age</label><input type="number" id="scc-ret" value="60"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_cc">Current Corpus (‚Çπ)</label><input type="number" id="scc-cc" value="50000"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_mc">Monthly Contrib (‚Çπ)</label><input type="number" id="scc-mc" value="8000"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_su">Step-up (%)</label><input type="number" id="scc-su" value="5"></div>
      <div class="if" style="margin-bottom:9px"><label data-t="l_ret_rate">Return Rate (%)</label><input type="number" id="scc-r" value="10"></div>
      <div class="if"><label data-t="l_inf">Inflation (%)</label><input type="number" id="scc-inf" value="6"></div>
    </div>
  </div>
  <div class="btn-row" style="margin-bottom:18px">
    <button type="button" class="btn" style="background:linear-gradient(135deg,var(--blue),#3B82F6)" onclick="calcM6()" data-t="btn_compare">Compare Scenarios ‚Üí</button>
    <button type="button" class="btn-s" onclick="resetM6()" data-t="btn_reset">Reset</button>
    <button type="button" class="btn-next" onclick="loadM6fromProfile()" title="Copy your User Profile into Scenario A">‚Üô Load Profile ‚Üí Scenario A</button>
  </div>
  <div id="m6-results" style="display:none">
    <div class="winner-chip" id="m6-winner"></div>
    <div class="rg" style="grid-template-columns:repeat(3,1fr)" id="m6-rg"></div>
    <div class="cw" style="margin-top:14px"><div class="cw-title"><span>üìà</span> <span data-t="ch6a_t">Corpus Growth ‚Äî All Three Scenarios</span></div><canvas id="chart-m6-growth" height="270"></canvas></div>
    <div class="two-col" style="margin-top:14px">
      <div class="cw" style="margin-top:0"><div class="cw-title"><span>üìä</span> <span data-t="ch6b_t">Key Metrics Comparison</span></div><canvas id="chart-m6-bar" height="210"></canvas></div>
      <div class="cw" style="margin-top:0"><div class="cw-title"><span>üå°Ô∏è</span> <span data-t="ch6c_t">Real Pension Value Over Time</span></div><canvas id="chart-m6-real" height="210"></canvas></div>
    </div>
    <div class="card" style="padding:0;overflow:hidden;margin-top:14px">
      <table style="width:100%;border-collapse:collapse">
        <thead><tr style="background:var(--bg2)">
          <th style="padding:11px 14px;font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:.8px;text-align:left;font-weight:700;border-bottom:1px solid var(--light)" data-t="tbl_metric">Metric</th>
          <th style="padding:11px 14px;font-size:11px;color:var(--blue);text-align:right;border-bottom:1px solid var(--light);font-weight:700" id="m6-h-a">A</th>
          <th style="padding:11px 14px;font-size:11px;color:var(--gold);text-align:right;border-bottom:1px solid var(--light);font-weight:700" id="m6-h-b">B</th>
          <th style="padding:11px 14px;font-size:11px;color:var(--green);text-align:right;border-bottom:1px solid var(--light);font-weight:700" id="m6-h-c">C</th>
        </tr></thead>
        <tbody id="m6-tbody"></tbody>
      </table>
    </div>
    <!-- Sequence of Returns Risk Panel -->
    <div id="m6-seq-panel" class="cw" style="margin-top:14px">
      <div class="cw-title"><span>‚ö†Ô∏è</span> Sequence-of-Returns Risk ‚Äî Scenario A (Same Avg Return, Early Bear Market)</div>
      <div style="font-size:11.5px;color:var(--muted);margin-bottom:10px;line-height:1.6">
        This shows <strong>why early retirement market returns matter most</strong>. Both lines assume the same long-run average return ‚Äî but the red line hits a bear market in years 1‚Äì5. The earlier bad returns accelerate corpus depletion significantly.
      </div>
      <canvas id="chart-m6-seq" height="220"></canvas>
    </div>
  </div>
</div><!-- /page-5 Module 6 -->

<!-- MODULE 7 ‚Äî NPS Fund Allocation Optimizer -->
<div class="page" id="page-6">
  <div class="sec-hd">
    <span class="sec-tag tag-teal" style="background:rgba(109,40,217,.10);color:var(--purple);border:1px solid rgba(109,40,217,.2)">Module 07 ¬∑ Fund &amp; Tax Optimisation</span>
    <h2 style="font-family:var(--serif);font-size:23px;color:var(--navy);margin-bottom:4px">NPS Fund Allocation Optimizer</h2>
    <p style="font-size:12.5px;color:var(--muted);max-width:620px;line-height:1.65">Compare Active Choice (you decide E/C/G split) vs Auto Choice (LC lifecycle funds). See projected corpus, tax savings under 80C+80CCD(1B), and the optimal strategy for your age.</p>
  </div>
  <div class="two-col">
    <div class="card" style="border-top:3px solid var(--purple)">
      <div class="card-title">üß¨ NPS Profile & Fund Choice</div>
      <div class="card-desc">Adjust E/C/G sliders for Active Choice ‚Äî they will auto-balance to 100%. All return assumptions are editable.</div>
      <div class="ig">
        <div class="if"><label>Current Age</label><input type="number" id="m7-age" value="32" min="18" max="70"></div>
        <div class="if"><label>Retirement Age</label><input type="number" id="m7-ret" value="60" min="30" max="85"></div>
        <div class="if"><label>Current NPS Corpus (‚Çπ)</label><input type="number" id="m7-cc" value="500000" step="10000"></div>
        <div class="if"><label>Monthly Contribution (‚Çπ)</label><input type="number" id="m7-mc" value="15000" step="500"></div>
        <div class="if"><label>Annual Step-up (%)</label><input type="number" id="m7-su" value="5" min="0" max="20"></div>
        <div class="if"><label>Annual Income (‚Çπ) ‚Äî for tax calc</label><input type="number" id="m7-income" value="1200000" step="50000"></div>
        <div class="if"><label>Tax Slab (%)</label>
          <select id="m7-slab" style="background:var(--bg2);border:1.5px solid var(--light);border-radius:var(--r-xs);color:var(--text);font-family:var(--mono);font-size:13px;padding:8px 11px;width:100%;outline:none">
            <option value="5">5%</option><option value="10">10%</option><option value="15">15%</option>
            <option value="20">20%</option><option value="30" selected>30%</option>
          </select>
        </div>
        <div class="if"><label title="EPF, LIC, ELSS, PPF, home loan principal etc. ‚Äî reduces NPS 80C room">Other 80C Investments/yr (‚Çπ)</label><input type="number" id="m7-other80c" value="100000" step="10000" placeholder="EPF+LIC+ELSS etc."></div>
      </div>
      <div class="divider"><span>Active Choice ‚Äî E / C / G Allocation</span></div>
      <div style="background:var(--bg2);border-radius:var(--r-sm);padding:14px;margin-bottom:14px">
        <div class="if" style="margin-bottom:10px">
          <label>Equity (E) ‚Äî Expected ~12% p.a.</label>
          <div class="sl-row"><input type="range" id="m7-e" min="0" max="75" value="50" step="5" oninput="m7SlChange('e')"><span class="sl-val" id="m7-e-v">50%</span></div>
        </div>
        <div class="if" style="margin-bottom:10px">
          <label>Corporate Bonds (C) ‚Äî Expected ~9% p.a.</label>
          <div class="sl-row"><input type="range" id="m7-c" min="0" max="100" value="30" step="5" oninput="m7SlChange('c')"><span class="sl-val" id="m7-c-v">30%</span></div>
        </div>
        <div class="if">
          <label>Government Securities (G) ‚Äî Expected ~7% p.a.</label>
          <div class="sl-row"><input type="range" id="m7-g" min="0" max="100" value="20" step="5" oninput="m7SlChange('g')"><span class="sl-val" id="m7-g-v">20%</span></div>
        </div>
        <div style="margin-top:10px;font-size:11px;color:var(--muted);display:flex;justify-content:space-between;align-items:center">
          <span>Active Blended Return: <strong id="m7-blend-rate" style="color:var(--teal)">‚Äî</strong></span>
          <span id="m7-total-badge" style="padding:2px 10px;border-radius:20px;font-size:10px;font-weight:700;background:#dcfce7;color:#15803D">Total: 100%</span>
        </div>
      </div>
      <div class="divider"><span>Auto Choice Returns (editable)</span></div>
      <div class="ig3" style="margin-bottom:14px">
        <div class="if"><label>LC-75 Aggr. (%)</label><input type="number" id="m7-lc75" value="12" step="0.5" min="1" max="20"></div>
        <div class="if"><label>LC-50 Mod. (%)</label><input type="number" id="m7-lc50" value="10" step="0.5" min="1" max="20"></div>
        <div class="if"><label>LC-25 Cons. (%)</label><input type="number" id="m7-lc25" value="8" step="0.5" min="1" max="20"></div>
      </div>
      <div class="btn-row">
        <button type="button" class="btn" style="background:linear-gradient(135deg,var(--purple),#8B5CF6)" onclick="calcM7()">Optimise ‚Üí</button>
        <button type="button" class="btn-s" onclick="resetM7()">Reset</button>
      </div>
    </div>
    <div id="m7-right-ph"><div class="placeholder"><div class="ph-icon">üß¨</div><p>Set your fund allocation and click <strong>Optimise</strong> to compare Active vs Auto Choice.</p></div></div>
  </div>

  <div id="m7-results" style="display:none">
    <div class="rg" id="m7-rg" style="grid-template-columns:repeat(auto-fill,minmax(175px,1fr))"></div>

    <!-- Tax benefit card -->
    <div class="card" style="border-top:3px solid var(--gold);margin-top:16px">
      <div class="card-title">üí∞ NPS Tax Benefit Calculator</div>
      <div class="card-desc">Section 80C allows up to ‚Çπ1.5L deduction (shared with EPF, LIC, ELSS etc.). Section 80CCD(1B) gives an <em>additional exclusive</em> deduction of up to ‚Çπ50K for NPS ‚Äî independent of 80C. Based on your <em>employee's own NPS contribution</em> only; employer's contribution under 80CCD(2) is separate and unlimited.</div>
      <div id="m7-tax-grid" class="rg" style="grid-template-columns:repeat(auto-fill,minmax(160px,1fr))"></div>
    </div>

    <!-- Strategy comparison table -->
    <div class="card" style="padding:0;overflow:hidden;margin-top:16px;border-top:3px solid var(--purple)">
      <div style="padding:14px 18px;background:var(--bg2);border-bottom:1px solid var(--light)">
        <div class="card-title" style="margin-bottom:0">üìä Active Choice vs Auto Choice ‚Äî Full Comparison</div>
      </div>
      <table style="width:100%;border-collapse:collapse" id="m7-table">
        <thead><tr style="background:var(--bg2)">
          <th style="padding:11px 14px;font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:.8px;text-align:left;font-weight:700;border-bottom:1px solid var(--light)">Strategy</th>
          <th style="padding:11px 14px;font-size:10px;color:var(--purple);text-align:right;border-bottom:1px solid var(--light);font-weight:700">Return</th>
          <th style="padding:11px 14px;font-size:10px;color:var(--teal);text-align:right;border-bottom:1px solid var(--light);font-weight:700">Corpus</th>
          <th style="padding:11px 14px;font-size:10px;color:var(--gold);text-align:right;border-bottom:1px solid var(--light);font-weight:700">Monthly Pension*</th>
          <th style="padding:11px 14px;font-size:10px;color:var(--green);text-align:right;border-bottom:1px solid var(--light);font-weight:700">Vs Best</th>
        </tr></thead>
        <tbody id="m7-tbody"></tbody>
      </table>
      <div style="padding:10px 18px;font-size:10px;color:var(--faint)">* Monthly pension = (corpus √ó 40% annuity allocation) √ó (annuity rate √∑ 12). Default: 40% allocation @ 6% p.a. Adjust in Module 1 for personalised values.</div>
    </div>

    <div class="cw" style="margin-top:14px">
      <div class="cw-title"><span>üìà</span> Corpus Growth ‚Äî Active Choice vs All Auto Lifecycle Funds</div>
      <canvas id="chart-m7-growth" height="270"></canvas>
    </div>
    <div class="two-col" style="margin-top:14px">
      <div class="cw" style="margin-top:0">
        <div class="cw-title"><span>ü•ß</span> Active Choice Asset Allocation</div>
        <canvas id="chart-m7-pie" height="240"></canvas>
      </div>
      <div class="cw" style="margin-top:0">
        <div class="cw-title"><span>üí∏</span> Cumulative Tax Savings Over Contribution Years</div>
        <canvas id="chart-m7-tax" height="240"></canvas>
      </div>
    </div>
    <div class="ib" style="background:rgba(109,40,217,.07);border:1px solid rgba(109,40,217,.2);color:var(--text);border-radius:var(--r-sm);padding:11px 15px;font-size:12px;line-height:1.7;margin-top:14px" id="m7-tip"></div>
  </div>
</div>

<!-- MODULE 8 ‚Äî Corpus Sustainability Simulator -->
<div class="page" id="page-7">
  <div class="sec-hd">
    <span class="sec-tag" style="background:rgba(220,38,38,.08);color:var(--coral);border:1px solid rgba(220,38,38,.2);font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:3px 10px;border-radius:20px;display:inline-block;margin-bottom:7px">Module 08 ¬∑ Drawdown Sustainability</span>
    <h2 style="font-family:var(--serif);font-size:23px;color:var(--navy);margin-bottom:4px">Corpus Sustainability Simulator</h2>
    <p style="font-size:12.5px;color:var(--muted);max-width:620px;line-height:1.65">The question every retiree asks: <em>"Will my money outlive me?"</em> See year-by-year how long your corpus lasts under real inflation ‚Äî and find the sustainable withdrawal amount that never runs out.</p>
  </div>
  <div class="two-col">
    <div class="card" style="border-top:3px solid var(--coral)">
      <div class="card-title">‚è≥ Retirement Drawdown Inputs</div>
      <div class="card-desc">Enter your total corpus at retirement. Use the <strong>Auto-fill</strong> button to pull the projected corpus from Module 1 or Module 3, or enter manually.</div>
      <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
        <button type="button" onclick="pullM8fromM1()" style="font-size:11px;font-weight:700;padding:6px 12px;border-radius:6px;border:1.5px solid var(--teal2);background:var(--teal-dim);color:var(--teal);cursor:pointer">‚Üô Pull from NPS Simulator (M1)</button>
        <button type="button" onclick="pullM8fromM3()" style="font-size:11px;font-weight:700;padding:6px 12px;border-radius:6px;border:1.5px solid var(--purple);background:var(--purple-dim);color:var(--purple);cursor:pointer">‚Üô Pull from Corpus Integrator (M3)</button>
      </div>
      <div class="ig">
        <div class="if"><label>Corpus at Retirement (‚Çπ)</label><input type="number" id="m8-corp" value="5000000" step="100000"></div>
        <div class="if"><label>Retirement Age</label><input type="number" id="m8-ret" value="60" min="40" max="80"></div>
        <div class="if"><label>Life Expectancy</label><input type="number" id="m8-le" value="90" min="60" max="105"></div>
        <div class="if"><label>Monthly Expenses Today (‚Çπ)</label><input type="number" id="m8-exp" value="50000" step="5000"></div>
        <div class="if"><label>Medical Expense / Month (‚Çπ)</label><input type="number" id="m8-med" value="10000" step="1000"></div>
        <div class="if"><label>General Inflation (% p.a.)</label><input type="number" id="m8-inf" value="6" step="0.5" min="1" max="15"></div>
        <div class="if"><label>Medical Inflation (% p.a.) <span style="font-size:9px;color:var(--coral)">India avg ~12‚Äì15%</span></label><input type="number" id="m8-minf" value="12" step="0.5" min="1" max="20"></div>
        <div class="if"><label>Post-Retirement Return (% p.a.)</label><input type="number" id="m8-ret-r" value="7" step="0.5" min="0" max="15"></div>
        <div class="if"><label>Annual Non-NPS Pension / Income (‚Çπ)<span style="font-size:9.5px;font-weight:400;color:var(--faint);display:block;margin-top:1px">Treated as fixed nominal ‚Äî add your own inflation if needed</span></label><input type="number" id="m8-other" value="0" step="10000"></div>
      </div>
      <div class="divider"><span>Bucket Strategy (Optional)</span></div>
      <div style="background:var(--bg2);border-radius:var(--r-sm);padding:13px;margin-bottom:14px;font-size:12px;color:var(--muted);line-height:1.7">
        <strong style="color:var(--navy)">3-Bucket Allocation of Corpus:</strong><br>
        Bucket 1 (Liquid, 0‚Äì5 yrs): <strong id="m8-b1" style="color:var(--blue)">‚Äî</strong> &nbsp;|&nbsp;
        Bucket 2 (Balanced, 5‚Äì15 yrs): <strong id="m8-b2" style="color:var(--gold)">‚Äî</strong> &nbsp;|&nbsp;
        Bucket 3 (Growth, 15+ yrs): <strong id="m8-b3" style="color:var(--green)">‚Äî</strong>
      </div>
      <div class="btn-row">
        <button type="button" class="btn" style="background:linear-gradient(135deg,var(--coral),#F97316)" onclick="calcM8()">Simulate ‚Üí</button>
        <button type="button" class="btn-s" onclick="resetM8()">Reset</button>
      </div>
    </div>
    <div id="m8-right-ph"><div class="placeholder"><div class="ph-icon">‚è≥</div><p>Enter corpus details and click <strong>Simulate</strong> to see your retirement runway.</p></div></div>
  </div>

  <div id="m8-results" style="display:none">
    <!-- Key result banner -->
    <div id="m8-banner" style="border-radius:var(--r-sm);padding:18px 22px;margin-bottom:16px;text-align:center;font-size:15px;font-weight:700;line-height:1.8"></div>
    <div class="rg" id="m8-rg" style="grid-template-columns:repeat(auto-fill,minmax(175px,1fr))"></div>

    <div class="cw" style="margin-top:14px">
      <div class="cw-title"><span>üìâ</span> Corpus Drawdown ‚Äî Year by Year (with Medical Inflation Overlay)</div>
      <canvas id="chart-m8-draw" height="290"></canvas>
    </div>
    <div class="two-col" style="margin-top:14px">
      <div class="cw" style="margin-top:0">
        <div class="cw-title"><span>üìä</span> Annual Expense Breakdown (General vs Medical)</div>
        <canvas id="chart-m8-exp" height="240"></canvas>
      </div>
      <div class="cw" style="margin-top:0">
        <div class="cw-title"><span>ü™£</span> 3-Bucket Strategy ‚Äî Corpus Allocation</div>
        <canvas id="chart-m8-bucket" height="240"></canvas>
      </div>
    </div>

    <!-- Sustainability table -->
    <div class="card" style="padding:0;overflow:hidden;margin-top:16px">
      <div style="padding:12px 18px;background:var(--bg2);border-bottom:1px solid var(--light)">
        <div class="card-title" style="margin-bottom:0">üìã Year-by-Year Retirement Runway</div>
      </div>
      <div style="max-height:340px;overflow-y:auto">
        <table style="width:100%;border-collapse:collapse">
          <thead style="position:sticky;top:0;z-index:2"><tr style="background:var(--bg2)">
            <th style="padding:9px 12px;font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:.8px;text-align:left;font-weight:700;border-bottom:1px solid var(--light)">Age</th>
            <th style="padding:9px 12px;font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:.8px;text-align:right;font-weight:700;border-bottom:1px solid var(--light)">Corpus (Start)</th>
            <th style="padding:9px 12px;font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:.8px;text-align:right;font-weight:700;border-bottom:1px solid var(--light)">Annual Expense</th>
            <th style="padding:9px 12px;font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:.8px;text-align:right;font-weight:700;border-bottom:1px solid var(--light)">Other Income</th>
            <th style="padding:9px 12px;font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:.8px;text-align:right;font-weight:700;border-bottom:1px solid var(--light)">Corpus (End)</th>
            <th style="padding:9px 12px;font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:.8px;text-align:right;font-weight:700;border-bottom:1px solid var(--light)">Status</th>
          </tr></thead>
          <tbody id="m8-tbody"></tbody>
        </table>
      </div>
    </div>
    <div class="ib" id="m8-advice" style="background:rgba(220,38,38,.06);border:1px solid rgba(220,38,38,.15);color:var(--text);border-radius:var(--r-sm);padding:11px 15px;font-size:12px;line-height:1.7;margin-top:14px"></div>
  </div>
</div>

<!-- MODULE 9 ‚Äî Pre-Retirement Health Check + 35X Rule -->
<div class="page" id="page-8">
  <div class="sec-hd">
    <span class="sec-tag" style="background:rgba(29,78,216,.08);color:var(--blue);border:1px solid rgba(29,78,216,.2);font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:3px 10px;border-radius:20px;display:inline-block;margin-bottom:7px">Module 09 ¬∑ Pre-Retirement Health Check</span>
    <h2 style="font-family:var(--serif);font-size:23px;color:var(--navy);margin-bottom:4px">Pre-Retirement Health Check &amp; 35X Rule</h2>
    <p style="font-size:12.5px;color:var(--muted);max-width:620px;line-height:1.65">Before growing your wealth, protect it. Check your financial safety net ‚Äî emergency fund, term insurance, health cover ‚Äî and see exactly how much corpus you need using the 35X rule with a retirement age sensitivity table.</p>
  </div>
  <div class="two-col">
    <div class="card" style="border-top:3px solid var(--blue)">
      <div class="card-title">üè• Financial Safety Net Inputs</div>
      <div class="card-desc">Enter your current financial situation. The health check uses industry thumb-rules and flags gaps instantly.</div>
      <div class="ig">
        <div class="if"><label>Current Age</label><input type="number" id="m9-age" value="32" min="18" max="70"></div>
        <div class="if"><label>Planned Retirement Age</label><input type="number" id="m9-ret" value="60" min="30" max="80"></div>
        <div class="if"><label>Monthly Take-Home Income (‚Çπ)</label><input type="number" id="m9-income" value="80000" step="5000"></div>
        <div class="if"><label>Monthly Expenses (‚Çπ)</label><input type="number" id="m9-exp" value="50000" step="5000"></div>
        <div class="if"><label>Current Emergency Fund (‚Çπ)</label><input type="number" id="m9-ef" value="200000" step="10000"></div>
        <div class="if"><label>Term Insurance Cover (‚Çπ)</label><input type="number" id="m9-term" value="5000000" step="500000"></div>
        <div class="if"><label>Health Insurance Cover (‚Çπ total sum insured)</label><input type="number" id="m9-health" value="500000" step="100000"></div>
        <div class="if"><label>Current NPS + All Savings (‚Çπ)</label><input type="number" id="m9-savings" value="500000" step="50000"></div>
        <div class="if"><label>Expected Return on Savings (%)</label><input type="number" id="m9-rr" value="10" step="0.5"></div>
        <div class="if"><label>Annual Step-up on Savings (%)</label><input type="number" id="m9-su" value="5" step="1" min="0" max="25"><span class="hint">Annual % increase in monthly saving ‚Äî synced from User Profile</span></div>
        <div class="if"><label>Inflation Rate (% p.a.)</label><input type="number" id="m9-inf" value="6" step="0.5"></div>
      </div>
      <div class="btn-row">
        <button type="button" class="btn" style="background:linear-gradient(135deg,var(--blue),#3B82F6)" onclick="calcM9()">Run Health Check ‚Üí</button>
        <button type="button" class="btn-s" onclick="resetM9()">Reset</button>
      </div>
    </div>
    <div id="m9-right-ph"><div class="placeholder"><div class="ph-icon">üè•</div><p>Enter your financial details and click <strong>Run Health Check</strong> to see your readiness score.</p></div></div>
  </div>

  <div id="m9-results" style="display:none">
    <!-- Traffic light checks -->
    <div class="card" style="border-top:3px solid var(--blue)">
      <div class="card-title">üö¶ Financial Safety Net ‚Äî Traffic Light Check</div>
      <div id="m9-early-exit-note" style="display:none;font-size:11.5px;line-height:1.7;padding:10px 14px;margin-bottom:12px;background:#FEF3C7;border:1px solid #FCD34D;border-radius:8px;border-left:4px solid #D97706;color:#92400E"></div>
      <div id="m9-checks"></div>
    </div>

    <!-- 35X Rule -->
    <div class="card" style="margin-top:0;border-top:3px solid var(--gold)">
      <div class="card-title">üéØ 35X Corpus Rule ‚Äî Your Target Number</div>
      <div class="card-desc">Industry consensus: you need at least 35√ó your annual retirement expenses for a comfortable retirement. This ensures a safe ~3% withdrawal rate, well within the safety zone.</div>
      <div class="rg" id="m9-35x" style="grid-template-columns:repeat(auto-fill,minmax(175px,1fr))"></div>
      <div id="m9-35x-bar" style="margin-top:14px"></div>
    </div>

    <!-- Retirement Age Sensitivity Table -->
    <div class="card" style="padding:0;overflow:hidden;margin-top:0;border-top:3px solid var(--purple)">
      <div style="padding:14px 18px;background:var(--bg2);border-bottom:1px solid var(--light)">
        <div class="card-title" style="margin-bottom:2px">üìÖ Retirement Age Sensitivity Table</div>
        <div style="font-size:12px;color:var(--muted)">Monthly savings required to achieve 35√ó of your inflation-adjusted annual expenses at each retirement age.</div>
      </div>
      <table style="width:100%;border-collapse:collapse">
        <thead><tr style="background:var(--bg2)">
          <th style="padding:11px 14px;font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:.8px;text-align:left;font-weight:700;border-bottom:1px solid var(--light)">Retire At</th>
          <th style="padding:11px 14px;font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:.8px;text-align:right;font-weight:700;border-bottom:1px solid var(--light)">Years Left</th>
          <th style="padding:11px 14px;font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:.8px;text-align:right;font-weight:700;border-bottom:1px solid var(--light)">Corpus Required (35X)</th>
          <th style="padding:11px 14px;font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:.8px;text-align:right;font-weight:700;border-bottom:1px solid var(--light)">Monthly Saving Needed</th>
          <th style="padding:11px 14px;font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:.8px;text-align:right;font-weight:700;border-bottom:1px solid var(--light)">% of Income</th>
          <th style="padding:11px 14px;font-size:9.5px;color:var(--faint);text-transform:uppercase;letter-spacing:.8px;text-align:right;font-weight:700;border-bottom:1px solid var(--light)">Feasibility</th>
        </tr></thead>
        <tbody id="m9-tbody"></tbody>
      </table>
    </div>

    <div class="two-col" style="margin-top:16px">
      <div class="cw" style="margin-top:0">
        <div class="cw-title"><span>üìä</span> Required Monthly Savings by Retirement Age</div>
        <canvas id="chart-m9-sens" height="240"></canvas>
      </div>
      <div class="cw" style="margin-top:0">
        <div class="cw-title"><span>üçï</span> Income Allocation Health</div>
        <canvas id="chart-m9-alloc" height="240"></canvas>
      </div>
    </div>
    <div class="ib" id="m9-advice" style="background:rgba(29,78,216,.07);border:1px solid rgba(29,78,216,.2);color:var(--text);border-radius:var(--r-sm);padding:11px 15px;font-size:12px;line-height:1.7;margin-top:0"></div>
  </div>
</div>

</div><!-- /main -->

<footer style="background:var(--navy);color:rgba(255,255,255,.55);padding:20px 32px 16px;font-size:11px;font-family:var(--font);border-top:3px solid var(--pfrda-saffron)">
  <div style="max-width:1100px;margin:0 auto">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px;margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid rgba(255,255,255,.08)">
      <div>
        <div style="font-family:'Playfair Display',serif;font-size:16px;font-weight:900;background:linear-gradient(135deg,#FFD700,#FF8C00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:4px">Retirometer V</div>
        <div style="color:rgba(255,255,255,.4);font-size:10px;line-height:1.6">Built by <strong style="color:rgba(255,255,255,.7)">Vishweshwar Mensumane</strong> &nbsp;¬∑&nbsp; <span style="color:var(--rv-accent);font-weight:700">Money Vichara</span></div>
        <div style="margin-top:8px"><span style="background:var(--pfrda-saffron);color:#fff;font-weight:800;font-size:9.5px;letter-spacing:.5px;padding:2px 9px;border-radius:20px">PFRDA HACKATHON 2026</span></div>
      </div>
      <div style="display:flex;gap:28px;flex-wrap:wrap">
        <div>
          <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.3);margin-bottom:7px">Quick Flow</div>
          <div style="font-size:10px;color:rgba(255,255,255,.45);line-height:1.9">
            <div>‚ë† Fill <strong style="color:rgba(255,255,255,.65)">User Profile</strong> at top</div>
            <div>‚ë° Run <strong style="color:rgba(255,255,255,.65)">NPS Simulator</strong> (M1)</div>
            <div>‚ë¢ Check <strong style="color:rgba(255,255,255,.65)">Goal Finder</strong> (M2)</div>
            <div>‚ë£ Add all assets in <strong style="color:rgba(255,255,255,.65)">Corpus Integrator</strong> (M3)</div>
            <div>‚ë§ Stress-test in <strong style="color:rgba(255,255,255,.65)">Risk Dashboard</strong> (M5)</div>
          </div>
        </div>
        <div>
          <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:rgba(255,255,255,.3);margin-bottom:7px">Key Metrics</div>
          <div style="font-size:10px;color:rgba(255,255,255,.45);line-height:1.9">
            <div><strong style="color:rgba(255,255,255,.65)">PSI</strong> ‚Äî Pension Stability Index</div>
            <div><strong style="color:rgba(255,255,255,.65)">RSR</strong> ‚Äî Retirement Security Ratio</div>
            <div><strong style="color:rgba(255,255,255,.65)">SWR</strong> ‚Äî Safe Withdrawal Rate</div>
            <div><strong style="color:rgba(255,255,255,.65)">WCR</strong> ‚Äî Wealth Coverage Ratio</div>
            <div><strong style="color:rgba(255,255,255,.65)">LCS</strong> ‚Äî Longevity Coverage Score</div>
          </div>
        </div>
      </div>
    </div>
    <div style="color:rgba(255,255,255,.25);font-size:9.5px;line-height:1.7">
      üìã <strong style="color:rgba(255,255,255,.35)">Disclaimer:</strong> For educational &amp; planning use only. Not investment advice. All projections assume constant returns ‚Äî actual market returns vary. NPS annuity rates are illustrative; verify with your provider. NPS withdrawal: 60% lump sum tax-free, annuity taxed at income slab. Equity LTCG &gt;‚Çπ1.25L taxed @12.5%. PFRDA rules subject to change ‚Äî confirm with your PoP/NPS intermediary before investing.
    </div>
  </div>
</footer>

<script>

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRANSLATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const T = {
en:{
  badge:'Pension Intelligence Suite',hero_sub:'India\'s most comprehensive NPS retirement planner. Nine intelligent modules ‚Äî project corpus, find your goal, stress-test income, and retire with confidence.',
  hero_disc:'Uses universal financial principles. PFRDA regulatory minimums (40% annuity, age 65 entry limit) are enforced. Verify current rules with your NPS intermediary.',
  pill1:'üìà NPS Simulator',pill2:'üéØ Goal Finder',pill3:'üß© Holistic Planner',pill4:'üè¶ Annuity Optimizer',pill5:'‚ö° Risk Dashboard',pill6:'üîÄ Scenario Lab',pill7:'üß¨ Fund Optimizer',pill8:'‚è≥ Sustainability',pill9:'üè• Health Check',
  tab1:'NPS Simulator',tab2:'Goal Finder',tab3:'Corpus Integrator',tab4:'Annuity Optimizer',tab5:'Risk Dashboard',tab6:'Scenario Lab',tab7:'Fund Optimizer',tab8:'Sustainability',tab9:'Health Check',
  // ld1-ld4 translation keys removed (live strip removed)
  m1tag:'Module 01',m1h:'NPS Growth Simulator',m1p:'Project your NPS corpus under three market scenarios. See the real power of compounding.',
  m1ct1:'üìä Your NPS Profile',m1cd1:'Enter your details. Annuity % is editable from 40‚Äì100% ‚Äî PFRDA mandates minimum 40% annuity purchase at NPS exit.',
  m2h:'Goal Finder ‚Äî Reverse Calculator',m2p:'Set your desired monthly pension. We reverse-engineer corpus and contribution ‚Äî and show cost of delay.',
  m2ct:'üéØ Your Pension Goal',m2cd:'Enter target monthly income in today\'s rupees. We inflate to retirement date automatically.',
  m3h:'Holistic Corpus Integrator',m3p:'Complete retirement picture across all savings. Calculate your true Pension Stability Index.',
  m3ct:'üß© All Retirement Assets',m3cd:'Enter balance, monthly contribution, and expected return for each asset.',
  m4h:'Annuity Optimizer',m4p:'Compare four pension structuring strategies. See income at Year 1, 10, 20 and corpus depletion.',
  m4ct:'üè¶ Retirement Corpus Details',m4cd:'All allocation percentages are fully editable. No mandatory rules locked in.',
  m5h:'Retirement Risk Dashboard',m5p:'Three proprietary scores ‚Äî PSI, RSR, LCS ‚Äî plus full Retirometer Gauge and market shock analysis.',
  m5ct:'‚ö° Risk Assessment Inputs',m5cd:'Auto-populated from Module 3. Edit any field independently.',
  m6h:'Scenario Lab',m6p:'Create three custom scenarios and compare side by side.',
  gauge_title:'RETIROMETER ‚Äî RETIREMENT RISK GAUGE',
  psi_gauge_title:'PENSION STABILITY INDEX (PSI) ‚Äî RETIROMETER GAUGE',
  gauge_title_full:'RETIROMETER ‚Äî PENSION STABILITY INDEX GAUGE',
  g1:'Comfortable',g2:'Secure',g3:'Stable',g4:'Mod Risk',g5:'At Risk',g6:'Critical',
  swr_lbl:'First-Year Withdrawal Rate (SWR)',wcr_lbl:'Withdrawal Coverage Ratio (WCR)',
  psi_name:'Pension Stability Index',rsr_name:'Retirement Sufficiency Ratio',swr_name:'Safe Withdrawal Rate',
  psi_lbl:'Pension Stability Index',rsr_lbl:'Retirement Sufficiency Ratio',lcs_lbl:'Longevity Coverage Score',
  psi_desc:'Guaranteed Income √∑ Total Expenses. Measures guaranteed coverage of your expenses.',
  rsr_desc:'Total Annual Income √∑ Required Expenses. Overall retirement income adequacy.',
  lcs_desc:'Years corpus stays positive under stress (return ‚àí3%, inflation +2%).',
  arc_lbl:'Current Plan Adequacy',div_corpus_split:'Corpus Split at Retirement',
  div_params:'Planning Parameters',div_ann_type:'Annuity Type',div_custom_split:'Custom Balanced Split',
  col_asset:'Asset',col_balance:'Balance (‚Çπ) + Monthly Contribution (‚Çπ)',col_return:'Return %',
  src_nps:'NPS',src_nps_t:'Market-linked',src_epf:'EPF / Gratuity',src_epf_t:'Guaranteed',
  src_ppf:'PPF',src_ppf_t:'Guaranteed',src_mf:'Mutual Funds / Stocks',src_mf_t:'Market-linked',
  src_prop:'Property (Investable)',src_prop_t:'Market-linked',src_fd:'FD / Bonds',src_fd_t:'Guaranteed',
  src_oth:'Other Savings',src_oth_t:'Mixed',
  at_life:'Life Annuity',at_joint:'Joint Life',at_rop:'Return of Purchase',at_inc:'Increasing 3% p.a.',
  l_age:'Current Age',l_ret:'Retirement Age',l_cc:'Current NPS Corpus (‚Çπ)',l_mc:'Monthly Contribution (‚Çπ)',
  l_mc_cur:'Current Monthly Contribution (‚Çπ)',l_su:'Annual Step-up (%)',l_inf:'Inflation Rate (% p.a.)',
  l_fund:'Fund / Asset Mix',l_cr:'Custom Return (% p.a.)',l_apct:'Annuity Allocation %',l_ar:'Annuity Rate (% p.a.)',
  l_dp:'Desired Monthly Pension (‚Çπ today)',l_le:'Life Expectancy',l_exp:'Current Monthly Expenses (‚Çπ, today\'s value ‚Äî auto-inflated to retirement date)',
  l_corpus:'Retirement Corpus (‚Çπ)',l_lr:'Lump Sum Return (% p.a.)',l_gi:'Guaranteed Annual Income (‚Çπ)',
  l_ti:'Total Annual Income (‚Çπ)',l_pr:'Post-Retirement Return (%)',l_ret_age:'Retirement Age',
  l_rr:'Expected Return (%)',l_name:'Name',l_ret_rate:'Return Rate (%)',
  h_apct:'Your chosen allocation to guaranteed pension',h_ar:'Check current rates with your annuity provider',
  h_gi:'Annuity (truly guaranteed) + EPF pension + FD/PPF interest (drawn from corpus ‚Äî depletable)',h_ti:'All sources combined',
  f75:'LC-75 Aggressive (~12%)',f50:'LC-50 Moderate (~10%)',f25:'LC-25 Conservative (~8%)',fcustom:'Custom Return',
  sc_cons:'Conservative',sc_mod:'Moderate ‚òÖ',sc_agg:'Optimistic',sc_best:'BASE',
  sc_a:'Scenario A',sc_b:'Scenario B',sc_c:'Scenario C',
  btn_calc:'Calculate ‚Üí',btn_reset:'Reset',btn_next:'Use in Goal Finder ‚Üí',
  btn_compare:'Compare Scenarios ‚Üí',btn_push_m5:'Push to Risk Dashboard ‚Üí',
  ph1:'Enter your details and click Calculate to see your retirement projection.',
  ph2:'Set your desired pension and click Find My Goal.',ph4:'Enter corpus details and click Compare Strategies.',
  ch1_t:'Corpus Growth ‚Äî Three Scenarios with Uncertainty Band',ch1b_t:'Contributions vs Investment Returns',ch1c_t:'Retirement Journey Milestones',
  ch2a_t:'Pension Adequacy',ch2b_t:'Cost of Delay',ch2c_t:'Monthly Pension vs Contribution Change',ch2d_t:'Monthly Pension vs Retirement Age',
  ch3a_t:'Asset Allocation',ch3b_t:'Guaranteed vs Market-Linked Income',
  ch4a_t:'Monthly Income ‚Äî Year 1, Year 10, Year 20 by Strategy',ch4b_t:'Corpus Depletion Over Time',ch4c_t:'Inflation Erosion of Fixed Annuity Income',
  ch5a_t:'6-Dimension Retirement Health Radar',ch5b_t:'Market Shock Test ‚Äî Base vs ‚àí40% Crash in Year 1',ch5c_t:'Inflation Erosion ‚Äî Real Value of ‚Çπ1 Lakh Fixed Annual Income',
  ch6a_t:'Corpus Growth ‚Äî All Three Scenarios',ch6b_t:'Key Metrics Comparison',ch6c_t:'Real Pension Value Over Time',
  shock_base:'üìä Base Scenario',shock_shocked:'üí• After Market Shock (‚àí40% Year 1)',shock_at80:'Corpus at Age 80',shock_at85:'Corpus at Age 85',
  m1_note_h:'Note:',m1_note:'Three scenarios model Conservative/Moderate/Aggressive fund performance. The shaded band shows the full range between these scenarios ‚Äî it is not a statistical confidence interval.',
  tbl_metric:'Metric',
  verdict_comfortable:'‚úÖ Comfortable ‚Äî Strong retirement security. Investment returns comfortably exceed expenses.',
  verdict_secure:'‚úÖ Secure ‚Äî Very healthy outlook. Small variations will not derail your plan.',
  verdict_stable:'üü° Stable ‚Äî Standard planning target achieved. Review every 2‚Äì3 years.',
  verdict_modrisk:'‚ö†Ô∏è Moderate Risk ‚Äî Consider increasing monthly contribution by 10‚Äì15%.',
  verdict_atrisk:'üî¥ At Risk ‚Äî Action recommended. Increase contributions and review allocation.',
  verdict_critical:'üö® Critical ‚Äî Comprehensive retirement restructuring needed urgently.',
  psi_stable:'Very Stable',psi_good:'Stable Zone',psi_mod:'Moderate Risk',psi_high:'High Volatility Risk',
  rsr_surplus:'Income Surplus',rsr_suff:'Sufficient',rsr_part:'Partial Coverage',rsr_gap:'Significant Gap',rsr_crit:'Critical Gap',
  lcs_strong:'Strong Coverage',lcs_good:'Good Coverage',lcs_mod:'Moderate',lcs_short:'Short Coverage',
  winner_prefix:'üèÜ Best Overall:',at_life:'Life Annuity',at_joint:'Joint Life',at_rop:'Return of Purchase',at_inc:'Increasing 3% p.a.',btn_reset:'Reset',btn_next:'Use in Goal Finder ‚Üí',btn_push_m4:'Push to Annuity Optimizer ‚Üí',btn_push_m5:'Push to Risk Dashboard ‚Üí',ch1b_t:'Contributions vs Investment Returns',ch1c_t:'Retirement Journey Milestones',ch2b_t:'Cost of Delay',ch2c_t:'Monthly Pension vs Contribution Change',ch2d_t:'Monthly Pension vs Retirement Age',ch3b_t:'Guaranteed vs Market-Linked Income',ch4b_t:'Corpus Depletion Over Time',ch4c_t:'Inflation Erosion of Fixed Annuity Income',ch5b_t:'Market Shock Test ‚Äî Base vs ‚àí40% Crash',ch5c_t:'Inflation Erosion ‚Äî Real Value of ‚Çπ1 Lakh',ch6b_t:'Key Metrics Comparison',ch6c_t:'Real Pension Value Over Time',col_balance:'Balance + Monthly (‚Çπ)',col_return:'Return %',ann_y1:'Year 1 Monthly',ann_y10:'Year 10 Monthly',ann_y20:'Year 20 Monthly',
  radar_labels:['Income','Longevity','Inflation Shield','Seq. Risk','Liquidity','Diversification'],
},
hi:{
  badge:'‡§™‡•á‡§Ç‡§∂‡§® ‡§á‡§Ç‡§ü‡•á‡§≤‡§ø‡§ú‡•á‡§Ç‡§∏ ‡§∏‡•Ç‡§ü',hero_sub:'‡§õ‡§π ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§Æ‡•â‡§°‡•ç‡§Ø‡•Ç‡§≤ ‚Äî NPS ‡§™‡•ç‡§∞‡•ã‡§ú‡•á‡§ï‡•ç‡§∂‡§® ‡§∏‡•á ‡§™‡•á‡§Ç‡§∂‡§® ‡§∏‡•ç‡§•‡§ø‡§∞‡§§‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§§‡§ï‡•§',
  hero_disc:'‡§∏‡§æ‡§∞‡•ç‡§µ‡§≠‡•å‡§Æ‡§ø‡§ï ‡§µ‡§ø‡§§‡•ç‡§§‡•Ä‡§Ø ‡§∏‡§ø‡§¶‡•ç‡§ß‡§æ‡§Ç‡§§‡•ã‡§Ç ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó‡•§ ‡§ï‡•ã‡§à ‡§®‡§ø‡§Ø‡§æ‡§Æ‡§ï ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§π‡§æ‡§∞‡•ç‡§°‡§ï‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç‡•§',
  pill1:'üìà NPS ‡§∏‡§ø‡§Æ‡•Å‡§≤‡•á‡§ü‡§∞',pill2:'üéØ ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§ñ‡•ã‡§ú‡§ï',pill3:'üß© ‡§∏‡§Æ‡§ó‡•ç‡§∞ ‡§™‡•ç‡§≤‡§æ‡§®‡§∞',pill4:'üè¶ ‡§è‡§®‡•ç‡§Ø‡•Å‡§ü‡•Ä ‡§ë‡§™‡•ç‡§ü‡§ø‡§Æ‡§æ‡§á‡§ú‡§º‡§∞',pill5:'‚ö° ‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°',pill6:'üîÄ ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø ‡§≤‡•à‡§¨',
  tab1:'NPS ‡§∏‡§ø‡§Æ‡•Å‡§≤‡•á‡§ü‡§∞',tab2:'‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§ñ‡•ã‡§ú‡§ï',tab3:'‡§ï‡•â‡§∞‡•ç‡§™‡§∏ ‡§á‡§Ç‡§ü‡•Ä‡§ó‡•ç‡§∞‡•á‡§ü‡§∞',tab4:'‡§è‡§®‡•ç‡§Ø‡•Å‡§ü‡•Ä ‡§ë‡§™‡•ç‡§ü‡§ø‡§Æ‡§æ‡§á‡§ú‡§º‡§∞',tab5:'‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°',tab6:'‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø ‡§≤‡•à‡§¨',
  // ld1-ld4 Hindi keys removed
  pill7:'üß¨ ‡§´‡§Ç‡§° ‡§ë‡§™‡•ç‡§ü‡§ø‡§Æ‡§æ‡§á‡§ú‡§º‡§∞',pill8:'‚è≥ ‡§∏‡§∏‡•ç‡§ü‡•á‡§®‡•á‡§¨‡§ø‡§≤‡§ø‡§ü‡•Ä',pill9:'üè• ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§ú‡§æ‡§Ç‡§ö',
  tab7:'‡§´‡§Ç‡§° ‡§ë‡§™‡•ç‡§ü‡§ø‡§Æ‡§æ‡§á‡§ú‡§º‡§∞',tab8:'‡§∏‡§∏‡•ç‡§ü‡•á‡§®‡•á‡§¨‡§ø‡§≤‡§ø‡§ü‡•Ä',tab9:'‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§ú‡§æ‡§Ç‡§ö',
  Note:'‡§®‡•ã‡§ü',Overall:'‡§ï‡•Å‡§≤',
  m1tag:'‡§Æ‡•â‡§°‡•ç‡§Ø‡•Ç‡§≤ 01',m1h:'NPS ‡§µ‡•É‡§¶‡•ç‡§ß‡§ø ‡§∏‡§ø‡§Æ‡•Å‡§≤‡•á‡§ü‡§∞',m1p:'‡§§‡•Ä‡§® ‡§¨‡§æ‡§ú‡§º‡§æ‡§∞ ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§Ö‡§™‡§®‡•á NPS ‡§ï‡•â‡§∞‡•ç‡§™‡§∏ ‡§ï‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§® ‡§≤‡§ó‡§æ‡§è‡§Ç‡•§',
  m1ct1:'üìä ‡§Ü‡§™‡§ï‡•Ä NPS ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤',m1cd1:'‡§Ö‡§™‡§®‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§è‡§®‡•ç‡§Ø‡•Å‡§ü‡•Ä % ‡§î‡§∞ ‡§¶‡§∞ ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§∏‡•á ‡§∏‡§Ç‡§™‡§æ‡§¶‡§® ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§π‡•à‡§Ç‡•§',
  m2h:'‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§ñ‡•ã‡§ú‡§ï ‚Äî ‡§∞‡§ø‡§µ‡§∞‡•ç‡§∏ ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞',m2p:'‡§µ‡§æ‡§Ç‡§õ‡§ø‡§§ ‡§™‡•á‡§Ç‡§∂‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§π‡§Æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ï‡•â‡§∞‡•ç‡§™‡§∏ ‡§î‡§∞ ‡§Ø‡•ã‡§ó‡§¶‡§æ‡§® ‡§ï‡•Ä ‡§ó‡§£‡§®‡§æ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç‡•§',
  m2ct:'üéØ ‡§Ü‡§™‡§ï‡§æ ‡§™‡•á‡§Ç‡§∂‡§® ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø',m2cd:'‡§Ü‡§ú ‡§ï‡•á ‡§∞‡•Å‡§™‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§≤‡§ï‡•ç‡§∑‡§ø‡§§ ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§Ü‡§Ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§',
  m3h:'‡§∏‡§Æ‡§ó‡•ç‡§∞ ‡§ï‡•â‡§∞‡•ç‡§™‡§∏ ‡§á‡§Ç‡§ü‡•Ä‡§ó‡•ç‡§∞‡•á‡§ü‡§∞',m3p:'‡§∏‡§≠‡•Ä ‡§¨‡§ö‡§§ ‡§∏‡§æ‡§ß‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞‡•§',
  m3ct:'üß© ‡§∏‡§≠‡•Ä ‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡§æ‡§Ç',m3cd:'‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∂‡•á‡§∑, ‡§Ø‡•ã‡§ó‡§¶‡§æ‡§® ‡§î‡§∞ ‡§Ö‡§™‡•á‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡§ø‡§ü‡§∞‡•ç‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§',
  m4h:'‡§è‡§®‡•ç‡§Ø‡•Å‡§ü‡•Ä ‡§ë‡§™‡•ç‡§ü‡§ø‡§Æ‡§æ‡§á‡§ú‡§º‡§∞',m4p:'‡§ö‡§æ‡§∞ ‡§™‡•á‡§Ç‡§∂‡§® ‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ ‡§∞‡§£‡§®‡•Ä‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•Ä ‡§§‡•Å‡§≤‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§',
  m4ct:'üè¶ ‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§ï‡•â‡§∞‡•ç‡§™‡§∏ ‡§µ‡§ø‡§µ‡§∞‡§£',m4cd:'‡§∏‡§≠‡•Ä ‡§Ü‡§µ‡§Ç‡§ü‡§® ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§ ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§∏‡•á ‡§∏‡§Ç‡§™‡§æ‡§¶‡§® ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§π‡•à‡§Ç‡•§',
  m5h:'‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°',m5p:'‡§§‡•Ä‡§® ‡§Æ‡§æ‡§≤‡§ø‡§ï‡§æ‡§®‡§æ ‡§∏‡•ç‡§ï‡•ã‡§∞ ‡§î‡§∞ ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∞‡§ø‡§ü‡§æ‡§Ø‡§∞‡§Æ‡•Ä‡§ü‡§∞ ‡§∞‡§ø‡§∏‡•ç‡§ï ‡§ó‡•á‡§ú‡•§',
  m5ct:'‚ö° ‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§æ‡§Ç‡§ï‡§® ‡§á‡§®‡§™‡•Å‡§ü',m5cd:'‡§Æ‡•â‡§°‡•ç‡§Ø‡•Ç‡§≤ 3 ‡§∏‡•á ‡§∏‡•ç‡§µ‡§§‡§É ‡§≠‡§∞‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§ ‡§ï‡§ø‡§∏‡•Ä ‡§≠‡•Ä ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§ï‡•ã ‡§∏‡•ç‡§µ‡§§‡§Ç‡§§‡•ç‡§∞ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç‡•§',
  m6h:'‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø ‡§≤‡•à‡§¨',m6p:'‡§§‡•Ä‡§® ‡§ï‡§∏‡•ç‡§ü‡§Æ ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø ‡§¨‡§®‡§æ‡§è‡§Ç ‡§î‡§∞ ‡§∏‡§æ‡§•-‡§∏‡§æ‡§• ‡§§‡•Å‡§≤‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§',
  gauge_title:'‡§∞‡§ø‡§ü‡§æ‡§Ø‡§∞‡§Æ‡•Ä‡§ü‡§∞ ‚Äî ‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§ó‡•á‡§ú',
  psi_gauge_title:'‡§™‡•á‡§Ç‡§∂‡§® ‡§∏‡•ç‡§•‡§ø‡§∞‡§§‡§æ ‡§∏‡•Ç‡§ö‡§ï‡§æ‡§Ç‡§ï (PSI) ‚Äî ‡§∞‡§ø‡§ü‡§æ‡§Ø‡§∞‡§Æ‡•Ä‡§ü‡§∞ ‡§ó‡•á‡§ú',
  gauge_title_full:'‡§∞‡§ø‡§ü‡§æ‡§Ø‡§∞‡§Æ‡•Ä‡§ü‡§∞ ‚Äî ‡§™‡•á‡§Ç‡§∂‡§® ‡§∏‡•ç‡§•‡§ø‡§∞‡§§‡§æ ‡§∏‡•Ç‡§ö‡§ï‡§æ‡§Ç‡§ï ‡§ó‡•á‡§ú',
  g1:'‡§Ü‡§∞‡§æ‡§Æ‡§¶‡§æ‡§Ø‡§ï',g2:'‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§',g3:'‡§∏‡•ç‡§•‡§ø‡§∞',g4:'‡§Æ‡§ß‡•ç‡§Ø‡§Æ ‡§ú‡•ã‡§ñ‡§ø‡§Æ',g5:'‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§Æ‡•á‡§Ç',g6:'‡§ó‡§Ç‡§≠‡•Ä‡§∞',
  swr_lbl:'‡§™‡•ç‡§∞‡§•‡§Æ-‡§µ‡§∞‡•ç‡§∑ ‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä ‡§¶‡§∞ (SWR)',wcr_lbl:'‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä ‡§ï‡§µ‡§∞‡•á‡§ú ‡§Ö‡§®‡•Å‡§™‡§æ‡§§ (WCR)',
  psi_name:'‡§™‡•á‡§Ç‡§∂‡§® ‡§∏‡•ç‡§•‡§ø‡§∞‡§§‡§æ ‡§∏‡•Ç‡§ö‡§ï‡§æ‡§Ç‡§ï',rsr_name:'‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§™‡§∞‡•ç‡§Ø‡§æ‡§™‡•ç‡§§‡§§‡§æ ‡§Ö‡§®‡•Å‡§™‡§æ‡§§',swr_name:'‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä ‡§¶‡§∞',
  psi_lbl:'‡§™‡•á‡§Ç‡§∂‡§® ‡§∏‡•ç‡§•‡§ø‡§∞‡§§‡§æ ‡§∏‡•Ç‡§ö‡§ï‡§æ‡§Ç‡§ï',rsr_lbl:'‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§™‡§∞‡•ç‡§Ø‡§æ‡§™‡•ç‡§§‡§§‡§æ ‡§Ö‡§®‡•Å‡§™‡§æ‡§§',lcs_lbl:'‡§¶‡•Ä‡§∞‡•ç‡§ò‡§æ‡§Ø‡•Å ‡§ï‡§µ‡§∞‡•á‡§ú ‡§∏‡•ç‡§ï‡•ã‡§∞',
  psi_desc:'‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä‡§ï‡•É‡§§ ‡§Ü‡§Ø √∑ ‡§ï‡•Å‡§≤ ‡§µ‡•ç‡§Ø‡§Ø‡•§ ‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä‡§ï‡•É‡§§ ‡§ï‡§µ‡§∞‡•á‡§ú ‡§Æ‡§æ‡§™‡§§‡§æ ‡§π‡•à‡•§',
  rsr_desc:'‡§ï‡•Å‡§≤ ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§Ü‡§Ø √∑ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§µ‡•ç‡§Ø‡§Ø‡•§ ‡§∏‡§Æ‡§ó‡•ç‡§∞ ‡§™‡§∞‡•ç‡§Ø‡§æ‡§™‡•ç‡§§‡§§‡§æ‡•§',
  lcs_desc:'‡§µ‡§∞‡•ç‡§∑ ‡§ú‡§¨ ‡§ï‡•â‡§∞‡•ç‡§™‡§∏ ‡§§‡§®‡§æ‡§µ ‡§Æ‡•á‡§Ç ‡§∏‡§ï‡§æ‡§∞‡§æ‡§§‡•ç‡§Æ‡§ï ‡§∞‡§π‡§§‡§æ ‡§π‡•à‡•§',
  arc_lbl:'‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§™‡§∞‡•ç‡§Ø‡§æ‡§™‡•ç‡§§‡§§‡§æ',div_corpus_split:'‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§™‡§∞ ‡§ï‡•â‡§∞‡•ç‡§™‡§∏ ‡§µ‡§ø‡§≠‡§æ‡§ú‡§®',
  div_params:'‡§Ø‡•ã‡§ú‡§®‡§æ ‡§Æ‡§æ‡§™‡§¶‡§Ç‡§°',div_ann_type:'‡§è‡§®‡•ç‡§Ø‡•Å‡§ü‡•Ä ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞',div_custom_split:'‡§ï‡§∏‡•ç‡§ü‡§Æ ‡§∏‡§Ç‡§§‡•Å‡§≤‡§ø‡§§ ‡§µ‡§ø‡§≠‡§æ‡§ú‡§®',
  col_asset:'‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø',col_balance:'‡§∂‡•á‡§∑ + ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§Ø‡•ã‡§ó‡§¶‡§æ‡§®',col_return:'‡§∞‡§ø‡§ü‡§∞‡•ç‡§® %',
  src_nps:'NPS',src_nps_t:'‡§¨‡§æ‡§ú‡§º‡§æ‡§∞-‡§∏‡§Ç‡§¨‡§¶‡•ç‡§ß',src_epf:'EPF / ‡§ó‡•ç‡§∞‡•á‡§ö‡•ç‡§Ø‡•Å‡§ü‡•Ä',src_epf_t:'‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä‡§ï‡•É‡§§',
  src_ppf:'PPF',src_ppf_t:'‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä‡§ï‡•É‡§§',src_mf:'‡§Æ‡•ç‡§Ø‡•Ç‡§ö‡•Å‡§Ö‡§≤ ‡§´‡§Ç‡§° / ‡§∂‡•á‡§Ø‡§∞',src_mf_t:'‡§¨‡§æ‡§ú‡§º‡§æ‡§∞-‡§∏‡§Ç‡§¨‡§¶‡•ç‡§ß',
  src_prop:'‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø (‡§®‡§ø‡§µ‡•á‡§∂ ‡§Ø‡•ã‡§ó‡•ç‡§Ø)',src_prop_t:'‡§¨‡§æ‡§ú‡§º‡§æ‡§∞-‡§∏‡§Ç‡§¨‡§¶‡•ç‡§ß',src_fd:'FD / ‡§¨‡•â‡§®‡•ç‡§°',src_fd_t:'‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä‡§ï‡•É‡§§',
  src_oth:'‡§Ö‡§®‡•ç‡§Ø ‡§¨‡§ö‡§§',src_oth_t:'‡§Æ‡§ø‡§∂‡•ç‡§∞‡§ø‡§§',
  at_life:'‡§ú‡•Ä‡§µ‡§® ‡§è‡§®‡•ç‡§Ø‡•Å‡§ü‡•Ä',at_joint:'‡§∏‡§Ç‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§ú‡•Ä‡§µ‡§®',at_rop:'‡§ï‡•ç‡§∞‡§Ø ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§µ‡§æ‡§™‡§∏‡•Ä',at_inc:'‡§¨‡§¢‡§º‡§§‡•Ä 3% ‡§™‡•ç‡§∞‡§§‡§ø ‡§µ‡§∞‡•ç‡§∑',
  l_age:'‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Ü‡§Ø‡•Å',l_ret:'‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§Ü‡§Ø‡•Å',l_cc:'‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® NPS ‡§ï‡•â‡§∞‡•ç‡§™‡§∏ (‚Çπ)',l_mc:'‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§Ø‡•ã‡§ó‡§¶‡§æ‡§® (‚Çπ)',
  l_mc_cur:'‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§Ø‡•ã‡§ó‡§¶‡§æ‡§® (‚Çπ)',l_su:'‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§µ‡•É‡§¶‡•ç‡§ß‡§ø (%)',l_inf:'‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ‡§∏‡•ç‡§´‡•Ä‡§§‡§ø ‡§¶‡§∞ (%)',
  l_fund:'‡§´‡§Ç‡§° / ‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø ‡§Æ‡§ø‡§∂‡•ç‡§∞‡§£',l_cr:'‡§ï‡§∏‡•ç‡§ü‡§Æ ‡§∞‡§ø‡§ü‡§∞‡•ç‡§® (%)',l_apct:'‡§è‡§®‡•ç‡§Ø‡•Å‡§ü‡•Ä ‡§Ü‡§µ‡§Ç‡§ü‡§® %',l_ar:'‡§è‡§®‡•ç‡§Ø‡•Å‡§ü‡•Ä ‡§¶‡§∞ (%)',
  l_dp:'‡§µ‡§æ‡§Ç‡§õ‡§ø‡§§ ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§™‡•á‡§Ç‡§∂‡§® (‚Çπ ‡§Ü‡§ú)',l_le:'‡§ú‡•Ä‡§µ‡§® ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡§æ‡§∂‡§æ',l_exp:'‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§µ‡•ç‡§Ø‡§Ø (‚Çπ ‡§Ü‡§ú)',
  l_corpus:'‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§ï‡•â‡§∞‡•ç‡§™‡§∏ (‚Çπ)',l_lr:'‡§è‡§ï‡§Æ‡•Å‡§∂‡•ç‡§§ ‡§∞‡§ø‡§ü‡§∞‡•ç‡§® (%)',l_gi:'‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä‡§ï‡•É‡§§ ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§Ü‡§Ø (‚Çπ)',
  l_ti:'‡§ï‡•Å‡§≤ ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§Ü‡§Ø (‚Çπ)',l_pr:'‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§∞‡§ø‡§ü‡§∞‡•ç‡§® (%)',l_ret_age:'‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§Ü‡§Ø‡•Å',
  l_rr:'‡§Ö‡§™‡•á‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡§ø‡§ü‡§∞‡•ç‡§® (%)',l_name:'‡§®‡§æ‡§Æ',l_ret_rate:'‡§∞‡§ø‡§ü‡§∞‡•ç‡§® ‡§¶‡§∞ (%)',
  h_apct:'‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä‡§ï‡•É‡§§ ‡§™‡•á‡§Ç‡§∂‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§™‡§ï‡§æ ‡§Ü‡§µ‡§Ç‡§ü‡§®',h_ar:'‡§Ö‡§™‡§®‡•á ‡§™‡•ç‡§∞‡§¶‡§æ‡§§‡§æ ‡§∏‡•á ‡§¶‡§∞‡•á‡§Ç ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç',
  h_gi:'‡§è‡§®‡•ç‡§Ø‡•Å‡§ü‡•Ä + EPF ‡§™‡•á‡§Ç‡§∂‡§® + FD ‡§¨‡•ç‡§Ø‡§æ‡§ú',h_ti:'‡§∏‡§≠‡•Ä ‡§∏‡•ç‡§∞‡•ã‡§§ ‡§∏‡§Ç‡§Ø‡•Å‡§ï‡•ç‡§§',
  f75:'LC-75 ‡§Ü‡§ï‡•ç‡§∞‡§æ‡§Æ‡§ï (~12%)',f50:'LC-50 ‡§Æ‡§ß‡•ç‡§Ø‡§Æ (~10%)',f25:'LC-25 ‡§∞‡•Ç‡§¢‡§º‡§ø‡§µ‡§æ‡§¶‡•Ä (~8%)',fcustom:'‡§ï‡§∏‡•ç‡§ü‡§Æ ‡§∞‡§ø‡§ü‡§∞‡•ç‡§®',
  sc_cons:'‡§∞‡•Ç‡§¢‡§º‡§ø‡§µ‡§æ‡§¶‡•Ä',sc_mod:'‡§Æ‡§ß‡•ç‡§Ø‡§Æ ‚òÖ',sc_agg:'‡§Ü‡§ï‡•ç‡§∞‡§æ‡§Æ‡§ï',sc_best:'‡§Ü‡§ß‡§æ‡§∞',
  sc_a:'‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø A',sc_b:'‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø B',sc_c:'‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø C',
  btn_calc:'‡§ó‡§£‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç ‚Üí',btn_reset:'‡§∞‡•Ä‡§∏‡•á‡§ü',btn_next:'‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§ñ‡•ã‡§ú‡§ï ‡§Æ‡•á‡§Ç ‡§≠‡•á‡§ú‡•á‡§Ç ‚Üí',
  btn_compare:'‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø ‡§§‡•Å‡§≤‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç ‚Üí',btn_push_m5:'‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§Æ‡•á‡§Ç ‡§≠‡•á‡§ú‡•á‡§Ç ‚Üí',
  ph1:'‡§Ö‡§™‡§®‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§ó‡§£‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§',ph2:'‡§µ‡§æ‡§Ç‡§õ‡§ø‡§§ ‡§™‡•á‡§Ç‡§∂‡§® ‡§î‡§∞ ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§ñ‡•ã‡§ú‡•á‡§Ç ‡§¶‡§¨‡§æ‡§è‡§Ç‡•§',ph4:'‡§ï‡•â‡§∞‡•ç‡§™‡§∏ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§',
  ch1_t:'‡§ï‡•â‡§∞‡•ç‡§™‡§∏ ‡§µ‡•É‡§¶‡•ç‡§ß‡§ø ‚Äî ‡§§‡•Ä‡§® ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø',ch1b_t:'‡§Ø‡•ã‡§ó‡§¶‡§æ‡§® ‡§¨‡§®‡§æ‡§Æ ‡§®‡§ø‡§µ‡•á‡§∂ ‡§∞‡§ø‡§ü‡§∞‡•ç‡§®',ch1c_t:'‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ',
  ch2a_t:'‡§™‡•á‡§Ç‡§∂‡§® ‡§™‡§∞‡•ç‡§Ø‡§æ‡§™‡•ç‡§§‡§§‡§æ',ch2b_t:'‡§¶‡•á‡§∞‡•Ä ‡§ï‡•Ä ‡§≤‡§æ‡§ó‡§§',ch2c_t:'‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§™‡•á‡§Ç‡§∂‡§® ‡§¨‡§®‡§æ‡§Æ ‡§Ø‡•ã‡§ó‡§¶‡§æ‡§® ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§®',ch2d_t:'‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§™‡•á‡§Ç‡§∂‡§® ‡§¨‡§®‡§æ‡§Æ ‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§Ü‡§Ø‡•Å',
  ch3a_t:'‡§∏‡§Ç‡§™‡§§‡•ç‡§§‡§ø ‡§Ü‡§µ‡§Ç‡§ü‡§®',ch3b_t:'‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä‡§ï‡•É‡§§ ‡§¨‡§®‡§æ‡§Æ ‡§¨‡§æ‡§ú‡§º‡§æ‡§∞-‡§∏‡§Ç‡§¨‡§¶‡•ç‡§ß ‡§Ü‡§Ø',
  ch4a_t:'‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§Ü‡§Ø ‚Äî ‡§µ‡§∞‡•ç‡§∑ 1, 10, 20',ch4b_t:'‡§ï‡•â‡§∞‡•ç‡§™‡§∏ ‡§ï‡§Æ‡•Ä',ch4c_t:'‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ‡§∏‡•ç‡§´‡•Ä‡§§‡§ø ‡§ï‡•ç‡§∑‡§∞‡§£',
  ch5a_t:'6-‡§Ü‡§Ø‡§æ‡§Æ‡•Ä ‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∞‡§°‡§æ‡§∞',ch5b_t:'‡§¨‡§æ‡§ú‡§º‡§æ‡§∞ ‡§ù‡§ü‡§ï‡§æ ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£',ch5c_t:'‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ‡§∏‡•ç‡§´‡•Ä‡§§‡§ø ‡§ï‡•ç‡§∑‡§∞‡§£',
  ch6a_t:'‡§ï‡•â‡§∞‡•ç‡§™‡§∏ ‡§µ‡•É‡§¶‡•ç‡§ß‡§ø ‚Äî ‡§∏‡§≠‡•Ä ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø',ch6b_t:'‡§™‡•ç‡§∞‡§Æ‡•Å‡§ñ ‡§Æ‡•á‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§§‡•Å‡§≤‡§®‡§æ',ch6c_t:'‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§™‡•á‡§Ç‡§∂‡§® ‡§Æ‡•Ç‡§≤‡•ç‡§Ø',
  shock_base:'üìä ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø',shock_shocked:'üí• ‡§¨‡§æ‡§ú‡§º‡§æ‡§∞ ‡§ù‡§ü‡§ï‡•á ‡§ï‡•á ‡§¨‡§æ‡§¶ (‚àí40%)',shock_at80:'‡§Ü‡§Ø‡•Å 80 ‡§™‡§∞ ‡§ï‡•â‡§∞‡•ç‡§™‡§∏',shock_at85:'‡§Ü‡§Ø‡•Å 85 ‡§™‡§∞ ‡§ï‡•â‡§∞‡•ç‡§™‡§∏',
  m1_note_h:'‡§®‡•ã‡§ü:',m1_note:'‡§§‡•Ä‡§® ‡§™‡§∞‡§ø‡§¶‡•É‡§∂‡•ç‡§Ø ‡§∞‡•Ç‡§¢‡§º‡§ø‡§µ‡§æ‡§¶‡•Ä/‡§Æ‡§ß‡•ç‡§Ø‡§Æ/‡§Ü‡§ï‡•ç‡§∞‡§æ‡§Æ‡§ï ‡§™‡•ç‡§∞‡§¶‡§∞‡•ç‡§∂‡§® ‡§ï‡•ã ‡§Æ‡•â‡§°‡§≤ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç‡•§',
  tbl_metric:'‡§Æ‡•á‡§ü‡•ç‡§∞‡§ø‡§ï',
  verdict_comfortable:'‚úÖ ‡§Ü‡§∞‡§æ‡§Æ‡§¶‡§æ‡§Ø‡§ï ‚Äî ‡§Æ‡§ú‡§¨‡•Ç‡§§ ‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ‡•§',
  verdict_secure:'‚úÖ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‚Äî ‡§¨‡§π‡•Å‡§§ ‡§∏‡•ç‡§µ‡§∏‡•ç‡§• ‡§¶‡•É‡§∑‡•ç‡§ü‡§ø‡§ï‡•ã‡§£‡•§',
  verdict_stable:'üü° ‡§∏‡•ç‡§•‡§ø‡§∞ ‚Äî ‡§Æ‡§æ‡§®‡§ï ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§π‡§æ‡§∏‡§ø‡§≤‡•§ ‡§π‡§∞ 2-3 ‡§∏‡§æ‡§≤ ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§',
  verdict_modrisk:'‚ö†Ô∏è ‡§Æ‡§ß‡•ç‡§Ø‡§Æ ‡§ú‡•ã‡§ñ‡§ø‡§Æ ‚Äî ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§Ø‡•ã‡§ó‡§¶‡§æ‡§® 10-15% ‡§¨‡§¢‡§º‡§æ‡§è‡§Ç‡•§',
  verdict_atrisk:'üî¥ ‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§Æ‡•á‡§Ç ‚Äî ‡§§‡§§‡•ç‡§ï‡§æ‡§≤ ‡§ï‡§æ‡§∞‡•ç‡§∞‡§µ‡§æ‡§à ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡•§',
  verdict_critical:'üö® ‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‚Äî ‡§§‡§§‡•ç‡§ï‡§æ‡§≤ ‡§µ‡•ç‡§Ø‡§æ‡§™‡§ï ‡§™‡•Å‡§®‡§∞‡•ç‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡•§',
  psi_stable:'‡§¨‡§π‡•Å‡§§ ‡§∏‡•ç‡§•‡§ø‡§∞',psi_good:'‡§∏‡•ç‡§•‡§ø‡§∞ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞',psi_mod:'‡§Æ‡§ß‡•ç‡§Ø‡§Æ ‡§ú‡•ã‡§ñ‡§ø‡§Æ',psi_high:'‡§â‡§ö‡•ç‡§ö ‡§Ö‡§∏‡•ç‡§•‡§ø‡§∞‡§§‡§æ',
  rsr_surplus:'‡§Ü‡§Ø ‡§Ö‡§ß‡§ø‡§∂‡•á‡§∑',rsr_suff:'‡§™‡§∞‡•ç‡§Ø‡§æ‡§™‡•ç‡§§',rsr_part:'‡§Ü‡§Ç‡§∂‡§ø‡§ï ‡§ï‡§µ‡§∞‡•á‡§ú',rsr_gap:'‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§Ö‡§Ç‡§§‡§∞',rsr_crit:'‡§ó‡§Ç‡§≠‡•Ä‡§∞ ‡§Ö‡§Ç‡§§‡§∞',
  lcs_strong:'‡§Æ‡§ú‡§¨‡•Ç‡§§ ‡§ï‡§µ‡§∞‡•á‡§ú',lcs_good:'‡§Ö‡§ö‡•ç‡§õ‡§æ ‡§ï‡§µ‡§∞‡•á‡§ú',lcs_mod:'‡§Æ‡§ß‡•ç‡§Ø‡§Æ',lcs_short:'‡§≤‡§ò‡•Å ‡§ï‡§µ‡§∞‡•á‡§ú',
  winner_prefix:'üèÜ ‡§∏‡§∞‡•ç‡§µ‡§∂‡•ç‡§∞‡•á‡§∑‡•ç‡§†:',at_life:'‡§ú‡•Ä‡§µ‡§® ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï‡•Ä',at_joint:'‡§∏‡§Ç‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§ú‡•Ä‡§µ‡§®',at_rop:'‡§ñ‡§∞‡•Ä‡§¶ ‡§∞‡§æ‡§∂‡§ø ‡§µ‡§æ‡§™‡§∏‡•Ä',at_inc:'3% ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§µ‡•É‡§¶‡•ç‡§ß‡§ø',btn_reset:'‡§∞‡•Ä‡§∏‡•á‡§ü',btn_next:'‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§ñ‡•ã‡§ú‡§ï ‡§Æ‡•á‡§Ç ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç ‚Üí',btn_push_m4:'‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï‡•Ä ‡§ë‡§™‡•ç‡§ü‡§ø‡§Æ‡§æ‡§á‡§ú‡§º‡§∞ ‡§ï‡•ã ‡§≠‡•á‡§ú‡•á‡§Ç ‚Üí',btn_push_m5:'‡§ú‡•ã‡§ñ‡§ø‡§Æ ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° ‡§ï‡•ã ‡§≠‡•á‡§ú‡•á‡§Ç ‚Üí',ch1b_t:'‡§Ø‡•ã‡§ó‡§¶‡§æ‡§® ‡§¨‡§®‡§æ‡§Æ ‡§®‡§ø‡§µ‡•á‡§∂ ‡§∞‡§ø‡§ü‡§∞‡•ç‡§®',ch1c_t:'‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§Ø‡§æ‡§§‡•ç‡§∞‡§æ ‡§Æ‡•Ä‡§≤ ‡§ï‡•á ‡§™‡§§‡•ç‡§•‡§∞',ch2b_t:'‡§¶‡•á‡§∞‡•Ä ‡§ï‡•Ä ‡§≤‡§æ‡§ó‡§§',ch2c_t:'‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§™‡•á‡§Ç‡§∂‡§® ‡§¨‡§®‡§æ‡§Æ ‡§Ø‡•ã‡§ó‡§¶‡§æ‡§® ‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§®',ch2d_t:'‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§™‡•á‡§Ç‡§∂‡§® ‡§¨‡§®‡§æ‡§Æ ‡§∏‡•á‡§µ‡§æ‡§®‡§ø‡§µ‡•É‡§§‡•ç‡§§‡§ø ‡§Ü‡§Ø‡•Å',ch3b_t:'‡§ó‡§æ‡§∞‡§Ç‡§ü‡•Ä‡§° ‡§¨‡§®‡§æ‡§Æ ‡§¨‡§æ‡§ú‡§æ‡§∞-‡§≤‡§ø‡§Ç‡§ï‡•ç‡§° ‡§Ü‡§Ø',ch4b_t:'‡§∏‡§Æ‡§Ø ‡§ï‡•á ‡§∏‡§æ‡§• ‡§ï‡•ã‡§∑ ‡§ï‡§Æ‡•Ä',ch4c_t:'‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï‡•Ä ‡§ï‡§æ ‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ‡§∏‡•ç‡§´‡•Ä‡§§‡§ø ‡§ï‡•ç‡§∑‡§∞‡§£',ch5b_t:'‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§ù‡§ü‡§ï‡§æ ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£',ch5c_t:'‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ‡§∏‡•ç‡§´‡•Ä‡§§‡§ø ‡§ï‡•ç‡§∑‡§∞‡§£ ‚Äî ‚Çπ1 ‡§≤‡§æ‡§ñ ‡§ï‡•Ä ‡§ï‡•ç‡§∞‡§Ø ‡§∂‡§ï‡•ç‡§§‡§ø',ch6b_t:'‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Æ‡•á‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§§‡•Å‡§≤‡§®‡§æ',ch6c_t:'‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§™‡•á‡§Ç‡§∂‡§® ‡§Æ‡•Ç‡§≤‡•ç‡§Ø',col_balance:'‡§∂‡•á‡§∑ + ‡§Æ‡§æ‡§∏‡§ø‡§ï (‚Çπ)',col_return:'‡§∞‡§ø‡§ü‡§∞‡•ç‡§® %',ann_y1:'‡§µ‡§∞‡•ç‡§∑ 1 ‡§Æ‡§æ‡§∏‡§ø‡§ï',ann_y10:'‡§µ‡§∞‡•ç‡§∑ 10 ‡§Æ‡§æ‡§∏‡§ø‡§ï',ann_y20:'‡§µ‡§∞‡•ç‡§∑ 20 ‡§Æ‡§æ‡§∏‡§ø‡§ï',
  radar_labels:['‡§Ü‡§Ø','‡§¶‡•Ä‡§∞‡•ç‡§ò‡§æ‡§Ø‡•Å','‡§Æ‡•Å‡§¶‡•ç‡§∞‡§æ‡§∏‡•ç‡§´‡•Ä‡§§‡§ø ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ','‡§Ö‡§®‡•Å‡§ï‡•ç‡§∞‡§Æ ‡§ú‡•ã‡§ñ‡§ø‡§Æ','‡§§‡§∞‡§≤‡§§‡§æ','‡§µ‡§ø‡§µ‡§ø‡§ß‡•Ä‡§ï‡§∞‡§£'],
}
};

let lang='en';
function setLang(l){
  lang=l;
  document.getElementById('btn-en').classList.toggle('active',l==='en');
  document.getElementById('btn-hi').classList.toggle('active',l==='hi');
  document.querySelectorAll('[data-t]').forEach(el=>{
    const k=el.getAttribute('data-t');
    if(T[l][k]!==undefined) el.textContent=T[l][k];
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const $=id=>document.getElementById(id);
const n=id=>parseFloat($(id).value)||0;
const charts={};
const dc=id=>{if(charts[id]){charts[id].destroy();delete charts[id];}};
const show=id=>{$(id).style.display='';};
const hide=id=>{$(id).style.display='none';};

const fmt=v=>{
  if(v===null||v===undefined||isNaN(v)||!isFinite(v)) return '‚Äî';
  const neg=v<0;
  const a=Math.abs(v);
  let s;
  if(a>=10000000)      s=(a/10000000).toFixed(2)+' Cr';
  else if(a>=100000)   s=(a/100000).toFixed(2)+' L';
  else if(a>=1000)     s=Math.round(a).toLocaleString('en-IN');
  else                 s=Math.round(a).toString();
  return (neg?'‚àí':'')+'‚Çπ'+s;
};

function updSl(sid,vid){
  const v=parseFloat($(sid).value);
  $(vid).textContent=v+'%';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBAL PROFILE SYNC (GPS)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GS = {age:32,ret:60,le:90,cc:500000,mc:15000,su:5,exp:40000,inf:6,rr:10};

// GPS key ‚Üí all module input IDs that share this value
const SYNC = {
  age: ['m1-age','m2-age','m3-age','m7-age','m9-age','sca-age'],
  ret: ['m1-ret','m2-ret','m3-ret','m4-ret','m5-ret','m7-ret','m8-ret','m9-ret','sca-ret'],
  le:  ['m1-le','m2-le','m3-le','m4-le','m5-le','m8-le'],
  cc:  ['m1-cc','m2-cc','m7-cc','s-nps-b','sca-cc'],
  mc:  ['m1-mc','m2-mc','m7-mc','s-nps-m','sca-mc'],
  su:  ['m1-su','m2-su','m7-su','sca-su','m9-su'],
  exp: ['m1-exp','m3-exp','m8-exp','m9-exp'],
  inf: ['m1-inf','m2-inf','m3-inf','m5-inf','m8-inf','m9-inf','sca-inf','scb-inf','scc-inf'],
  rr:  ['m2-rr','m9-rr'],
};

// Reverse map: module input ID ‚Üí GPS key (built automatically)
const SYNC_REV = {};
Object.entries(SYNC).forEach(([k,ids])=>ids.forEach(id=>{SYNC_REV[id]=k;}));

function gsPropagate(key, val, sourceId){
  if(isNaN(val)||val===null) return;
  GS[key] = val;
  // Update GPS bar input (if source wasn't GPS bar)
  const gpsEl = $('gps-'+key);
  if(gpsEl && gpsEl.id !== sourceId) gpsEl.value = val;
  // Update all linked module inputs (skip source to avoid loops)
  (SYNC[key]||[]).forEach(id=>{
    if(id !== sourceId){
      const el = $(id);
      if(el) el.value = val;
    }
  });
  // Refresh live strip since age/ret/mc/cc may have changed
  // live strip removed ‚Äî no liveUp() needed
  // PFRDA regulatory check: NPS entry must be before age 65
  if(key==='age' && val>=65){
    const gpsAgeEl=$('gps-age');
    if(gpsAgeEl && !gpsAgeEl.nextElementSibling?.classList.contains('gps-age-warn')){
      const warn=document.createElement('div');
      warn.className='gps-age-warn';
      warn.style='font-size:9px;color:#C2410C;margin-top:2px;line-height:1.4';
      warn.textContent='‚öñÔ∏è PFRDA: NPS entry must be before age 65. Plan accordingly.';
      gpsAgeEl.parentNode.appendChild(warn);
    }
  } else if(key==='age' && val<65){
    const existWarn=document.querySelector('.gps-age-warn');
    if(existWarn) existWarn.remove();
  }
}

function initSync(){
  // Attach listeners to GPS bar inputs
  document.querySelectorAll('[data-gs]').forEach(el=>{
    const key = el.getAttribute('data-gs');
    el.addEventListener('input', e=>{
      gsPropagate(key, parseFloat(e.target.value)||0, e.target.id);
    });
  });
  // Attach listeners to all module inputs ‚Äî both 'input' (instant) and 'change' (blur)
  // so editing a module field syncs GPS immediately without needing to tab out.
  Object.entries(SYNC).forEach(([key, ids])=>{
    ids.forEach(id=>{
      const el = $(id);
      if(!el) return;
      const handler = e=>{
        const v = parseFloat(e.target.value)||0;
        gsPropagate(key, v, id);
      };
      el.addEventListener('input', handler);
      el.addEventListener('change', handler); // belt-and-suspenders for spinners
    });
  });
  // Run initial propagation to sync all defaults from GS ‚Üí all inputs
  Object.keys(GS).forEach(key=>gsPropagate(key, GS[key], null));

  // Name field ‚Üí update print header
  const nameEl = $('gps-name');
  updatePrintHeader();
  if(nameEl) nameEl.addEventListener('input', updatePrintHeader);
}
function updatePrintHeader(){
  const nameEl = $('gps-name');
  const name = nameEl ? nameEl.value.trim() : '';
  const userEl = $('print-name-user');
  const metaEl = $('print-name-meta');
  if(userEl) userEl.textContent = name ? `Retirement Plan for: ${name}` : 'Retirement Planning Report';
  if(metaEl) metaEl.textContent = `Generated on ${new Date().toLocaleDateString('en-IN',{day:'numeric',month:'long',year:'numeric'})} ¬∑ Age ${GS.age||'‚Äî'} ¬∑ Target Retirement Age ${GS.ret||'‚Äî'}`;
}

// ‚îÄ‚îÄ Tab scroll arrows ‚îÄ‚îÄ
function scrollTabs(dir){
  const el = $('tabs-scroll');
  el.scrollBy({left: dir * 180, behavior:'smooth'});
  setTimeout(updateTabArrows, 300);
}
function updateTabArrows(){
  const el = $('tabs-scroll');
  if(!el) return;
  const l = $('tab-arr-l'), r = $('tab-arr-r');
  if(l) l.style.opacity = el.scrollLeft > 5 ? '1' : '0.3';
  if(r) r.style.opacity = el.scrollLeft < el.scrollWidth - el.clientWidth - 5 ? '1' : '0.3';
}

// Module completion tracking
const modDone = new Array(9).fill(false);
function markModDone(idx){
  modDone[idx]=true;
  const d=document.getElementById('mpd-'+idx);
  if(d){d.classList.add('done');d.classList.remove('active');}
}
function updateModDots(activeIdx){
  for(let i=0;i<9;i++){
    const d=document.getElementById('mpd-'+i);
    if(!d) continue;
    if(i===activeIdx){d.classList.add('active');if(!modDone[i])d.classList.remove('done');}
    else{d.classList.remove('active');if(modDone[i])d.classList.add('done');else d.classList.remove('done');}
  }
}
function switchTab(i){
  document.querySelectorAll('.tab').forEach((b,j)=>b.classList.toggle('active',i===j));
  document.querySelectorAll('.page').forEach((p,j)=>p.classList.toggle('active',i===j));
  updateModDots(i);
  // Scroll active tab into view
  const activeTab = document.querySelectorAll('.tab')[i];
  if(activeTab) activeTab.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});
  window.scrollTo({top:0,behavior:'smooth'});
  setTimeout(updateTabArrows, 350);
}

// updateLD removed ‚Äî live strip removed

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FINANCIAL MATH  (v2 ‚Äî corrected rate convention + WCR)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// All return rates entered by users are treated as EFFECTIVE ANNUAL rates.
// fvL and fvGA both use the same effective annual rate, ensuring consistency.
const fvL=(pv,r,n)=>{
  if(n<=0)return pv;
  const safeR=Math.max(-0.99,r);
  return Math.max(0,pv*Math.pow(1+safeR,n));
};

// FV of monthly SIP with annual step-up.
// Treats rAnn as effective annual rate; derives monthly rate from it.
function fvGA(pmt, rAnn, gAnn, nYears){
  if(nYears<=0||pmt<0) return 0;
  if(pmt===0) return 0;
  const safeG=Math.max(-0.50,Math.min(0.50,gAnn));
  const safeR=Math.max(-0.30,rAnn);
  // Derive monthly rate from effective annual rate (consistent with fvL)
  const rm = safeR<=0 ? safeR/12 : Math.pow(1+safeR,1/12)-1;
  let fv=0, cur=pmt;
  for(let y=0;y<nYears;y++){
    const yearFV = Math.abs(rm)<1e-9 ? cur*12 : cur*(Math.pow(1+rm,12)-1)/rm;
    fv += yearFV * Math.pow(1+safeR, nYears-1-y);
    cur = Math.max(0, cur*(1+safeG));
  }
  return Math.max(0,fv);
}
const calcCorpus=(cc,mc,su,r,yrs)=>fvL(cc,r,yrs)+fvGA(mc,r,su,yrs);

// reqPMT: SIP needed to reach target from existing corpus.
// FIX: allows mild negative returns (down to -10%); warns user instead of silently clamping.
function reqPMT(target,existing,r,years){
  if(years<=0) return Math.max(0,target-existing);
  const safeR=Math.max(-0.10,r); // allow mild negative; warn above
  if(r<-0.10) console.warn('reqPMT: return '+Math.round(r*100)+'% very negative ‚Äî SIP estimate uses ‚àí10% floor');
  const fvEx=fvL(existing,safeR,years), need=target-fvEx;
  if(need<=0) return 0;
  const rm = safeR<=0 ? safeR/12 : Math.pow(1+safeR,1/12)-1;
  const nm=years*12;
  if(Math.abs(rm)<1e-9) return need/nm;
  const denom=Math.pow(1+rm,nm)-1;
  if(Math.abs(denom)<1e-9) return need;
  return Math.max(0,need*rm/denom);
}

// WCR: what fraction of the full retirement period does the corpus sustain inflation-growing
// withdrawals? Returns 0‚Äì100 (%). Accounts for post-retirement investment returns.
// FIX C1: replaces the old broken formula (corpus / undiscounted-total-expenses).
function computeWCR(corpus, annWithdrawal, postReturnRate, inf, postYrs){
  if(corpus<=0||annWithdrawal<=0||postYrs<=0) return corpus>0?100:0;
  let c=corpus;
  for(let i=0;i<postYrs;i++){
    const w=annWithdrawal*Math.pow(1+inf,i);
    c=c*(1+postReturnRate)-w;
    if(c<=0) return Math.round((i/postYrs)*100);
  }
  return 100;
}

// projectMarketIncome: model corpus depletion for market-linked assets.
// FIX C3: replaces permanently-flat mktIncome display with year-by-year depletion model.
// Returns array of annual income values (shrinks as corpus depletes).
function projectMarketIncome(mktCorpus, postReturnRate, annualWithdrawal, inf, postYrs){
  const income=[];
  let c=mktCorpus;
  for(let i=0;i<postYrs;i++){
    if(c<=0){income.push(0);continue;}
    const thisW=Math.min(c*(1+postReturnRate), annualWithdrawal*Math.pow(1+inf,i));
    income.push(thisW);
    c=Math.max(0,c*(1+postReturnRate)-thisW);
  }
  return income;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAUGE FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GAUGE_SWR=[
  {max:2, lbl:'verdict_comfortable',bg:'#dcfce7',col:'#15803D',pos:8.3},
  {max:3, lbl:'verdict_secure',     bg:'#d1fae5',col:'#059669',pos:25},
  {max:4, lbl:'verdict_stable',     bg:'#fef9c3',col:'#92400E',pos:41.7},
  {max:5, lbl:'verdict_modrisk',    bg:'#fed7aa',col:'#C2410C',pos:58.3},
  {max:7, lbl:'verdict_atrisk',     bg:'#fecaca',col:'#B91C1C',pos:75},
  {max:999,lbl:'verdict_critical',  bg:'#fca5a5',col:'#7F1D1D',pos:91.7},
];
const GAUGE_PSI=[
  {min:75, lbl:'verdict_comfortable',bg:'#dcfce7',col:'#15803D',pos:8.3},
  {min:60, lbl:'verdict_secure',     bg:'#d1fae5',col:'#059669',pos:25},
  {min:50, lbl:'verdict_stable',     bg:'#fef9c3',col:'#92400E',pos:41.7},
  {min:40, lbl:'verdict_modrisk',    bg:'#fed7aa',col:'#C2410C',pos:58.3},
  {min:25, lbl:'verdict_atrisk',     bg:'#fecaca',col:'#B91C1C',pos:75},
  {min:0,  lbl:'verdict_critical',   bg:'#fca5a5',col:'#7F1D1D',pos:91.7},
];

function applyGaugeSWR(arrId,verdictId,swr){
  let d=GAUGE_SWR[GAUGE_SWR.length-1];
  for(const g of GAUGE_SWR){if(swr<g.max){d=g;break;}}
  $(arrId).style.left=d.pos+'%';
  const v=$(verdictId); v.textContent=T[lang][d.lbl]; v.style.background=d.bg; v.style.color=d.col;
  return d;
}

function applyGaugePSI(arrId,verdictId,psi){
  let d=GAUGE_PSI[GAUGE_PSI.length-1];
  for(const g of GAUGE_PSI){if(psi>=g.min){d=g;break;}}
  $(arrId).style.left=d.pos+'%';
  const v=$(verdictId); v.textContent=T[lang][d.lbl]; v.style.background=d.bg; v.style.color=d.col;
  return d;
}

function applyRatioBar(fillId,valId,val,max,warn,danger){
  if(isNaN(val)||!isFinite(val)){val=0;}
  const pct=max>0?Math.min(100,(val/max)*100):0;
  const col=val<warn?'#16A34A':val<danger?'#D97706':'#DC2626';
  const f=$(fillId); f.style.width=pct+'%'; f.style.background=col;
  const v=$(valId); v.textContent=val.toFixed(1)+'%'; v.style.color=col;
}

// Return rate guard: warn if > 20%, clamp at 25%
function safeReturnRate(raw){
  const r=parseFloat(raw)||10;
  if(r>25){
    alert('‚ö†Ô∏è Return Rate Capped: The entered return of '+r+'% exceeds 25% p.a., which is unrealistic for long-term planning. Value clamped to 25%.');
    return 25;
  }
  if(r>20){
    console.warn('Return rate '+r+'% above 20% ‚Äî historically exceptional. Use with caution.');
  }
  return r;
}

// Chart base options
const CO={responsive:false,maintainAspectRatio:false,
  animation:false,
  plugins:{
    legend:{labels:{color:'#64748B',font:{size:11,family:'Plus Jakarta Sans'},boxWidth:12,padding:12}},
    tooltip:{animation:false}
  },
  scales:{x:{grid:{color:'rgba(0,0,0,0.04)'},ticks:{color:'#94A3B8',font:{size:10}}},
    y:{grid:{color:'rgba(0,0,0,0.04)'},beginAtZero:true,ticks:{color:'#94A3B8',font:{size:10,family:'JetBrains Mono'},callback:v=>fmt(v)}}}
};
const noLegend={plugins:{legend:{display:false}}};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODULE 1 ‚Äî NPS Growth Simulator
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FUND_RATES={lc75:[0.10,0.12,0.13],lc50:[0.08,0.10,0.12],lc25:[0.06,0.08,0.10]};

function m1FundChange(){
  $('m1-custom-row').style.display=$('m1-fund').value==='custom'?'flex':'none';
}

function getM1Rates(){
  const f=$('m1-fund').value;
  if(f==='custom'){const raw=n('m1-cr');const cr=safeReturnRate(raw)/100;return [Math.max(0.01,cr-0.02),cr,Math.min(0.25,cr+0.02)];}
  return FUND_RATES[f];
}

function liveUp(){} // live strip removed ‚Äî liveUp is a no-op

function selSc(s){['cons','mod','agg'].forEach(x=>$('sc-'+x).classList.toggle('selected',x===s));}

function calcM1(){
  const age=n('m1-age'),ret=n('m1-ret'),cc=n('m1-cc'),mc=n('m1-mc');
  const su=n('m1-su')/100,inf=n('m1-inf')/100,yrs=ret-age;
  const exp=n('m1-exp')||40000, le=n('m1-le')||90;
  const apct=n('m1-apct')/100, ar=n('m1-ar')/100;
  // Validate AFTER all vars declared
  if(yrs<=0){alert('Retirement age must exceed current age.');return;}
  if(le<=ret){alert('Life expectancy must exceed retirement age.');return;}
  if(mc<0){alert('Monthly contribution cannot be negative.');return;}
  if(exp<0){alert('Monthly expenses cannot be negative.');return;}
  const rates=getM1Rates();
  const corps=rates.map(r=>calcCorpus(cc,mc,su,r,yrs));
  const realCorps=corps.map(c=>c/Math.pow(1+inf,yrs));
  const monthlyPension=corps[1]*apct*ar/12;
  const lumpSum=corps[1]*(1-apct);
  // Use user's actual expense, inflated to retirement date
  const retExpAnnual=exp*12*Math.pow(1+inf,yrs);
  // SWR = first-year withdrawal needed / corpus (as %) ‚Äî lower is safer
  const swr=corps[1]>0?(retExpAnnual/corps[1])*100:999;
  // WCR: % of retirement period corpus can sustain inflation-growing withdrawals.
  // FIX: uses proper PMT-based depletion test accounting for post-retirement return.
  // Uses post-retirement return of ~7% (conservative balanced fund assumption).
  const postYrs=le-ret;
  const postRetR=0.07; // conservative post-retirement portfolio return
  const wcr=computeWCR(corps[1],retExpAnnual,postRetR,inf,postYrs);
  let tc=0,pm=mc; for(let y=0;y<yrs;y++){tc+=pm*12;pm*=(1+su);}

  ['cons','mod','agg'].forEach((s,i)=>{
    $('sc-'+s+'-v').textContent=fmt(corps[i]);
    $('sc-'+s+'-r').textContent='@ '+(rates[i]*100).toFixed(0)+'% p.a.';
    $('sc-'+s+'-real').textContent='Real: '+fmt(realCorps[i]);
  });

  $('m1-rg').innerHTML=[
    {l:'Years to Retire',v:yrs+' yrs'},{l:'Total Contributed',v:fmt(tc)},
    {l:'Wealth Created (Base)',v:fmt(corps[1]-tc)},{l:'Wealth Multiplier',v:tc>0?(corps[1]/tc).toFixed(1)+'x':'‚àû (lump sum only)'},
    {l:'NPS Annuity Income/mo (Base)',v:fmt(monthlyPension),hl:true},{l:'Lump Sum for SWP/Reinvestment',v:fmt(lumpSum)},
    {l:'Expenses at Retirement (Nominal ‚Çπ)',v:fmt(retExpAnnual)+'/yr'},{l:'Annuity Portion',v:fmt(corps[1]*apct),hl:true},
  ].map(c=>`<div class="rc${c.hl?' hl':''}"><div class="rc-lbl">${c.l}</div><div class="rc-val">${c.v}</div></div>`).join('');

  // Gauge
  const gd=applyGaugeSWR('m1-gauge-arr','m1-verdict',swr);
  $('m1-swr-tag').textContent='First-Year Withdrawal Rate: '+swr.toFixed(2)+'% of corpus (lower = safer) | Corpus Coverage: '+wcr.toFixed(0)+'% of retirement period funded at 7% post-ret. return';
  // SWR bar: lower SWR = safer (green). Max scale 12%.
  // WCR bar: higher % = more of retirement period covered (green = 100%, red = <60%)
  const wcrPct = Math.min(wcr, 100);
  const wcrFill = $('m1-wcr-fill'), wcrVal = $('m1-wcr-val');
  if(wcrFill && wcrVal){
    const wcrColor = wcrPct >= 90 ? '#16A34A' : wcrPct >= 70 ? '#D97706' : '#DC2626';
    wcrFill.style.width = wcrPct + '%';
    wcrFill.style.background = wcrColor;
    wcrVal.textContent = wcrPct.toFixed(0) + '% of retirement funded';
    wcrVal.style.color = wcrColor;
  }
  applyRatioBar('m1-swr-fill','m1-swr-val',swr,12,4,7);

  const riskTxt=gd.col==='#15803D'?'Comfortable':gd.col==='#059669'?'Secure':gd.col==='#92400E'?'Stable':gd.col==='#C2410C'?'Mod Risk':gd.col==='#B91C1C'?'At Risk':'Critical';
  // updateLD removed

  // I10: Tax disclaimer
  const taxNote=$('m1-tax-note');
  if(taxNote){
    taxNote.innerHTML='<strong>‚ö†Ô∏è Tax not modelled:</strong> NPS withdrawal: 60% corpus is tax-free; annuity income is taxed at slab rate. Equity LTCG above ‚Çπ1.25L is taxed at 12.5%. <strong>Effective post-tax corpus may be 10‚Äì20% lower.</strong> Consult a tax advisor. | <strong>Nominal vs Real:</strong> All corpus figures above are in future (nominal) rupees. Real (today\'s purchasing power): <strong>'+fmt(realCorps[1])+'</strong>';
    taxNote.style.display='';
  }

  hide('m1-right-ph');
  show('m1-results');
  markModDone(0);
  setTimeout(()=>drawM1(corps,rates,cc,mc,su,yrs,age,inf,tc),80);
}

function drawM1(corps,rates,cc,mc,su,yrs,age,inf,tc){
  // Growth chart with uncertainty band - sample max 40 points
  dc('m1-growth');
  const labels=[],d0=[],d1=[],d2=[];
  const step=Math.max(1,Math.ceil(yrs/38));
  for(let y=0;y<=yrs;y+=step){
    labels.push(age+y);
    rates.forEach((r,i)=>[d0,d1,d2][i].push(calcCorpus(cc,mc,su,r,y)));
  }
  if(labels[labels.length-1]!==age+yrs){
    labels.push(age+yrs);
    rates.forEach((r,i)=>[d0,d1,d2][i].push(calcCorpus(cc,mc,su,r,yrs)));
  }
  charts['m1-growth']=new Chart($('chart-m1-growth').getContext('2d'),{type:'line',data:{labels,datasets:[
    {label:T[lang].sc_cons,data:d0,borderColor:'#60A5FA',backgroundColor:'rgba(96,165,250,0.07)',borderWidth:1.5,tension:.4,pointRadius:0,fill:true},
    {label:T[lang].sc_mod, data:d1,borderColor:'#C8922A',backgroundColor:'rgba(200,146,42,0.09)',borderWidth:2.5,tension:.4,pointRadius:0,fill:true},
    {label:T[lang].sc_agg, data:d2,borderColor:'#10B981',backgroundColor:'rgba(16,185,129,0.07)',borderWidth:1.5,tension:.4,pointRadius:0,fill:true},
  ]},options:{...CO,plugins:{...CO.plugins,subtitle:{display:true,text:'Scenario range = Conservative / Moderate / Aggressive ‚Äî not a statistical confidence interval',color:'#94A3B8',font:{size:9,style:'italic'},padding:{bottom:4}}},scales:{x:{...CO.scales.x,title:{display:true,text:'Age',color:'#94A3B8',font:{size:10}}},y:{...CO.scales.y,title:{display:true,text:'Corpus (‚Çπ Nominal)',color:'#94A3B8',font:{size:10}}}}}});

  // Stacked: Initial corpus growth / Ongoing contributions / Returns ‚Äî sample ~20 points
  dc('m1-stack');
  const labS=[],dIC=[],dC=[],dR=[];
  const stepS=Math.max(1,Math.ceil(yrs/20));
  const sampleYrs=[...Array.from({length:Math.ceil(yrs/stepS)},(_,i)=>(i+1)*stepS),yrs].filter(y=>y<=yrs);
  for(const y of sampleYrs){
    const initialCorpusGrown = fvL(cc,rates[1],y); // initial corpus compounded
    const sipC = su===0 ? mc*12*y : mc*12*(Math.pow(1+su,y)-1)/su; // cumulative SIP cash in
    const corp = calcCorpus(cc,mc,su,rates[1],y);
    labS.push(age+y);
    dIC.push(initialCorpusGrown);
    dC.push(sipC);
    dR.push(Math.max(0,corp-initialCorpusGrown-sipC));
  }
  charts['m1-stack']=new Chart($('chart-m1-stack').getContext('2d'),{type:'bar',data:{labels:labS,datasets:[
    {label:'Initial Corpus Growth',data:dIC,backgroundColor:'rgba(30,64,175,0.5)',stack:'s'},
    {label:'Ongoing Contributions',data:dC,backgroundColor:'rgba(29,78,216,0.6)',stack:'s'},
    {label:'Investment Returns',data:dR,backgroundColor:'rgba(18,179,156,0.65)',stack:'s'},
  ]},options:{...CO,scales:{x:{...CO.scales.x,title:{display:true,text:'Age',color:'#94A3B8',font:{size:10}}},y:{...CO.scales.y,title:{display:true,text:'Corpus (‚Çπ Nominal)',color:'#94A3B8',font:{size:10}}}},plugins:{...CO.plugins,tooltip:{callbacks:{label:c=>' '+c.dataset.label+': '+fmt(c.raw)}}}}});

  // Timeline
  const milestones=[0.25,0.5,0.75,1].map(f=>Math.round(age+yrs*f));
  const tcols=['#60A5FA','#D97706','#C8922A','#10B981'];
  const tlbls=['25% Journey','Midpoint','75% Journey','üéâ Retirement!'];
  $('m1-timeline').innerHTML='<div class="tl-line"></div>'+milestones.map((a,i)=>{
    const c=calcCorpus(cc,mc,su,rates[1],a-age);
    return `<div class="tl-item"><div class="tl-dot" style="background:${tcols[i]}"></div><div class="tl-content"><div class="tl-age">Age ${a}</div><div class="tl-title">${tlbls[i]}</div><div class="tl-val">Est. Corpus: <strong style="color:${tcols[i]}">${fmt(c)}</strong></div></div></div>`;
  }).join('');
}

function sendToM2(){
  $('m2-age').value=n('m1-age'); $('m2-ret').value=n('m1-ret');
  $('m2-cc').value=n('m1-cc'); $('m2-mc').value=n('m1-mc');
  $('m2-inf').value=n('m1-inf');
  $('m2-apct').value=n('m1-apct'); updSl('m2-apct','m2-apct-v');
  $('m2-ar').value=n('m1-ar');
}
function resetM1(){hide('m1-results');show('m1-right-ph');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODULE 2 ‚Äî Goal Finder
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcM2(){
  const dp=n('m2-dp'),le=n('m2-le'),age=n('m2-age'),ret=n('m2-ret');
  const cc=n('m2-cc'),mc=n('m2-mc'),inf=n('m2-inf')/100,rr=safeReturnRate(n('m2-rr'))/100;
  const apct=n('m2-apct')/100,ar=n('m2-ar')/100;
  const yrs=ret-age,postYrs=le-ret;
  if(yrs<=0){alert('Retirement age must exceed current age.');return;}
  if(le<=ret){alert('Life expectancy must exceed retirement age.');return;}
  if(dp<=0){alert('Please enter a valid desired monthly pension.');return;}
  if(ar<=0&&apct>0){alert('Annuity rate cannot be zero when annuity allocation is set.');return;}
  if(mc<0){alert('Monthly contribution cannot be negative.');return;}
  const su=n('m2-su')/100;
  const futPension=dp*Math.pow(1+inf,yrs);
  // FIXED: Use PV of annuity formula (not perpetuity).
  // Annuity corpus = annual_income √ó [1 - (1+r)^(-n)] / r
  // where n = postYrs (retirement duration), r = annuity rate per year.
  // This correctly prices a fixed-term annuity product; the old perpetuity formula (income/r)
  // overstated the required corpus by 15‚Äì30% for typical rates and horizons.
  const annualIncomeFut = futPension * 12;
  let annCorpus;
  if(ar > 0.001 && postYrs > 0) {
    annCorpus = annualIncomeFut * (1 - Math.pow(1+ar, -postYrs)) / ar;
  } else {
    annCorpus = annualIncomeFut * postYrs; // zero-rate fallback: simple sum
  }
  // Guard: if apct=0, user wants 100% lump sum ‚Äî require 4% SWR corpus
  const totalCorpus=apct>0?annCorpus/apct:(futPension*12)/0.04;
  // Current trajectory uses user's actual step-up (was hardcoded 0 ‚Äî FIXED)
  const currentCorpus=calcCorpus(cc,mc,su,rr,yrs);
  // Required PMT to bridge gap from existing corpus to target
  const reqMC=reqPMT(totalCorpus,cc,rr,yrs);
  const gap=totalCorpus-currentCorpus;
  const adequacy=Math.min(150,currentCorpus>0&&totalCorpus>0?(currentCorpus/totalCorpus)*100:0);

  hide('m2-right-ph');
  show('m2-results');
  markModDone(1);

  $('m2-rg').innerHTML=[
    {l:'Required Retirement Corpus',v:fmt(totalCorpus),hl:true},
    {l:'Annuity Corpus Needed',v:fmt(annCorpus)},
    {l:'Future Monthly Pension',v:fmt(futPension)},
    {l:'Required Monthly Contribution',v:fmt(reqMC),hl:true},
    {l:'Current Trajectory Corpus',v:fmt(currentCorpus)},
    {l:gap<=0?'Corpus Surplus ‚úÖ':'Corpus Gap ‚ö†Ô∏è',v:fmt(Math.abs(gap))},
    {l:'Retirement Duration',v:postYrs+' yrs'},
    {l:'Lump Sum Available (60% non-annuity)',v:fmt(totalCorpus*(1-apct))},
  ].map(c=>`<div class="rc${c.hl?' hl':''}"><div class="rc-lbl">${c.l}</div><div class="rc-val">${c.v}</div></div>`).join('');

  // Calculation chain info box
  const onTrack=currentCorpus>=totalCorpus;
  $('m2-chain').innerHTML=`<strong>üìê Calculation Chain:</strong> Today ‚Çπ${dp.toLocaleString('en-IN')}/mo ‚Üí inflated ${yrs}yr @ ${(inf*100).toFixed(0)}% ‚Üí future pension <strong>${fmt(futPension)}/mo (nominal)</strong> ‚Üí annual need <strong>${fmt(futPension*12)}</strong> ‚Üí PV-annuity formula at ${(ar*100).toFixed(1)}% rate over ${postYrs}yr ‚Üí annuity corpus <strong>${fmt(annCorpus)}</strong> ‚Üí at ${(apct*100).toFixed(0)}% allocation ‚Üí <strong>total corpus needed: ${fmt(totalCorpus)} (nominal)</strong> ‚Üí current plan (${(su*100).toFixed(0)}% step-up): <strong>${fmt(currentCorpus)} (nominal)</strong> ‚Üí ${onTrack?'<span style="color:#16A34A">‚úÖ Already on track! No extra SIP needed.</span>':'required additional SIP: <strong>'+fmt(reqMC)+'</strong> <em style="font-size:10px;color:var(--faint)">(flat-SIP basis; with step-up your first-year SIP would be lower)</em>'} <br><span style="font-size:10px;color:#92400E">‚ö†Ô∏è All corpus values are in nominal future rupees. Post-tax corpus may be 10‚Äì20% lower. These projections are under base assumptions only ‚Äî verify sustainability in Module 5 (Risk Dashboard).</span>`;

  // Arc gauge animation
  const arcLen=239;
  const offset=arcLen-(adequacy/100)*arcLen;
  $('arc-track').style.strokeDashoffset=offset;
  const angle=Math.PI-(adequacy/100)*Math.PI;
  const cx=100+76*Math.cos(angle),cy=108-76*Math.sin(angle);
  $('arc-dot').setAttribute('cx',cx.toFixed(1));
  $('arc-dot').setAttribute('cy',cy.toFixed(1));
  $('m2-arc-num').textContent=adequacy.toFixed(0)+'%';
  const av=$('m2-arc-verdict');
  if(adequacy>=150){av.textContent='Strong Surplus üöÄ (under base assumptions)';av.style.background='#dcfce7';av.style.color='#15803D';}
  else if(adequacy>=100){av.textContent='On Track ‚úÖ (under base assumptions ‚Äî verify in Risk Dashboard)';av.style.background='#d1fae5';av.style.color='#059669';}
  else if(adequacy>=70){av.textContent='Nearly There üü° ‚Äî small gap remains';av.style.background='#fef9c3';av.style.color='#92400E';}
  else if(adequacy>=40){av.textContent='Gap Exists ‚ö†Ô∏è ‚Äî increase contributions';av.style.background='#fed7aa';av.style.color='#C2410C';}
  else{av.textContent='Large Gap üî¥ ‚Äî significant action needed';av.style.background='#fecaca';av.style.color='#B91C1C';}

  setTimeout(()=>{
    // Helper: rounded rect on canvas (for goal line label pills)
    function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();}
    // Cost of delay chart
    dc('m2-delay');
    const delays=[0,2,5,8,10];
    // Cost of delay: same target corpus, but fewer years. Existing corpus already partially grown.
    const dContribs=delays.map(d=>{
      const remYrs=Math.max(1,yrs-d);
      // Existing corpus grows for d more years before starting fresh calc
      const grownCC=fvL(cc,rr,d);
      return Math.max(0,reqPMT(totalCorpus,grownCC,rr,remYrs));
    });
    const delayColors=['#16A34A','#4ADE80','#D97706','#F97316','#DC2626'];
    charts['m2-delay']=new Chart($('chart-m2-delay').getContext('2d'),{type:'bar',data:{
      labels:delays.map(d=>d===0?'Start Now':'+'+d+' yrs'),
      datasets:[{label:'Required Monthly NPS Contribution',data:dContribs,backgroundColor:delayColors,borderRadius:8,borderWidth:0}]
    },options:{...CO,...noLegend,plugins:{...CO.plugins,legend:{display:false},tooltip:{callbacks:{label:c=>' ‚Çπ'+Math.round(c.raw).toLocaleString('en-IN')+'/month'}}}}});

    // ‚îÄ‚îÄ Chart 1: Pension vs Contribution Change (same retirement age) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    dc('m2-contrib');
    {
      // Variation bands: -15%, -10%, -5%, current(0), +5%, +10%, +15%
      const bands=[-15,-10,-5,0,5,10,15];
      const contribPensions=bands.map(pct=>{
        const adjMC=Math.max(0, mc*(1+pct/100));
        // Corpus with adjusted contribution, same ret age
        const adjCorpus=calcCorpus(cc,adjMC,su,rr,yrs);
        // Monthly pension = annuity portion √ó annuity rate / 12
        return adjCorpus*apct*ar/12;
      });
      const basePension=contribPensions[3]; // 0% change = current
      const barColors=bands.map((p,i)=>{
        if(i===3) return '#0A7C6E';        // current ‚Äî teal
        if(p>0)   return p>=10?'#15803D':'#4ADE80';  // increase ‚Äî green shades
        return p<=-10?'#DC2626':'#F97316'; // decrease ‚Äî red/orange shades
      });
      const clabels=bands.map(p=>p===0?'Current Plan':(p>0?'+'+p+'%':p+'%'));
      const datalabels=contribPensions.map(v=>'‚Çπ'+Math.round(v/1000)+'K');

      // Draw a horizontal goal line at target pension (dp inflated)
      const goalPension=futPension; // already computed in calcM2

      // Inline plugin: draws goal line + bar labels on canvas
      const contribGoalPlugin={id:'contribGoal',afterDraw(chart){
        const ctx=chart.ctx;
        const yScale=chart.scales.y;
        const xScale=chart.scales.x;
        const yPx=yScale.getPixelForValue(goalPension);
        // Goal dashed line
        ctx.save();
        ctx.setLineDash([6,4]);
        ctx.strokeStyle='#B8860B';
        ctx.lineWidth=2;
        ctx.beginPath();
        ctx.moveTo(xScale.left,yPx);
        ctx.lineTo(xScale.right,yPx);
        ctx.stroke();
        ctx.setLineDash([]);
        // Goal label pill
        const lbl='üéØ Target: ‚Çπ'+Math.round(goalPension/1000)+'K/mo';
        ctx.font='bold 9px Arial';
        const tw=ctx.measureText(lbl).width;
        ctx.fillStyle='rgba(184,134,11,.9)';
        roundRect(ctx,xScale.left+6,yPx-18,tw+12,16,4);
        ctx.fill();
        ctx.fillStyle='#fff';
        ctx.textAlign='left';
        ctx.textBaseline='middle';
        ctx.fillText(lbl,xScale.left+12,yPx-10);
        // Bar value labels
        ctx.fillStyle='#1A2B3C';
        ctx.font='bold 9.5px Arial';
        ctx.textAlign='center';
        ctx.textBaseline='bottom';
        chart.data.datasets[0].data.forEach((val,i)=>{
          const meta=chart.getDatasetMeta(0);
          const bar=meta.data[i];
          if(bar) ctx.fillText('‚Çπ'+Math.round(val/1000)+'K',bar.x,bar.y-3);
        });
        ctx.restore();
      }};
      charts['m2-contrib']=new Chart($('chart-m2-contrib').getContext('2d'),{
        type:'bar',
        plugins:[contribGoalPlugin],
        data:{
          labels:clabels,
          datasets:[{
            label:'Monthly Pension (‚Çπ/mo)',
            data:contribPensions,
            backgroundColor:barColors,
            borderRadius:6,
            borderWidth:0,
          }]
        },
        options:{
          ...CO,
          plugins:{
            ...CO.plugins,
            legend:{display:false},
            tooltip:{callbacks:{label:c=>' ‚Çπ'+Math.round(c.raw).toLocaleString('en-IN')+'/mo'}},
          },
          scales:{
            x:{...CO.scales.x,title:{display:true,text:'Contribution Variation',color:'#94A3B8',font:{size:10}}},
            y:{...CO.scales.y,title:{display:true,text:'Monthly Pension (‚Çπ)',color:'#94A3B8',font:{size:10}},ticks:{callback:v=>'‚Çπ'+Math.round(v/1000)+'K'}}
          }
        }
      });
    }

    // ‚îÄ‚îÄ Chart 2: Pension vs Retirement Age (same contribution) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    dc('m2-retage');
    {
      // Generate retirement ages: from (current age+5) to (ret+10), step 2
      const minRA=Math.max(age+5, ret-12);
      const maxRA=ret+10;
      const retAges=[];
      for(let ra=minRA;ra<=maxRA;ra+=2) retAges.push(ra);

      const retAgePensions=retAges.map(ra=>{
        const ry=Math.max(1,ra-age);
        const rpostYrs=Math.max(1,le-ra);
        const rCorpus=calcCorpus(cc,mc,su,rr,ry);
        // annuity income using same apct, ar
        return rCorpus*apct*ar/12;
      });

      const raColors=retAges.map(ra=>{
        if(ra===ret) return '#0A7C6E'; // planned retirement ‚Äî teal
        if(ra<ret)   return ra<=ret-8?'#DC2626':'#F97316'; // early ‚Äî risky
        return ra>=ret+6?'#15803D':'#4ADE80'; // later ‚Äî better
      });

      const retAgeGoalPlugin={id:'retAgeGoal',afterDraw(chart){
        const ctx=chart.ctx;
        const yScale=chart.scales.y;
        const xScale=chart.scales.x;
        const yPx=yScale.getPixelForValue(futPension);
        // Goal dashed line
        ctx.save();
        ctx.setLineDash([6,4]);
        ctx.strokeStyle='#B8860B';
        ctx.lineWidth=2;
        ctx.beginPath();
        ctx.moveTo(xScale.left,yPx);
        ctx.lineTo(xScale.right,yPx);
        ctx.stroke();
        ctx.setLineDash([]);
        // Label on right side
        const lbl='üéØ Target: ‚Çπ'+Math.round(futPension/1000)+'K/mo';
        ctx.font='bold 9px Arial';
        const tw=ctx.measureText(lbl).width;
        ctx.fillStyle='rgba(184,134,11,.9)';
        roundRect(ctx,xScale.right-tw-18,yPx-18,tw+12,16,4);
        ctx.fill();
        ctx.fillStyle='#fff';
        ctx.textAlign='left';
        ctx.textBaseline='middle';
        ctx.fillText(lbl,xScale.right-tw-12,yPx-10);
        // Bar value labels
        ctx.fillStyle='#1A2B3C';
        ctx.font='bold 9.5px Arial';
        ctx.textAlign='center';
        ctx.textBaseline='bottom';
        chart.data.datasets[0].data.forEach((val,i)=>{
          const meta=chart.getDatasetMeta(0);
          const bar=meta.data[i];
          if(bar) ctx.fillText('‚Çπ'+Math.round(val/1000)+'K',bar.x,bar.y-3);
        });
        ctx.restore();
      }};
      charts['m2-retage']=new Chart($('chart-m2-retage').getContext('2d'),{
        type:'bar',
        plugins:[retAgeGoalPlugin],
        data:{
          labels:retAges.map(ra=>ra===ret?'Age '+ra+' ‚òÖ':'Age '+ra),
          datasets:[{
            label:'Monthly Pension (‚Çπ/mo)',
            data:retAgePensions,
            backgroundColor:raColors,
            borderRadius:6,
            borderWidth:0,
          }]
        },
        options:{
          ...CO,
          plugins:{
            ...CO.plugins,
            legend:{display:false},
            tooltip:{callbacks:{label:c=>{
              const ra=retAges[c.dataIndex];
              const yrsToRet=ra-age;
              return [' ‚Çπ'+Math.round(c.raw).toLocaleString('en-IN')+'/mo',' Retire at '+ra+' ('+yrsToRet+' yrs away)'];
            }}},
          },
          scales:{
            x:{...CO.scales.x,title:{display:true,text:'Retirement Age',color:'#94A3B8',font:{size:10}}},
            y:{...CO.scales.y,title:{display:true,text:'Monthly Pension (‚Çπ)',color:'#94A3B8',font:{size:10}},ticks:{callback:v=>'‚Çπ'+Math.round(v/1000)+'K'}}
          }
        }
      });
    }
  },80);
}
function resetM2(){hide('m2-results');show('m2-right-ph');}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODULE 3 ‚Äî Holistic Corpus Integrator
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SOURCES=[
  {id:'nps',  name:'NPS',                  type:'market',    bid:'s-nps-b',  mid:'s-nps-m',  rid:'s-nps-r',  col:'#12B39C'},
  {id:'epf',  name:'EPF / Gratuity',        type:'guaranteed',bid:'s-epf-b',  mid:'s-epf-m',  rid:'s-epf-r',  col:'#16A34A'},
  {id:'ppf',  name:'PPF',                   type:'guaranteed',bid:'s-ppf-b',  mid:'s-ppf-m',  rid:'s-ppf-r',  col:'#1D4ED8'},
  {id:'mf',   name:'Mutual Funds',          type:'market',    bid:'s-mf-b',   mid:'s-mf-m',   rid:'s-mf-r',   col:'#6D28D9'},
  {id:'stk',  name:'Stocks / Equity',       type:'market',    bid:'s-stk-b',  mid:'s-stk-m',  rid:'s-stk-r',  col:'#8B5CF6'},
  {id:'prop', name:'Property (Investable)', type:'market',    bid:'s-prop-b', mid:'s-prop-m', rid:'s-prop-r', col:'#D97706'},
  {id:'fd',   name:'FD / Bonds',            type:'guaranteed',bid:'s-fd-b',   mid:'s-fd-m',   rid:'s-fd-r',   col:'#C8922A'},
  {id:'gold', name:'Gold / Commodities',    type:'market',    bid:'s-gold-b', mid:'s-gold-m', rid:'s-gold-r', col:'#F59E0B'},
  {id:'intl', name:'International / Crypto',type:'market',    bid:'s-intl-b', mid:'s-intl-m', rid:'s-intl-r', col:'#EC4899'},
  {id:'oth',  name:'Other Savings',         type:'mixed',     bid:'s-oth-b',  mid:'s-oth-m',  rid:'s-oth-r',  col:'#94A3B8'},
];

let G3={}; // shared state from M3

function calcM3(){
  const age=n('m3-age'),ret=n('m3-ret'),le=n('m3-le');
  const yrs=ret-age,postYrs=le-ret;
  const inf=n('m3-inf')/100,monthExp=n('m3-exp'),apct=n('m3-apct')/100;
  if(yrs<=0){alert('Retirement age must exceed current age.');return;}
  if(postYrs<=0){alert('Life expectancy must exceed retirement age.');return;}
  const retExp=monthExp*12*Math.pow(1+inf,yrs);

  const proj=SOURCES.map(s=>({
    ...s, balance:n(s.bid), monthly:n(s.mid), retRate:n(s.rid)/100,
    corpus:calcCorpus(n(s.bid),n(s.mid),0,n(s.rid)/100,yrs)
  }));

  // Use id-based lookup ‚Äî resilient to SOURCES array reordering
  const byId={}; proj.forEach(s=>byId[s.id]=s);

  const totalCorpus=proj.reduce((a,s)=>a+s.corpus,0);
  const npsC=byId['nps'].corpus;

  // NPS: annuity portion ‚Üí guaranteed income using user-editable annuity rate
  // FIXED: use PV-annuity (PMT) formula ‚Äî not perpetuity ‚Äî for finite post-retirement period.
  const NPS_ANNUITY_RATE=Math.max(0.03, Math.min(0.12, (n('m3-ar')||6)/100));
  const npsAnnCorpus=npsC*apct;
  const npsLsCorpus=npsC*(1-apct);
  // Annual annuity income = corpus √ó [r √ó (1+r)^n] / [(1+r)^n - 1]
  function npsAnnPMT(corpus, rate, years){
    if(corpus<=0||years<=0) return 0;
    if(rate<0.001) return corpus/years;
    return corpus * rate * Math.pow(1+rate,years) / (Math.pow(1+rate,years)-1);
  }
  const npsAnnIncome=npsAnnPMT(npsAnnCorpus, NPS_ANNUITY_RATE, postYrs);

  // FIXED: EPF, PPF, FD post-retirement income uses annuity withdrawal (PMT) formula
  // Annual withdrawal = corpus √ó [r √ó (1+r)^n] / [(1+r)^n - 1]
  // This correctly models drawing down the corpus over postYrs years at the given rate.
  // The old model (corpus √ó rate) was a perpetuity ‚Äî incorrect for finite-life instruments.
  function annuityWithdrawal(corpus, rate, years) {
    if (corpus <= 0 || years <= 0) return 0;
    if (rate < 0.001) return corpus / years; // zero-rate: simple division
    const factor = rate * Math.pow(1+rate, years) / (Math.pow(1+rate, years) - 1);
    return corpus * factor;
  }
  const POST_RET_RATE=Math.max(0.01, Math.min(0.15, (n('m3-post-ret-r')||7)/100));
  const epfIncome  = annuityWithdrawal(byId['epf'] ? byId['epf'].corpus : 0, POST_RET_RATE, postYrs);
  const ppfIncome  = annuityWithdrawal(byId['ppf'] ? byId['ppf'].corpus : 0, POST_RET_RATE, postYrs);
  const fdRate     = byId['fd'] ? byId['fd'].retRate : 0.07;
  const fdIncome   = annuityWithdrawal(byId['fd']  ? byId['fd'].corpus  : 0, fdRate,         postYrs);
  const guarIncome=npsAnnIncome+epfIncome+ppfIncome+fdIncome;

  // Market-linked pool: NPS lump sum + MF + Stocks + Property + Gold + Intl/Crypto + Other
  const mktCorpus=npsLsCorpus
    +(byId['mf']  ?byId['mf'].corpus  :0)
    +(byId['stk'] ?byId['stk'].corpus :0)
    +(byId['prop']?byId['prop'].corpus:0)
    +(byId['gold']?byId['gold'].corpus:0)
    +(byId['intl']?byId['intl'].corpus:0)
    +(byId['oth'] ?byId['oth'].corpus :0);

  const mktSWR=0.03; // FIX C7: 3% SWR is more appropriate for Indian context & long horizons
  const mktIncomeY1=mktCorpus*mktSWR; // Year-1 income for PSI/RSR/summary metrics
  const mktIncome=mktIncomeY1; // used for scorecard display (Year 1 figure)
  const totalIncome=guarIncome+mktIncome;
  const psi=retExp>0?(guarIncome/retExp)*100:0;
  const rsr=retExp>0?(totalIncome/retExp)*100:0;

  // FIX C3: compute year-by-year depleting market income for the chart
  // Market portfolio post-ret return: use a slightly higher assumption than guaranteed (equity-heavy)
  // Using 8% for equity/MF/NPS-lump sum corpus; EPF/PPF/FD uses user-editable POST_RET_RATE
  const POST_MKT_RET = Math.max(POST_RET_RATE, 0.08); // market assets earn ‚â• guaranteed rate
  const mktIncomeByYear = projectMarketIncome(mktCorpus, POST_MKT_RET, mktIncomeY1, inf, Math.min(postYrs,25));

  G3={totalCorpus,guarIncome,totalIncome,retExp,psi,rsr,npsAnnIncome,mktIncome,mktIncomeY1,mktIncomeByYear,mktCorpus,ret,le,inf,postYrs};
  // updateLD removed

  show('m3-results');
  markModDone(2);

  $('m3-rg').innerHTML=[
    {l:'Total Retirement Corpus',v:fmt(totalCorpus),hl:true},
    {l:'NPS Corpus',v:fmt(proj[0].corpus)},
    {l:'Guaranteed Annual Income',v:fmt(guarIncome),hl:true},
    {l:'Market-Linked Income (3% SWR, Yr 1)',v:fmt(mktIncome)},
    {l:'Total Annual Income (Yr 1)',v:fmt(totalIncome)},
    {l:'Annual Expenses at Retirement (Nominal ‚Çπ)',v:fmt(retExp)},
    {l:'PSI Score',v:psi.toFixed(1)+'%',hl:psi>=60},
    {l:'RSR Score',v:rsr.toFixed(1)+'%',hl:rsr>=100},
  ].map(c=>`<div class="rc${c.hl?' hl':''}"><div class="rc-lbl">${c.l}</div><div class="rc-val">${c.v}</div></div>`).join('');

  applyGaugePSI('m3-gauge-arr','m3-verdict',psi);
  $('m3-psi-tag').textContent='PSI = Guaranteed '+fmt(guarIncome)+'/yr √∑ Expenses '+fmt(retExp)+'/yr = '+psi.toFixed(1)+'% | All values nominal. Post-ret. drawdown return: '+(POST_RET_RATE*100).toFixed(1)+'% p.a. (editable above).';

  // ‚îÄ‚îÄ Asset Growth Table ‚îÄ‚îÄ
  const totalCurrentBal=proj.reduce((a,s)=>a+s.balance,0);
  $('m3-asset-tbody').innerHTML=proj.filter(s=>s.balance>0||s.monthly>0).map(s=>{
    const mult=s.balance>0?(s.corpus/s.balance).toFixed(2)+'√ó':'‚Äî';
    const pctTotal=totalCorpus>0?(s.corpus/totalCorpus*100).toFixed(1)+'%':'‚Äî';
    return `<tr style="border-bottom:1px solid var(--light)">
      <td style="padding:9px 13px;font-size:12px;font-weight:600;color:var(--navy)">${s.name}</td>
      <td style="padding:9px 13px;font-family:var(--mono);font-size:11.5px;text-align:right;color:var(--muted)">${fmt(s.balance)}</td>
      <td style="padding:9px 13px;font-family:var(--mono);font-size:11.5px;text-align:right;color:var(--gold)">${s.monthly>0?fmt(s.monthly)+'/mo':'‚Äî'}</td>
      <td style="padding:9px 13px;font-family:var(--mono);font-size:11.5px;text-align:right;color:var(--teal)">${(s.retRate*100).toFixed(1)}%</td>
      <td style="padding:9px 13px;font-family:var(--mono);font-size:12px;text-align:right;color:var(--navy);font-weight:700">${fmt(s.corpus)}</td>
      <td style="padding:9px 13px;font-family:var(--mono);font-size:11.5px;text-align:right;color:${s.corpus>s.balance*2?'var(--green)':'var(--muted)'}">${mult}</td>
      <td style="padding:9px 13px;font-family:var(--mono);font-size:11.5px;text-align:right;color:var(--purple)">${pctTotal}</td>
    </tr>`;
  }).join('');
  $('m3-asset-tfoot').innerHTML=`<tr style="background:var(--bg2)">
    <td style="padding:10px 13px;font-size:12px;font-weight:700;color:var(--navy)">TOTAL</td>
    <td style="padding:10px 13px;font-family:var(--mono);font-size:12px;text-align:right;font-weight:700;color:var(--navy)">${fmt(totalCurrentBal)}</td>
    <td style="padding:10px 13px"></td><td style="padding:10px 13px"></td>
    <td style="padding:10px 13px;font-family:var(--mono);font-size:13px;text-align:right;font-weight:900;color:var(--teal)">${fmt(totalCorpus)}</td>
    <td style="padding:10px 13px;font-family:var(--mono);font-size:12px;text-align:right;font-weight:700;color:var(--green)">${totalCurrentBal>0?(totalCorpus/totalCurrentBal).toFixed(2)+'√ó':'‚Äî'}</td>
    <td style="padding:10px 13px;font-family:var(--mono);font-size:11px;text-align:right;color:var(--muted)">100%</td>
  </tr>`;

  // Store proj for chart rendering
  G3._proj=proj; G3.totalCurrentBal=totalCurrentBal; G3.yrs=yrs;

  setTimeout(()=>{
    dc('m3-donut');
    const nonZ=proj.filter(s=>s.corpus>1000);
    charts['m3-donut']=new Chart($('chart-m3-donut').getContext('2d'),{type:'doughnut',data:{
      labels:nonZ.map(s=>s.name),
      datasets:[{data:nonZ.map(s=>s.corpus),backgroundColor:nonZ.map(s=>s.col),borderWidth:3,borderColor:'#fff',hoverOffset:8}]
    },options:{responsive:false,maintainAspectRatio:false,animation:false,cutout:'60%',
      plugins:{legend:{position:'bottom',labels:{color:'#64748B',font:{size:11},padding:12,boxWidth:12}},
        tooltip:{callbacks:{label:c=>' '+c.label+': '+fmt(c.raw)+' ('+(totalCorpus>0?(c.raw/totalCorpus*100).toFixed(1):'0')+'%)'}}}
    }});

    dc('m3-stack');
    const postLabels=Array.from({length:Math.min(postYrs,25)},(_,i)=>ret+i+1);
    // Crossover detection: first year where expenses exceed guaranteed+market income
    let crossoverAge=null;
    for(let i=0;i<postLabels.length;i++){
      const totalThisYr=guarIncome+(mktIncomeByYear[i]||0);
      if(totalThisYr < retExp*Math.pow(1+inf,i)){crossoverAge=postLabels[i];break;}
    }
    charts['m3-stack']=new Chart($('chart-m3-stack').getContext('2d'),{type:'bar',data:{labels:postLabels,datasets:[
      {label:'Guaranteed Income (fixed nominal ‚Äî real value erodes with inflation)',data:postLabels.map(()=>guarIncome),backgroundColor:'rgba(22,163,74,0.65)',stack:'s'},
      {label:'Market-Linked Income (3% SWR, depleting)',data:mktIncomeByYear,backgroundColor:'rgba(109,40,217,0.45)',stack:'s'},
      {label:'Annual Expenses (inflating)',data:postLabels.map((_,i)=>retExp*Math.pow(1+inf,i)),type:'line',borderColor:'#DC2626',backgroundColor:'transparent',borderWidth:2.5,pointRadius:0,tension:.3},
    ]},options:{...CO,scales:{x:{...CO.scales.x,title:{display:true,text:'Age',color:'#94A3B8',font:{size:10}}},y:{...CO.scales.y,title:{display:true,text:'Annual Amount (‚Çπ Nominal)',color:'#94A3B8',font:{size:10}}}}}});
    // Show crossover warning below chart
    const m3CrossDiv=document.getElementById('m3-crossover-note');
    if(m3CrossDiv){
      if(crossoverAge){
        m3CrossDiv.innerHTML='<span style="color:#B91C1C;font-weight:700">‚ö†Ô∏è Income‚ÄìExpense Crossover at Age '+crossoverAge+'</span> ‚Äî from this age, total income no longer covers expenses. Market corpus depletion accelerates the gap. Consider higher guaranteed income or larger corpus.';
        m3CrossDiv.style.display='';
      } else {
        m3CrossDiv.innerHTML='<span style="color:#15803D;font-weight:700">‚úÖ Income covers expenses throughout projected retirement</span> ‚Äî no crossover detected within the planning horizon.';
        m3CrossDiv.style.display='';
      }
    }

    // ‚îÄ‚îÄ Growth Chart: each asset class corpus at each year milestone ‚îÄ‚îÄ
    dc('m3-growth');
    const milestones=[];
    for(let y=0;y<=yrs;y+=Math.max(1,Math.floor(yrs/10))) milestones.push(y);
    if(milestones[milestones.length-1]!==yrs) milestones.push(yrs);
    const nonZeroProj=proj.filter(s=>s.balance>0||s.monthly>0);
    charts['m3-growth']=new Chart($('chart-m3-growth').getContext('2d'),{type:'line',data:{
      labels:milestones.map(y=>`Age ${n('m3-age')+y}`),
      datasets:nonZeroProj.map(s=>({
        label:s.name,
        data:milestones.map(y=>calcCorpus(s.balance,s.monthly,s.type==='market'?GS.su/100:0,s.retRate,y)),
        borderColor:s.col,backgroundColor:s.col+'22',borderWidth:2.5,pointRadius:3,tension:.3,fill:false
      }))
    },options:{...CO,scales:{x:{...CO.scales.x,title:{display:true,text:'Age (Years)',color:'#94A3B8',font:{size:10}},ticks:{...CO.scales.y.ticks,font:{size:9}}},y:{...CO.scales.y,title:{display:true,text:'Corpus (‚Çπ Nominal)',color:'#94A3B8',font:{size:10}}}}}});

    // ‚îÄ‚îÄ Allocation Shift Donut Charts ‚îÄ‚îÄ
    dc('m3-alloc-now');dc('m3-alloc-ret');
    const nowNonZ=proj.filter(s=>s.balance>0);
    const retNonZ=proj.filter(s=>s.corpus>1000);
    charts['m3-alloc-now']=new Chart($('chart-m3-alloc-now').getContext('2d'),{type:'doughnut',data:{
      labels:nowNonZ.map(s=>s.name),
      datasets:[{data:nowNonZ.map(s=>s.balance),backgroundColor:nowNonZ.map(s=>s.col),borderWidth:3,borderColor:'#fff',hoverOffset:6}]
    },options:{responsive:false,maintainAspectRatio:false,animation:false,cutout:'58%',plugins:{legend:{position:'bottom',labels:{color:'#64748B',font:{size:10},padding:8,boxWidth:10}},tooltip:{callbacks:{label:c=>' '+c.label+': '+fmt(c.raw)}}}}});
    charts['m3-alloc-ret']=new Chart($('chart-m3-alloc-ret').getContext('2d'),{type:'doughnut',data:{
      labels:retNonZ.map(s=>s.name),
      datasets:[{data:retNonZ.map(s=>s.corpus),backgroundColor:retNonZ.map(s=>s.col),borderWidth:3,borderColor:'#fff',hoverOffset:6}]
    },options:{responsive:false,maintainAspectRatio:false,animation:false,cutout:'58%',
      plugins:{
        legend:{position:'bottom',labels:{color:'#64748B',font:{size:10},padding:8,boxWidth:10}},
        tooltip:{callbacks:{label:c=>' '+c.label+': '+fmt(c.raw)+' ('+(c.raw/totalCorpus*100).toFixed(1)+'%)'}}
      }
    }});

    // Allocation insight
    const biggestNow=proj.filter(s=>s.balance>0).sort((a,b)=>b.balance-a.balance)[0];
    const biggestRet=proj.filter(s=>s.corpus>0).sort((a,b)=>b.corpus-a.corpus)[0];
    const mktPctNow=G3.totalCurrentBal>0?(proj.filter(s=>s.type==='market').reduce((a,s)=>a+s.balance,0)/G3.totalCurrentBal*100).toFixed(0):0;
    const mktPctRet=(totalCorpus>0?(proj.filter(s=>s.type==='market').reduce((a,s)=>a+s.corpus,0)/totalCorpus*100).toFixed(0):0);
    $('m3-alloc-insight').innerHTML=`<strong>üîç Allocation Shift Insight:</strong> Currently your largest holding is <strong>${biggestNow?biggestNow.name:'‚Äî'}</strong>. At retirement, <strong>${biggestRet?biggestRet.name:'‚Äî'}</strong> will dominate your corpus. Market-linked assets shift from <strong>${mktPctNow}%</strong> today to <strong>${mktPctRet}%</strong> at retirement. Consider de-risking into guaranteed instruments 5‚Äì7 years before retirement.`;
  },80);
}

function pushToM5(){
  if(!G3.totalCorpus) return;
  $('m5-corp').value=Math.round(G3.totalCorpus);
  $('m5-gi').value=Math.round(G3.guarIncome);
  $('m5-ti').value=Math.round(G3.totalIncome);
  $('m5-exp').value=Math.round(G3.retExp);
  $('m5-ret').value=G3.ret||60;
  $('m5-le').value=G3.le||90;
  $('m5-inf').value=n('m3-inf');
}
function pushToM4(){
  if(!G3.totalCorpus){alert('Please run the Corpus Integrator analysis first.');return;}
  $('m4-corp').value=Math.round(G3.totalCorpus);
  $('m4-ret').value=G3.ret||60;
  $('m4-le').value=G3.le||90;
  $('m4-inf').value=n('m3-inf');
}
function showM3GrowthTab(which){
  ['table','chart','alloc'].forEach(t=>{
    const el=$('m3-growth-'+t);
    if(el) el.style.display=(t===which)?'':'none';
  });
  document.querySelectorAll('.m3-gtab').forEach((btn,i)=>{
    const t=['table','chart','alloc'][i];
    if(t===which){btn.style.background='var(--purple)';btn.style.color='#fff';btn.style.borderColor='var(--purple)';}
    else{btn.style.background='#fff';btn.style.color='var(--muted)';btn.style.borderColor='var(--light)';}
  });
  // trigger chart resize when showing
  if(which==='chart'&&charts['m3-growth']) charts['m3-growth'].resize();
  if(which==='alloc'){
    if(charts['m3-alloc-now']) charts['m3-alloc-now'].resize();
    if(charts['m3-alloc-ret']) charts['m3-alloc-ret'].resize();
  }
}
function resetM3(){hide('m3-results');G3={};}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODULE 4 ‚Äî Annuity Optimizer
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let m4AnnType='life';
function selAt(el){document.querySelectorAll('.at-opt').forEach(e=>e.classList.remove('sel'));el.classList.add('sel');m4AnnType=el.getAttribute('data-v');}

function calcM4(){
  const corp=n('m4-corp'),ar=n('m4-ar')/100,lr=n('m4-lr')/100;
  const inf=n('m4-inf')/100,ret=n('m4-ret'),le=n('m4-le');
  const postYrsRaw=le-ret, postYrs=Math.max(1,postYrsRaw),custApct=n('m4-apct')/100;
  if(postYrsRaw<=0){alert('Life expectancy must exceed retirement age.');return;}
  if(corp<=0){alert('Please enter a valid retirement corpus.');return;}
  const adjAr=m4AnnType==='joint'?ar*0.90:m4AnnType==='rop'?ar*0.92:m4AnnType==='inc'?ar*0.85:ar;

  // Sustainable withdrawal rate: based on post-retirement return (4% rule baseline)
  // SWP rate = real post-retirement return, capped for safety
  // Real return = nominal return - inflation; floor at 1% to stay positive
  // Academic basis: Gordon (2015), Pfau (2012) ‚Äî withdraw at real return level
  const swpRate=Math.min(0.08,Math.max(0.03,Math.max(0.01,lr-inf)*0.9));

  const strategies=[
    {name:'Pension-First',    desc:'100% annuity ‚Äî maximum guaranteed income',   apct:1.0,       col:'#16A34A', tag:'Maximum Security'},
    {name:'Balanced',         desc:'Custom '+Math.round(custApct*100)+'% annuity split', apct:custApct, col:'#C8922A', tag:'Your Split'},
    {name:'Flexibility-First',desc:'20% annuity ‚Äî lump sum at '+(swpRate*100).toFixed(0)+'% SWR', apct:0.20, col:'#1D4ED8', tag:'Maximum Flexibility'},
    {name:'SWP + Partial',    desc:'35% annuity + SWP at '+(swpRate*100).toFixed(0)+'% SWR',      apct:0.35, col:'#6D28D9', tag:'Hybrid Strategy'},
  ];

  // FIXED: corpAtYr now uses fixed inflation-adjusted annual withdrawal (not % of grown corpus).
  // Old bug: c*(1+lr)*(1-swpRate) meant withdrawal grew with the portfolio ‚Äî overstated sustainability.
  // Correct model: withdraw a fixed rupee amount that grows only with inflation each year.
  // Initial annual withdrawal = lumpSum * swpRate; each year it inflates by inf.
  function corpAtYr(apct,yr){
    if(yr<=0) return corp*(1-apct);
    const lsAmt=corp*(1-apct);
    if(lsAmt<=0) return 0;
    const initWithdrawal = lsAmt * swpRate; // annual withdrawal in Year 1
    let c=lsAmt;
    for(let i=0;i<yr;i++){
      const withdrawal = initWithdrawal * Math.pow(1+inf, i); // inflation-adjusted
      c = Math.max(0, c*(1+lr) - withdrawal);
    }
    return c;
  }

  function getYrIncome(apct,yr){
    const annAmt=corp*apct;
    // Annuity income: fixed (life/joint/rop) or growing 3% p.a. (inc)
    const ann=m4AnnType==='inc'?annAmt*adjAr*Math.pow(1.03,Math.max(0,yr-1)):annAmt*adjAr;
    // Lump sum SWP: initial annual withdrawal = lsAmt * swpRate, inflation-adjusted each year
    const lsAmt = corp*(1-apct);
    const initWithdrawal = lsAmt * swpRate;
    const lsInc = yr > 0 ? initWithdrawal * Math.pow(1+inf, yr-1) : initWithdrawal;
    // But only if corpus is not yet depleted
    const remainingCorpus = corpAtYr(apct, yr-1);
    const actualLsInc = remainingCorpus > 0 ? lsInc : 0;
    return (ann+actualLsInc)/12;
  }

  hide('m4-ph');
  show('m4-results');
  markModDone(3);
  // Show SWP rate assumption
  const swpNote=document.createElement('div');
  swpNote.className='ib ib-gold';swpNote.style.marginBottom='10px';
  swpNote.innerHTML='<strong>üìå Assumptions:</strong> Lump sum SWP rate = <strong>'+(swpRate*100).toFixed(1)+'%</strong> (derived from your '+Math.round(lr*100)+'% post-retirement return setting). Annuity type: <strong>'+m4AnnType+'</strong>. All income figures are pre-tax.';
  const existingNote=document.querySelector('#m4-results .ib-gold');
  if(existingNote) existingNote.remove();
  $('m4-strats').parentNode.insertBefore(swpNote,$('m4-strats'));

  $('m4-strats').innerHTML=strategies.map(s=>{
    const y1=getYrIncome(s.apct,1),y10=getYrIncome(s.apct,10),y20=getYrIncome(s.apct,20);
    const c80=80>ret&&80<=le?corpAtYr(s.apct,80-ret):null;
    const c85=85>ret&&85<=le?corpAtYr(s.apct,85-ret):null;
    const ageStr=[c80!=null?'Age 80: '+fmt(c80):null,c85!=null?'Age 85: '+fmt(c85):null].filter(Boolean).join(' ¬∑ ')||'‚Äî';
    return `<div class="strat-card" style="border-top:3px solid ${s.col}">
      <div class="strat-name" style="color:${s.col}">${s.name}</div>
      <div class="strat-desc">${s.desc}</div>
      <div class="strat-y1">${fmt(y1)}<span style="font-size:10px;color:var(--muted)">/month</span></div>
      <div style="font-size:10px;color:var(--muted);margin-top:3px">Year 1 income</div>
      <div style="font-size:10.5px;color:var(--muted);margin-top:7px">Yr10: ${fmt(y10)}/mo ¬∑ Yr20: ${fmt(y20)}/mo</div>
      <div style="font-size:10.5px;color:var(--muted)">Lump sum corpus: ${ageStr}</div>
      <span class="strat-tag" style="background:${s.col}22;color:${s.col}">${s.tag}</span>
    </div>`;
  }).join('');

  setTimeout(()=>{
    dc('m4-income');
    charts['m4-income']=new Chart($('chart-m4-income').getContext('2d'),{type:'bar',data:{
      labels:strategies.map(s=>s.name),
      datasets:[1,10,20].map((yr,i)=>({
        label:'Year '+yr,
        data:strategies.map(s=>getYrIncome(s.apct,yr)),
        backgroundColor:strategies.map(s=>s.col+(i===0?'DD':i===1?'99':'55')),
        borderRadius:6,borderWidth:0
      }))
    },options:{...CO,plugins:{...CO.plugins,tooltip:{callbacks:{label:c=>' Year '+c.dataset.label.replace('Year ','')+': '+fmt(c.raw)+'/mo'}}}}});

    dc('m4-deplete');
    const yrLabels=Array.from({length:postYrs},(_,i)=>ret+i+1);
    // Filter: if a strategy has apct=1.0 (100% annuity), its corpus is always 0 ‚Äî show only non-zero strategies
    const depleteStrategies = strategies.filter(s=>s.apct < 0.999);
    const allAnnuity = depleteStrategies.length === 0;
    if(allAnnuity){
      const deplDiv=$('chart-m4-deplete').parentElement;
      if(deplDiv){
        $('chart-m4-deplete').style.display='none';
        const note=document.createElement('div');
        note.style='background:#EFF6FF;border:1px solid #BFDBFE;border-radius:8px;padding:14px;font-size:12.5px;color:#1E40AF;text-align:center;margin-top:8px';
        note.innerHTML='<strong>Pension-First strategy selected:</strong> 100% of corpus is allocated to annuity ‚Äî no lump sum remains for SWP. All retirement income is fully guaranteed.';
        deplDiv.appendChild(note);
      }
    } else {
      $('chart-m4-deplete').style.display='';
      // Get initial annual expense for overlay (from M4 inputs or fallback)
      // Use GPS monthly expense inflated to retirement date ‚Äî more accurate than 5% of corpus heuristic
      const m4InitExp = (GS.exp||40000)*12*Math.pow(1+inf,Math.max(0,ret-(GS.age||32)));
      charts['m4-deplete']=new Chart($('chart-m4-deplete').getContext('2d'),{type:'line',data:{labels:yrLabels,datasets:[
        ...depleteStrategies.map(s=>({
          label:s.name+' (lump sum corpus)',data:yrLabels.map(a=>Math.max(0,corpAtYr(s.apct,a-ret))),
          borderColor:s.col,backgroundColor:'transparent',borderWidth:2.5,tension:.3,pointRadius:0
        })),
        {label:'Inflation-adjusted annual withdrawal',data:yrLabels.map((_,i)=>m4InitExp*Math.pow(1+inf,i)),
          borderColor:'#DC2626',backgroundColor:'transparent',borderWidth:1.5,tension:.3,pointRadius:0,borderDash:[5,4]}
      ]},options:{...CO,scales:{x:{...CO.scales.x,title:{display:true,text:'Age',color:'#94A3B8',font:{size:10}}},y:{...CO.scales.y,title:{display:true,text:'Corpus (‚Çπ Nominal)',color:'#94A3B8',font:{size:10}}}}}});
    }

    dc('m4-erosion');
    const eYrs=Array.from({length:26},(_,i)=>i);
    const userInfPct=Math.round(inf*100);
    const erosionRates=[...new Set([3,userInfPct,8])].sort((a,b)=>a-b);
    const eColors=['#16A34A','#D97706','#DC2626'];
    charts['m4-erosion']=new Chart($('chart-m4-erosion').getContext('2d'),{type:'line',data:{labels:eYrs,datasets:erosionRates.map((rate,i)=>({
      label:rate+'% Inflation'+(rate===userInfPct?' (your rate)':''),data:eYrs.map(y=>100000/Math.pow(1+rate/100,y)),
      borderColor:eColors[Math.min(i,2)],backgroundColor:'transparent',borderWidth:rate===userInfPct?3:2,tension:.3,pointRadius:0,borderDash:rate===userInfPct?[]:[4,3]
    }))},options:{...CO,scales:{x:{...CO.scales.x,title:{display:true,text:'Years After Retirement',color:'#94A3B8',font:{size:10}}},
      y:{...CO.scales.y,beginAtZero:false,ticks:{...CO.scales.y.ticks,callback:v=>'‚Çπ'+Math.round(v/1000)+'K'}}}}});
  },80);
}
function resetM4(){hide('m4-results');show('m4-ph');}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODULE 5 ‚Äî Risk Dashboard
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcM5(){
  const corp=n('m5-corp'),gi=n('m5-gi'),ti=n('m5-ti'),exp=n('m5-exp');
  const pr=n('m5-pr')/100,inf=n('m5-inf')/100,le=n('m5-le'),ret=n('m5-ret');
  if(le<=ret){alert('Life expectancy must exceed retirement age.');return;}
  if(corp<=0){alert('Retirement corpus must be greater than zero.');return;}
  if(exp<=0){alert('Annual expenses must be greater than zero.');return;}
  if(gi>ti){alert('Guaranteed Income cannot exceed Total Income. Please check your inputs.');return;}
  if(ti<0||gi<0){alert('Income values cannot be negative.');return;}
  const postYrs=Math.max(1,le-ret);

  const psi=exp>0?(gi/exp)*100:0;
  const rsr=exp>0?(ti/exp)*100:0;
  const swr=corp>0?(exp/corp)*100:0;

  // ‚îÄ‚îÄ LCS: Longevity Coverage Score ‚îÄ‚îÄ
  // Stress test: portfolio return -3pp, general inflation +2pp, guaranteed income fixed
  // At each year: corpus grows at stressR, then net withdrawal = inflated expenses minus guaranteed income
  // This correctly models that annuity is fixed but market-linked income is not guaranteed
  const stressR=Math.max(0.005,pr-0.03), stressInf=inf+0.02;
  let remC=corp, lcsYrs=0;
  const lcsMaxYrs=Math.min(postYrs+10,60);
  for(let y=0;y<lcsMaxYrs;y++){
    const inflatedExp=exp*Math.pow(1+stressInf,y);
    // Under stress, market-linked withdrawals come from corpus; guaranteed income offsets expenses
    const netWithdrawal=Math.max(0,inflatedExp-gi); // guaranteed income covers part; rest from corpus
    remC=remC*(1+stressR)-netWithdrawal;
    if(remC>0) lcsYrs=y+1; else {lcsYrs=y; break;}
  }
  if(remC>0) lcsYrs=lcsMaxYrs;

  // Corpus projection function
  function projectC(c0,r,inf_,withdraw,years){
    const pts=[c0]; let c=c0;
    const cappedYears=Math.min(years,60);
    for(let i=0;i<cappedYears;i++){c=Math.max(0,c*(1+r)-withdraw*Math.pow(1+inf_,i));pts.push(c);}
    return pts;
  }
  const basePts=projectC(corp,pr,inf,exp,postYrs);
  const shockedPts=projectC(corp*0.60,pr,inf,exp,postYrs);

  const ageAt=(ageTarget)=>Math.max(0,Math.min(postYrs,ageTarget-ret));
  const c80b=basePts[ageAt(80)]||0,    c85b=basePts[ageAt(85)]||0;
  const c80s=shockedPts[ageAt(80)]||0, c85s=shockedPts[ageAt(85)]||0;

  // updateLD removed
  show('m5-results');
  markModDone(4);

  // Main PSI gauge
  applyGaugePSI('m5-gauge-arr','m5-verdict',psi);
  $('m5-gauge-sub').textContent='PSI: '+psi.toFixed(1)+'%  ¬∑  RSR: '+rsr.toFixed(1)+'%  ¬∑  SWR: '+swr.toFixed(2)+'%';
  applyRatioBar('m5-psi-fill','m5-psi-val',Math.min(psi,100),100,60,40);
  applyRatioBar('m5-rsr-fill','m5-rsr-val',Math.min(rsr,150),150,100,80);
  applyRatioBar('m5-swr-fill','m5-swr-val',Math.min(swr,15),15,4,7);  // SWR: green<4%, amber 4-7%, red>7%

  // PSI card
  $('m5-psi-num').textContent=psi.toFixed(1)+'%';
  const pc=$('m5-psi-chip');
  if(psi>=75){pc.textContent='‚úì Stable ‚Äî '+(psi).toFixed(0)+'% guaranteed coverage';pc.style.cssText='background:#dcfce7;color:#15803D';}
  else if(psi>=60){pc.textContent='~ Good ‚Äî boost by '+(75-psi).toFixed(0)+'%pt more guaranteed income';pc.style.cssText='background:#d1fae5;color:#059669';}
  else if(psi>=40){pc.textContent='‚ö† Moderate ‚Äî increase annuity or EPF allocation';pc.style.cssText='background:#fef9c3;color:#92400E';}
  else{pc.textContent='‚úó High Risk ‚Äî less than 40% guaranteed, build safety net';pc.style.cssText='background:#fecaca;color:#B91C1C';}

  // RSR card
  $('m5-rsr-num').textContent=rsr.toFixed(1)+'%';
  const rc=$('m5-rsr-chip');
  if(rsr>=130){rc.textContent='‚úì Surplus ‚Äî '+rsr.toFixed(0)+'% covered, excellent!';rc.style.cssText='background:#dcfce7;color:#15803D';}
  else if(rsr>=100){rc.textContent='~ Sufficient ‚Äî meet target, aim for 130%+';rc.style.cssText='background:#d1fae5;color:#059669';}
  else if(rsr>=80){rc.textContent='‚ö† Partial gap ‚Äî need '+fmt(Math.abs(exp-ti))+'/yr more income';rc.style.cssText='background:#fef9c3;color:#92400E';}
  else if(rsr>=60){rc.textContent='‚úó Shortfall ‚Äî '+fmt(Math.abs(exp-ti))+'/yr gap, act now';rc.style.cssText='background:#fed7aa;color:#C2410C';}
  else{rc.textContent='‚úó Critical ‚Äî less than 60% covered, major gap!';rc.style.cssText='background:#fecaca;color:#B91C1C';}

  // LCS card
  $('m5-lcs-num').textContent=lcsYrs+' yrs';
  const lc=$('m5-lcs-chip');
  if(lcsYrs>=postYrs){lc.textContent='‚úì Stress-proof ‚Äî '+lcsYrs+' yrs, full period covered';lc.style.cssText='background:#dcfce7;color:#15803D';}
  else if(lcsYrs>=postYrs*0.75){lc.textContent='~ Good ‚Äî covers '+(lcsYrs/postYrs*100).toFixed(0)+'% of retirement under stress';lc.style.cssText='background:#d1fae5;color:#059669';}
  else if(lcsYrs>=postYrs*0.5){lc.textContent='‚ö† Moderate ‚Äî corpus fails at age '+(ret+lcsYrs)+' under stress';lc.style.cssText='background:#fef9c3;color:#92400E';}
  else{lc.textContent='‚úó Longevity risk ‚Äî corpus runs out at age '+(ret+lcsYrs)+' under stress!';lc.style.cssText='background:#fecaca;color:#B91C1C';}

  // Shock test summary
  $('m5-base-80').textContent=fmt(c80b);  $('m5-base-85').textContent=fmt(c85b);
  $('m5-shock-80').textContent=fmt(c80s); $('m5-shock-85').textContent=fmt(c85s);

  // Advisory
  const advLines=[];
  if(psi<50) advLines.push('<strong>PSI below 50%:</strong> Your guaranteed income covers less than half your expenses. Consider increasing annuity allocation or EPF/PPF contributions to build more guaranteed income.');
  if(rsr<100) advLines.push('<strong>RSR below 100%:</strong> Total income falls short of expenses by <strong>'+fmt(Math.abs(exp-ti))+'</strong>/year. Increase contributions, delay retirement by 2‚Äì3 years, or reduce planned expenses.');
  if(lcsYrs<postYrs*0.7) advLines.push('<strong>Longevity risk:</strong> Under stress conditions your corpus lasts only '+lcsYrs+' of '+postYrs+' retirement years. Build a larger buffer or reduce withdrawal rate.');
  if(c80s<=0) advLines.push('<strong>Shock vulnerability:</strong> A 40% market crash at retirement wipes the corpus before age 80. Consider higher guaranteed income allocation or a larger emergency buffer.');
  if(advLines.length===0) advLines.push('<strong>Strong position:</strong> All three scores are healthy. Review annually and after major life changes.');
  $('m5-advice').innerHTML='<strong>üìã Advisor Insights:</strong><br>'+advLines.join('<br><br>');

  // Radar scores ‚Äî all on 0-10 scale
  // 1. Income Adequacy: RSR normalised ‚Äî 100% RSR = 8, 130% = 10, 70% = 5
  const incomeScore=Math.min(10,Math.max(0,(rsr/100)*8+(rsr>=130?2:0)));
  // 2. Longevity Coverage: fraction of postYrs covered under stress
  const longevityScore=Math.min(10,Math.max(0,(lcsYrs/Math.max(1,postYrs))*10));
  // 3. FIXED Inflation Shield: two-component score.
  //    Old bug: score peaked at PSI=55% and penalised PSI=100% same as PSI=0%.
  //    In reality PSI=100% (all guaranteed) beats PSI=0% (no guaranteed floor).
  //    (a) Guaranteed floor component: scores PSI linearly ‚Äî more guaranteed = more stable. Caps at 7/10.
  //    (b) Growth hedge component: market-linked fraction prevents inflation erosion. Adds up to 3/10.
  //    Total = floor_score + growth_score, capped at 10.
  const psiNorm=Math.min(1,psi/100); // 0 to 1
  const floorScore = Math.min(7, psiNorm * 7);            // 0‚Üí0, 100%PSI‚Üí7
  const growthHedge = ti > 0 ? Math.max(0,(ti-gi)/ti) : 0; // market fraction (0‚Äì1)
  const inflationScore=Math.min(10, floorScore + Math.min(3, growthHedge * 3));
  // 4. Sequence of Returns Risk: lower SWR = less vulnerable to bad early returns
  //    SWR ‚â§ 3% ‚Üí score 10; SWR ‚â• 8% ‚Üí score 0; linear between
  const seqRiskScore=Math.min(10,Math.max(0,10-Math.max(0,swr-2)*10/6));
  // 5. FIXED Liquidity: tiSafe division ‚Äî guard ti=0 properly
  const mktFraction = ti > 0 ? Math.max(0,Math.min(1,(ti-gi)/ti)) : 0;
  const liquidityScore=Math.min(10,Math.max(0,mktFraction*10));
  // 6. Diversification: having both guaranteed + market income improves diversification
  //    Perfect 50-50 split ‚Üí 10; mono-source ‚Üí 0
  const tiSafe=Math.max(0.001,ti);
  const splitBalance=Math.max(0,1-Math.abs(gi/tiSafe-0.5)*2);
  const diversScore=Math.min(10,Math.max(0,splitBalance*10));

  setTimeout(()=>{
    dc('m5-radar');
    charts['m5-radar']=new Chart($('chart-m5-radar').getContext('2d'),{type:'radar',data:{
      labels:T[lang].radar_labels,
      datasets:[{label:'Your Retirement Health',
        data:[incomeScore,longevityScore,inflationScore,seqRiskScore,liquidityScore,diversScore],
        backgroundColor:'rgba(14,166,143,0.15)',borderColor:'#0EA68F',borderWidth:2.5,pointBackgroundColor:'#0EA68F',pointRadius:5,pointHoverRadius:7
      },{label:'Target Score (8/10)',
        data:[8,8,8,8,8,8],
        backgroundColor:'rgba(232,100,10,0.07)',borderColor:'rgba(232,100,10,0.45)',borderWidth:1.5,pointRadius:3,borderDash:[4,4]
      }]
    },options:{responsive:false,maintainAspectRatio:false,animation:false,
      plugins:{legend:{labels:{color:'#64748B',font:{size:11},boxWidth:12,padding:12}}},
      scales:{r:{grid:{color:'rgba(0,0,0,0.06)'},ticks:{color:'#94A3B8',font:{size:9},backdropColor:'transparent'},angleLines:{color:'rgba(0,0,0,0.06)'},pointLabels:{color:'#1A2B3C',font:{size:11,weight:'600'}},suggestedMin:0,suggestedMax:10}}
    }});

    dc('m5-shock');
    const sLabels=Array.from({length:postYrs+1},(_,i)=>ret+i);
    charts['m5-shock']=new Chart($('chart-m5-shock').getContext('2d'),{type:'line',data:{labels:sLabels,datasets:[
      {label:'Base Scenario',data:basePts,borderColor:'#16A34A',backgroundColor:'rgba(22,163,74,0.07)',borderWidth:2.5,tension:.4,pointRadius:0,fill:true},
      {label:'After 40% Shock (Year 1)',data:shockedPts,borderColor:'#DC2626',backgroundColor:'rgba(220,38,38,0.06)',borderWidth:2.5,tension:.4,pointRadius:0,fill:true,borderDash:[5,3]},
    ]},options:{...CO,scales:{x:{...CO.scales.x,title:{display:true,text:'Age',color:'#94A3B8',font:{size:10}}},y:{...CO.scales.y,title:{display:true,text:'Corpus (‚Çπ Nominal)',color:'#94A3B8',font:{size:10}}}}}});

    dc('m5-erosion');
    const eYrs=Array.from({length:26},(_,i)=>i);
    charts['m5-erosion']=new Chart($('chart-m5-erosion').getContext('2d'),{type:'line',data:{labels:eYrs,datasets:[3,6,8].map((rate,i)=>({
      label:rate+'% Inflation',data:eYrs.map(y=>100000/Math.pow(1+rate/100,y)),
      borderColor:['#16A34A','#D97706','#DC2626'][i],backgroundColor:'transparent',borderWidth:2.5,tension:.3,pointRadius:0
    }))},options:{...CO,scales:{x:{...CO.scales.x,title:{display:true,text:'Years After Retirement',color:'#94A3B8',font:{size:10}}},
      y:{...CO.scales.y,beginAtZero:false,ticks:{...CO.scales.y.ticks,callback:v=>'‚Çπ'+Math.round(v/1000)+'K'}}}}});
  },80);
}
function resetM5(){hide('m5-results');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODULE 6 ‚Äî Scenario Lab
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcM6(){
  function getSc(pfx){
    const vNum=(id,def)=>{const v=parseFloat($(id).value);return isNaN(v)?def:v;};
    return {
      name:$(pfx+'-name').value||(pfx==='sca'?'Scenario A':pfx==='scb'?'Scenario B':'Scenario C'),
      age:Math.max(18,vNum(pfx+'-age',30)),
      ret:Math.max(30,vNum(pfx+'-ret',60)),
      cc:Math.max(0,vNum(pfx+'-cc',0)),
      mc:Math.max(0,vNum(pfx+'-mc',0)),   // 0 is valid (lump sum only scenario)
      su:vNum(pfx+'-su',0)/100,
      r:Math.max(0.001,vNum(pfx+'-r',10)/100),  // minimum 0.1% return
      inf:Math.max(0,vNum(pfx+'-inf',6)/100),
    };
  }
  const scs=[getSc('sca'),getSc('scb'),getSc('scc')];
  // Validate FIRST before any computation or DOM mutation
  for(const s of scs){
    if(s.ret<=s.age){alert('Retirement age must exceed current age in all scenarios.');return;}
  }
  // Use M1 annuity settings if available, else sensible defaults
  const m6Apct=(n('m1-apct')||40)/100;
  const m6Ar=(n('m1-ar')||6)/100;
  const results=scs.map(s=>{
    const yrs=Math.max(1,s.ret-s.age);
    if(yrs<1){return {name:s.name,age:s.age,ret:s.ret,cc:s.cc,mc:s.mc,su:s.su,r:s.r,inf:s.inf,yrs:0,corp:s.cc,realCorp:s.cc,pension:s.cc*m6Apct*m6Ar/12,tc:0,wm:1};}
    const corp=Math.max(0,calcCorpus(s.cc,s.mc,s.su,s.r,yrs));
    const realCorp=corp/Math.pow(1+s.inf,yrs);
    // Pension = annuity portion of corpus * annuity rate / 12
    const pension=corp*m6Apct*m6Ar/12;
    let tc=0,pm=s.mc;
    for(let y=0;y<yrs;y++){tc+=pm*12;pm*=(1+s.su);}
    tc+=s.cc; // include initial corpus in total invested
    // Wealth multiplier: how many times corpus vs total invested (including initial)
    const wm=tc>0?corp/tc:corp>0?Infinity:1;
    return {...s,yrs,corp,realCorp,pension,tc,wm:isFinite(wm)?wm:corp/1000};
  });

  const bestIdx=results.reduce((bi,r,i)=>r.corp>results[bi].corp?i:bi,0);
  const bestNames=['üîµ','üü°','üü¢'];
  $('m6-winner').textContent=T[lang].winner_prefix+' '+bestNames[bestIdx]+' '+results[bestIdx].name+' ‚Äî '+fmt(results[bestIdx].corp)+' corpus  |  Pension assumes '+Math.round(m6Apct*100)+'% annuity @ '+Math.round(m6Ar*100)+'%';

  // Headers
  $('m6-h-a').textContent='üîµ '+results[0].name;
  $('m6-h-b').textContent='üü° '+results[1].name;
  $('m6-h-c').textContent='üü¢ '+results[2].name;

  // Metric cards
  const rc=(l,vals,hl)=>`<div class="rc${hl?' hl':''}"><div class="rc-lbl">${l}</div>${vals.map(v=>`<div class="rc-val" style="font-size:12px">${v}</div>`).join('')}</div>`;
  $('m6-rg').innerHTML=results.map((r,i)=>`<div class="rc${i===bestIdx?' hl':''}">
    <div class="rc-lbl">${['üîµ','üü°','üü¢'][i]} ${r.name}</div>
    <div class="rc-val">${fmt(r.corp)}</div>
    <div class="rc-sub">Pension: ${fmt(r.pension)}/mo</div>
    <div class="rc-sub">Multiplier: ${r.wm>100?'100x+':r.wm.toFixed(1)+'x'}</div>
    <div class="rc-sub">Real: ${fmt(r.realCorp)}</div>
  </div>`).join('');

  // Comparison table
  const rows=[
    ['Corpus (Base)',results.map(r=>fmt(r.corp))],
    ['Monthly Pension',results.map(r=>fmt(r.pension))],
    ['Total Invested (incl. initial)',results.map(r=>fmt(r.tc))],
    ['Wealth Multiplier',results.map(r=>r.wm>100?'100x+':r.wm.toFixed(1)+'x')],
    ['Real Corpus (Today)',results.map(r=>fmt(r.realCorp))],
    ['Years to Retire',results.map(r=>r.yrs+' yrs')],
    ['Return Rate',results.map(r=>(r.r*100).toFixed(1)+'%')],
  ];
  $('m6-tbody').innerHTML=rows.map(([l,vals])=>`<tr style="border-bottom:1px solid var(--light)">
    <td style="padding:10px 14px;font-size:12.5px;color:var(--muted)">${l}</td>
    ${vals.map((v,i)=>`<td style="padding:10px 14px;font-family:var(--mono);font-size:12px;text-align:right;color:${['#1D4ED8','#C8922A','#16A34A'][i]}">${v}</td>`).join('')}
  </tr>`).join('');

  show('m6-results')
  markModDone(5);;

  setTimeout(()=>{
    // Growth chart
    dc('m6-growth');
    const maxYrs=Math.max(...results.map(r=>r.yrs));
    const baseAge=Math.min(...results.map(r=>r.age));
    const m6step=Math.max(1,Math.ceil(maxYrs/38));
    const labels=Array.from({length:maxYrs+1},(_,i)=>baseAge+i).filter((_,i)=>i%m6step===0||i===maxYrs);
    const cols=['#1D4ED8','#C8922A','#16A34A'];
    charts['m6-growth']=new Chart($('chart-m6-growth').getContext('2d'),{type:'line',data:{labels,datasets:results.map((s,i)=>{
      const d=labels.map(a=>{const y=a-s.age;return y<0?null:calcCorpus(s.cc,s.mc,s.su,s.r,y);});
      return {label:s.name,data:d,borderColor:cols[i],backgroundColor:cols[i].replace(')',',0.06)').replace('rgb','rgba'),borderWidth:2.5,tension:.4,pointRadius:0,fill:true,spanGaps:true};
    })} ,options:{...CO,scales:{x:{...CO.scales.x,title:{display:true,text:'Age',color:'#94A3B8',font:{size:10}}},y:{...CO.scales.y,title:{display:true,text:'Corpus (‚Çπ Nominal)',color:'#94A3B8',font:{size:10}}}}}});

    // Bar chart - Final Corpus comparison (clean, single unit)
    dc('m6-bar');
    charts['m6-bar']=new Chart($('chart-m6-bar').getContext('2d'),{type:'bar',data:{
      labels:results.map(r=>r.name),
      datasets:[{
        label:'Final Corpus (‚Çπ)',
        data:results.map(r=>r.corp),
        backgroundColor:cols.map(c=>c+'CC'),
        borderRadius:8,borderWidth:0,categoryPercentage:0.5
      }]
    },options:{...CO,plugins:{...CO.plugins,legend:{display:false},tooltip:{callbacks:{label:c=>' '+fmt(c.raw)}}}}});

    // Real pension value over time
    dc('m6-real');
    const postYrs=25;
    const pYrs=Array.from({length:postYrs},(_,i)=>i+1);
    charts['m6-real']=new Chart($('chart-m6-real').getContext('2d'),{type:'line',data:{labels:pYrs,datasets:results.map((r,i)=>({
      label:r.name+' real pension',
      data:pYrs.map(y=>r.pension/Math.pow(1+r.inf,y)),
      borderColor:cols[i],backgroundColor:'transparent',borderWidth:2.5,tension:.3,pointRadius:0
    }))},options:{...CO,scales:{x:{...CO.scales.x,title:{display:true,text:'Years After Retirement',color:'#94A3B8',font:{size:10}}},y:{...CO.scales.y}}}});

    // ‚îÄ‚îÄ Sequence-of-Returns Risk Panel ‚îÄ‚îÄ
    // Shows impact of a bear market in early retirement years (same average return, bad ordering).
    // Uses Scenario A's settings. Bear years 1-5 return = 50% of normal, then recovery.
    const sr=results[0];
    if(sr&&sr.corp>0&&sr.ret>sr.age){
      const initWithdrawal=sr.corp*m6Apct*m6Ar; // annual withdrawal = annuity portion income
      const baseR=sr.r; // average return
      const bearR=baseR*0.5-0.15; // bear market: deep negative (e.g. 10% normal ‚Üí ~-10% in bear)
      const recovR=baseR+(baseR-bearR)*5/25; // recovery compensates, same 25yr average
      const seqYrs=25;
      const baseCorpus=[sr.corp];
      const seqCorpus=[sr.corp];
      for(let y=0;y<seqYrs;y++){
        const withdrawal=Math.min(baseCorpus[y]||0, initWithdrawal);
        baseCorpus.push(Math.max(0,(baseCorpus[y]||0)*(1+baseR)-withdrawal));
        const thisR=y<5?bearR:recovR;
        const seqW=Math.min(seqCorpus[y]||0, initWithdrawal);
        seqCorpus.push(Math.max(0,(seqCorpus[y]||0)*(1+thisR)-seqW));
      }
      const seqDiv=document.getElementById('m6-seq-panel');
      if(seqDiv){
        const seqLabels=Array.from({length:seqYrs+1},(_,i)=>(sr.ret||60)+i);
        dc('m6-seq-chart');
        charts['m6-seq-chart']=new Chart(document.getElementById('chart-m6-seq').getContext('2d'),{type:'line',data:{labels:seqLabels,datasets:[
          {label:'Steady Returns ('+sr.name+')',data:baseCorpus,borderColor:'#16A34A',backgroundColor:'rgba(22,163,74,0.07)',borderWidth:2.5,tension:.3,pointRadius:0,fill:true},
          {label:'Bad Early Returns (Bear Yrs 1-5)',data:seqCorpus,borderColor:'#DC2626',backgroundColor:'rgba(220,38,38,0.06)',borderWidth:2.5,tension:.3,pointRadius:0,fill:true,borderDash:[5,3]},
        ]},options:{...CO,scales:{x:{...CO.scales.x,title:{display:true,text:'Age',color:'#94A3B8',font:{size:10}}},y:{...CO.scales.y}}}});
      }
    }
  },80);
}
function resetM6(){hide('m6-results');}
function loadM6fromProfile(){
  // Load GPS User Profile into Scenario A
  $('sca-age').value=GS.age;
  $('sca-ret').value=GS.ret;
  $('sca-cc').value=GS.cc;
  $('sca-mc').value=GS.mc;
  $('sca-su').value=GS.su;
  $('sca-inf').value=GS.inf;
  // Default return rate to GPS rr
  $('sca-r').value=GS.rr;
  $('sca-name').value='My Current Plan';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODULE 7 ‚Äî NPS Fund Allocation Optimizer
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function m7SlChange(changed){
  let e=parseInt($('m7-e').value),c=parseInt($('m7-c').value),g=parseInt($('m7-g').value);
  if(changed==='e'){ const rem=100-e; const tot=c+g; if(tot>0){c=Math.round(c/tot*rem);g=rem-c;}else{c=Math.round(rem/2);g=rem-c;}}
  else if(changed==='c'){ const rem=100-c; const tot=e+g; if(tot>0){e=Math.round(e/tot*rem);g=rem-e;}else{e=Math.round(rem/2);g=rem-e;}}
  else{ const rem=100-g; const tot=e+c; if(tot>0){e=Math.round(e/tot*rem);c=rem-e;}else{e=Math.round(rem/2);c=rem-e;}}
  // Apply NPS equity cap of 75% ‚Äî redistribute excess to G-Sec
  if(e>75){const excess=e-75;e=75;g+=excess;}
  e=Math.max(0,e); c=Math.max(0,c); g=Math.max(0,g);
  // Fix any residual rounding so total is exactly 100
  const diff=100-(e+c+g); g=Math.max(0,g+diff);
  $('m7-e').value=e; $('m7-c').value=c; $('m7-g').value=g;
  $('m7-e-v').textContent=e+'%'; $('m7-c-v').textContent=c+'%'; $('m7-g-v').textContent=g+'%';
  const total=e+c+g;
  const badge=$('m7-total-badge');
  badge.textContent='Total: '+total+'%';
  badge.style.background=total===100?'#dcfce7':'#fecaca';
  badge.style.color=total===100?'#15803D':'#B91C1C';
  const blended=(e*0.12+c*0.09+g*0.07)/100;
  $('m7-blend-rate').textContent=(blended*100).toFixed(2)+'% p.a.';
}

function calcM7(){
  const age=n('m7-age'),ret=n('m7-ret'),cc=n('m7-cc'),mc=n('m7-mc'),su=n('m7-su')/100;
  const income=n('m7-income'), slab=n('m7-slab')/100, other80c=n('m7-other80c')||0;
  const yrs=ret-age;
  if(yrs<=0){alert('Retirement age must exceed current age.');return;}
  if(mc<=0){alert('Monthly NPS contribution must be greater than zero.');return;}

  const ePct=parseInt($('m7-e').value)/100, cPct=parseInt($('m7-c').value)/100, gPct=parseInt($('m7-g').value)/100;
  const totalPct=Math.round((ePct+cPct+gPct)*100);
  if(totalPct!==100){alert('E + C + G allocation must total 100%. Currently: '+totalPct+'%');return;}

  const activeR=ePct*0.12+cPct*0.09+gPct*0.07;
  const lc75R=Math.max(0.001,n('m7-lc75')/100), lc50R=Math.max(0.001,n('m7-lc50')/100), lc25R=Math.max(0.001,n('m7-lc25')/100);
  const strategies=[
    {name:'Active Choice (Your Mix)',r:activeR,col:'#6D28D9',tag:'Custom'},
    {name:'Auto ‚Äî LC-75 Aggressive',r:lc75R,col:'#10B981',tag:'High Equity'},
    {name:'Auto ‚Äî LC-50 Moderate',r:lc50R,col:'#C8922A',tag:'Balanced'},
    {name:'Auto ‚Äî LC-25 Conservative',r:lc25R,col:'#60A5FA',tag:'Low Risk'},
  ];
  const results=strategies.map(s=>({...s, corpus:Math.max(0,calcCorpus(cc,mc,su,s.r,yrs))}));
  const best=results.reduce((b,r)=>r.corpus>b.corpus?r:b,results[0]);

  hide('m7-right-ph'); show('m7-results')
  markModDone(6);;

  $('m7-rg').innerHTML=results.map(r=>`<div class="rc${r.name===best.name?' hl':''}">
    <div class="rc-lbl">${r.tag}</div>
    <div class="rc-val" style="color:${r.col};font-size:14px">${fmt(r.corpus)}</div>
    <div class="rc-sub">${r.name}</div>
    <div class="rc-sub">@ ${(r.r*100).toFixed(1)}% p.a.</div>
    ${r.name===best.name?'<div style="margin-top:5px;font-size:9px;font-weight:700;color:#15803D;background:#dcfce7;padding:2px 8px;border-radius:20px;display:inline-block">‚òÖ BEST</div>':''}
  </div>`).join('');

  // ‚îÄ‚îÄ Tax benefit (corrected logic) ‚îÄ‚îÄ
  // 80C room available for NPS = 80C limit minus other 80C investments already used
  const annualNPS=mc*12;
  const max80C=150000;
  const nps80cRoom=Math.max(0, max80C - other80c);       // room left in 80C for NPS
  const nps80cDeduction=Math.min(annualNPS, nps80cRoom); // NPS portion going into 80C
  // 80CCD(1B): extra ‚Çπ50K for NPS independent of 80C, capped at remaining NPS contribution
  const nps80ccdDeduction=Math.min(50000, Math.max(0, annualNPS - nps80cDeduction));
  const totalDeduction=nps80cDeduction+nps80ccdDeduction;
  const taxSaved=totalDeduction*slab;
  const effectiveCost=Math.max(0,annualNPS-taxSaved);
  const totalTaxSaved=taxSaved*yrs;
  const effectiveReturn=annualNPS>0?((taxSaved/annualNPS)*100):0;

  $('m7-tax-grid').innerHTML=[
    {l:'Annual NPS Contribution',v:fmt(annualNPS)},
    {l:'Other 80C Investments',v:fmt(other80c)},
    {l:'NPS via 80C Deduction',v:fmt(nps80cDeduction)},
    {l:'NPS via 80CCD(1B) Exclusive',v:fmt(nps80ccdDeduction),hl:nps80ccdDeduction>0},
    {l:'Total NPS Tax Deduction',v:fmt(totalDeduction),hl:true},
    {l:'Tax Saved Annually',v:fmt(taxSaved),hl:true},
    {l:'Effective Cost of NPS',v:fmt(effectiveCost)},
    {l:'Total Tax Saved ('+yrs+' yrs)',v:fmt(totalTaxSaved),hl:true},
    {l:'Instant Return via Tax',v:effectiveReturn.toFixed(1)+'%'},
  ].map(c=>`<div class="rc${c.hl?' hl':''}"><div class="rc-lbl">${c.l}</div><div class="rc-val">${c.v}</div></div>`).join('');

  // Table
  const annuityApct=n('m1-apct')/100||0.40, annuityAr=n('m1-ar')/100||0.06;
  $('m7-tbody').innerHTML=results.map(r=>{
    const pension=r.corpus*annuityApct*annuityAr/12;
    const diff=r.corpus-best.corpus;
    const pct=best.corpus>0?((r.corpus/best.corpus)*100).toFixed(1)+'%':'‚Äî';
    return `<tr style="border-bottom:1px solid var(--light)">
      <td style="padding:11px 14px;font-size:12.5px;font-weight:600;color:${r.col}">${r.name}</td>
      <td style="padding:11px 14px;font-family:var(--mono);font-size:12px;text-align:right;color:var(--navy)">${(r.r*100).toFixed(1)}%</td>
      <td style="padding:11px 14px;font-family:var(--mono);font-size:12px;text-align:right;color:var(--teal);font-weight:700">${fmt(r.corpus)}</td>
      <td style="padding:11px 14px;font-family:var(--mono);font-size:12px;text-align:right;color:var(--gold)">${fmt(pension)}</td>
      <td style="padding:11px 14px;font-family:var(--mono);font-size:12px;text-align:right;color:${diff===0?'#16A34A':diff<0?'#DC2626':'#16A34A'}">${diff===0?'‚òÖ Best':(diff<0?'‚àí':'+')+fmt(Math.abs(diff))} (${pct})</td>
    </tr>`;
  }).join('');

  const isActiveBest=results[0].corpus===best.corpus;
  $('m7-tip').innerHTML=isActiveBest
    ?`<strong>üí° Your Active Choice wins!</strong> Your blend of ${Math.round(ePct*100)}% Equity / ${Math.round(cPct*100)}% Corporate / ${Math.round(gPct*100)}% G-Sec at ${(activeR*100).toFixed(2)}% blended return generates the highest corpus. Monitor and rebalance annually ‚Äî NPS equity cap is 75% in Active Choice.`
    :`<strong>üí° Auto Choice has an edge!</strong> ${best.name} is projected to build the largest corpus. LC-75 automatically tapers equity as you age ‚Äî ideal if you prefer passive de-risking without annual rebalancing. <strong>Note:</strong> All return assumptions here are long-run averages; actual returns will vary year to year.`;

  setTimeout(()=>{
    // Growth chart ‚Äî responsive:false to prevent blur
    dc('m7-growth');
    const step=Math.max(1,Math.ceil(yrs/38));
    const labels=[];
    for(let a=age;a<=ret;a+=step) labels.push(a);
    if(labels[labels.length-1]!==ret) labels.push(ret);
    const cols7=['#6D28D9','#10B981','#C8922A','#60A5FA'];
    charts['m7-growth']=new Chart($('chart-m7-growth').getContext('2d'),{type:'line',data:{labels,datasets:results.map((s,i)=>({
      label:s.name,
      data:labels.map(a=>Math.max(0,calcCorpus(cc,mc,su,s.r,a-age))),
      borderColor:cols7[i],backgroundColor:'transparent',borderWidth:i===0?3:1.8,tension:.4,pointRadius:0,fill:false,
      borderDash:i===0?[]:[5,4]
    }))},options:{...CO,responsive:false,scales:{x:{...CO.scales.x,title:{display:true,text:'Age',color:'#94A3B8',font:{size:10}}},y:{...CO.scales.y,title:{display:true,text:'Corpus (‚Çπ Nominal)',color:'#94A3B8',font:{size:10}}}}}});

    // Doughnut ‚Äî MUST use responsive:false to prevent blur on HiDPI screens
    dc('m7-pie');
    charts['m7-pie']=new Chart($('chart-m7-pie').getContext('2d'),{type:'doughnut',data:{
      labels:['Equity (E)','Corporate Bonds (C)','G-Sec (G)'],
      datasets:[{data:[Math.round(ePct*100),Math.round(cPct*100),Math.round(gPct*100)],backgroundColor:['#6D28D9','#C8922A','#60A5FA'],borderWidth:3,borderColor:'#fff',hoverOffset:8}]
    },options:{responsive:false,maintainAspectRatio:false,animation:false,cutout:'55%',
      plugins:{legend:{position:'bottom',labels:{color:'#64748B',font:{size:11},padding:12,boxWidth:12}},
        tooltip:{callbacks:{label:c=>' '+c.label+': '+c.raw+'%'}}}}});

    dc('m7-tax');
    const taxYrs=Array.from({length:yrs},(_,i)=>age+i+1);
    charts['m7-tax']=new Chart($('chart-m7-tax').getContext('2d'),{type:'line',data:{labels:taxYrs,datasets:[{
      label:'Cumulative Tax Saved (‚Çπ)',
      data:taxYrs.map((_,i)=>taxSaved*(i+1)),
      borderColor:'#C8922A',backgroundColor:'rgba(200,146,42,0.12)',borderWidth:2.5,tension:.4,pointRadius:0,fill:true
    }]},options:{...CO,responsive:false,...noLegend,scales:{x:{...CO.scales.x,title:{display:true,text:'Age',color:'#94A3B8',font:{size:10}}},y:{...CO.scales.y}}}});
  },80);
}
function resetM7(){hide('m7-results');show('m7-right-ph');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODULE 8 ‚Äî Corpus Sustainability Simulator
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcM8(){
  const corp=n('m8-corp'), retAge=n('m8-ret'), le=n('m8-le');
  const monthExp=n('m8-exp'), monthMed=n('m8-med');
  const inf=n('m8-inf')/100, minf=n('m8-minf')/100;
  const retR=n('m8-ret-r')/100, otherIncome=Math.max(0,n('m8-other'));

  // Input validation
  if(corp<=0){alert('Please enter a valid retirement corpus.');return;}
  if(retAge<=0){alert('Please enter a valid retirement age.');return;}
  if(le<=retAge){alert('Life expectancy must exceed retirement age.');return;}
  if(monthExp<0||monthMed<0){alert('Expenses cannot be negative.');return;}
  if(inf<0){alert('Inflation cannot be negative.');return;}
  if(retR<0){alert('Post-retirement return cannot be negative for this model.');return;}

  const postYrs=le-retAge;

  // ‚îÄ‚îÄ Bucket strategy ‚îÄ‚îÄ
  const b1=corp*0.15, b2=corp*0.35, b3=corp*0.50;
  $('m8-b1').textContent=fmt(b1);
  $('m8-b2').textContent=fmt(b2);
  $('m8-b3').textContent=fmt(b3);

  // ‚îÄ‚îÄ Year-by-year drawdown ‚îÄ‚îÄ
  const rows=[];
  let c=corp, depletedAge=null;
  let genExpAnnual=monthExp*12, medExpAnnual=monthMed*12;
  for(let i=0;i<postYrs;i++){
    const age=retAge+i;
    const totalExp=genExpAnnual+medExpAnnual;
    // Other income (pension, rental) first offsets expenses; only the NET is drawn from corpus
    const netWithdrawal=Math.max(0,totalExp-otherIncome);
    const alreadyDepleted=(c<=0);
    // corpus earns return first, then withdrawal happens at year-end (standard annuity)
    const cEnd=Math.max(0, c*(1+retR) - netWithdrawal);
    const isDepletionYear=(c>0 && cEnd<=0);
    rows.push({age, cStart:c, genExp:genExpAnnual, medExp:medExpAnnual, totalExp,
               netWithdrawal, otherIncome, cEnd, alreadyDepleted, isDepletionYear});
    if(isDepletionYear && !depletedAge) depletedAge=age+1; // corpus runs out during this year
    c=cEnd;
    genExpAnnual*=(1+inf);
    medExpAnnual*=(1+minf);
  }

  // ‚îÄ‚îÄ Sustainable inflation-adjusted withdrawal ‚Äî binary search (FIXED) ‚îÄ‚îÄ
  // Tests: if initial withdrawal grows with general inflation each year, does corpus survive?
  function testSustain(initAnnual){
    if(initAnnual<=0) return true;
    let tc=corp, ann=initAnnual;
    for(let i=0;i<postYrs;i++){
      const net=Math.max(0,ann-otherIncome);
      tc=tc*(1+retR)-net;
      if(tc<=0) return false;
      ann*=(1+inf); // inflation-adjusted withdrawal grows each year
    }
    return true;
  }
  // Binary search for sustainable withdrawal ‚Äî use corpus as safe upper bound
  const hiGuess=Math.max(corp/Math.max(1,postYrs), retR>0?corp*retR*2:0);
  let lo=0, hi=Math.max(hiGuess,corp,10000), sw=0;
  for(let i=0;i<60;i++){
    const mid=(lo+hi)/2;
    if(testSustain(mid)){ sw=mid; lo=mid; }
    else { hi=mid; }
  }
  const sustainableMonthly=Math.max(0,sw/12);

  hide('m8-right-ph'); show('m8-results');

  const surplus=!depletedAge;
  const depletedLabel=depletedAge?'Age '+depletedAge+' ‚ö†Ô∏è':'Beyond Age '+le+' ‚úÖ';
  const banner=$('m8-banner');
  banner.textContent=surplus
    ?'‚úÖ Great news ‚Äî your corpus lasts beyond age '+le+'! Your retirement is fully funded.'
    :'‚ö†Ô∏è Corpus depletes at age '+depletedAge+'. See advice below for corrective actions.';
  banner.style.cssText=`border-radius:var(--r-sm);padding:18px 22px;margin-bottom:16px;text-align:center;font-size:14px;font-weight:700;line-height:1.8;background:${surplus?'#dcfce7':'#fecaca'};color:${surplus?'#15803D':'#B91C1C'};border:1px solid ${surplus?'#86efac':'#fca5a5'}`;

  const initMonthly=monthExp+monthMed;
  const vsRatio=sustainableMonthly>0?(initMonthly/sustainableMonthly*100).toFixed(0)+'%':'N/A';
  $('m8-rg').innerHTML=[
    {l:'Total Corpus at Retirement',v:fmt(corp)},
    {l:'Corpus Runs Out At',v:depletedLabel,hl:!surplus},
    {l:'Retirement Duration',v:postYrs+' yrs (age '+retAge+'‚Üí'+le+')'},
    {l:'Sustainable Monthly Spend',v:fmt(sustainableMonthly),hl:true},
    {l:'Your Planned Monthly Budget',v:fmt(initMonthly)},
    {l:'Budget as % of Sustainable',v:vsRatio},
    {l:'Other Income/yr (pension etc.)',v:fmt(otherIncome)},
    {l:'Bucket 3 ‚Äî Long-term Growth',v:fmt(b3)},
  ].map(c=>`<div class="rc${c.hl?' hl':''}"><div class="rc-lbl">${c.l}</div><div class="rc-val">${c.v}</div></div>`).join('');

  // ‚îÄ‚îÄ Runway table ‚îÄ‚îÄ
  $('m8-tbody').innerHTML=rows.map(r=>{
    // Status: depletionYear = red/critical; cEnd < 2yr expenses = warning; else OK
    const twoYrExp=r.totalExp*2;
    let statusColor, statusTxt;
    if(r.alreadyDepleted){statusColor='#7F1D1D';statusTxt='‚úï No Corpus';}
    else if(r.isDepletionYear){statusColor='#B91C1C';statusTxt='‚ö†Ô∏è Depletes';}
    else if(r.cEnd<twoYrExp){statusColor='#C2410C';statusTxt='‚ö†Ô∏è Low';}
    else if(r.cEnd<twoYrExp*3){statusColor='#D97706';statusTxt='üü° Watch';}
    else{statusColor='#16A34A';statusTxt='‚úÖ OK';}
    return `<tr style="border-bottom:1px solid var(--light);background:${r.isDepletionYear?'rgba(220,38,38,0.06)':r.alreadyDepleted?'rgba(220,38,38,0.03)':''}">
      <td style="padding:9px 12px;font-family:var(--mono);font-size:12px;font-weight:700;color:${r.isDepletionYear?'#B91C1C':'var(--navy)'}">${r.age}</td>
      <td style="padding:9px 12px;font-family:var(--mono);font-size:11px;text-align:right">${fmt(r.cStart)}</td>
      <td style="padding:9px 12px;font-family:var(--mono);font-size:11px;text-align:right;color:var(--coral)">${fmt(r.totalExp)}</td>
      <td style="padding:9px 12px;font-family:var(--mono);font-size:11px;text-align:right;color:var(--green)">${fmt(r.otherIncome)}</td>
      <td style="padding:9px 12px;font-family:var(--mono);font-size:11px;text-align:right;color:${r.cEnd>0?'var(--teal)':'#DC2626'};font-weight:700">${fmt(r.cEnd)}</td>
      <td style="padding:9px 12px;text-align:right"><span style="font-size:10px;font-weight:700;color:${statusColor}">${statusTxt}</span></td>
    </tr>`;
  }).join('');

  // ‚îÄ‚îÄ Advice ‚îÄ‚îÄ
  const advice=$('m8-advice');
  if(surplus){
    const headroom=fmt(sustainableMonthly-initMonthly);
    advice.innerHTML=`<strong>üéâ Excellent!</strong> Your corpus supports you beyond age ${le}. Your sustainable inflation-adjusted monthly spend is <strong>${fmt(sustainableMonthly)}/mo</strong> ‚Äî your planned budget of <strong>${fmt(initMonthly)}/mo</strong> leaves a safety headroom of <strong>${headroom}/mo</strong>. Use the 3-Bucket Strategy: Bucket 1 (${fmt(b1)} in FDs/liquid, 0‚Äì5 yrs liquidity), Bucket 2 (${fmt(b2)} in balanced funds, 5‚Äì15 yr), Bucket 3 (${fmt(b3)} in equity, 15+ yr growth).`;
  } else {
    const annualGap=(initMonthly-sustainableMonthly)*12;
    advice.innerHTML=`<strong>‚ö†Ô∏è Action Required.</strong> Corpus depletes at age ${depletedAge} ‚Äî ${depletedAge-retAge} years into retirement. Your sustainable monthly spend is only <strong>${fmt(sustainableMonthly)}/mo</strong> vs planned <strong>${fmt(initMonthly)}/mo</strong> (gap: <strong>${fmt(initMonthly-sustainableMonthly)}/mo</strong>). Options: (1) Reduce expenses by ${fmt(initMonthly-sustainableMonthly)}/mo, (2) Increase corpus by saving more pre-retirement, (3) Secure more guaranteed income ‚Äî NPS annuity, EPF pension, or rental income ‚Äî to reduce corpus dependency, (4) Delay retirement by a few years to extend accumulation.`;
  }

  markModDone(7);
  setTimeout(()=>{
    // ‚îÄ‚îÄ Drawdown chart ‚Äî responsive:false prevents HiDPI blur ‚îÄ‚îÄ
    dc('m8-draw');
    const ages=rows.map(r=>r.age);
    charts['m8-draw']=new Chart($('chart-m8-draw').getContext('2d'),{type:'line',data:{labels:ages,datasets:[
      {label:'Corpus Balance',data:rows.map(r=>r.cStart),borderColor:'#0A7C6E',backgroundColor:'rgba(10,124,110,0.10)',borderWidth:2.5,tension:.35,pointRadius:0,fill:true},
      {label:'Annual Expense (inflating)',data:rows.map(r=>r.totalExp),borderColor:'#DC2626',backgroundColor:'transparent',borderWidth:2,tension:.35,pointRadius:0,fill:false,borderDash:[5,3]},
      ...(otherIncome>0?[{label:'Other Annual Income',data:rows.map(()=>otherIncome),borderColor:'#16A34A',backgroundColor:'transparent',borderWidth:1.5,tension:0,pointRadius:0,borderDash:[3,3]}]:[]),
    ]},options:{...CO,responsive:false,scales:{
      x:{...CO.scales.x,title:{display:true,text:'Age',color:'#94A3B8',font:{size:10}}},
      y:{...CO.scales.y,title:{display:true,text:'Amount (‚Çπ Nominal)',color:'#94A3B8',font:{size:10}}}
    }}});

    // ‚îÄ‚îÄ Expense breakdown bar ‚îÄ‚îÄ
    dc('m8-exp');
    const sampleIdx=rows.reduce((acc,_,i)=>{if(i%Math.max(1,Math.floor(postYrs/12))===0||i===rows.length-1)acc.push(i);return acc;},[]);
    const sampledRows=sampleIdx.map(i=>rows[i]);
    charts['m8-exp']=new Chart($('chart-m8-exp').getContext('2d'),{type:'bar',data:{
      labels:sampledRows.map(r=>r.age),
      datasets:[
        {label:'General Expenses (inflation '+Math.round(inf*100)+'%)',data:sampledRows.map(r=>r.genExp),backgroundColor:'rgba(29,78,216,0.65)',stack:'s'},
        {label:'Medical Expenses (inflation '+Math.round(minf*100)+'%)',data:sampledRows.map(r=>r.medExp),backgroundColor:'rgba(220,38,38,0.65)',stack:'s'},
      ]},options:{...CO,responsive:false,plugins:{...CO.plugins,tooltip:{callbacks:{label:c=>' '+c.dataset.label+': '+fmt(c.raw)+'/yr'}}}}});

    // ‚îÄ‚îÄ Bucket doughnut ‚Äî responsive:false ‚îÄ‚îÄ
    dc('m8-bucket');
    charts['m8-bucket']=new Chart($('chart-m8-bucket').getContext('2d'),{type:'doughnut',data:{
      labels:['Bucket 1 ‚Äî Liquid FD/Savings (0‚Äì5 yr)','Bucket 2 ‚Äî Balanced Funds (5‚Äì15 yr)','Bucket 3 ‚Äî Equity Growth (15+ yr)'],
      datasets:[{data:[b1,b2,b3],backgroundColor:['#1D4ED8','#C8922A','#16A34A'],borderWidth:3,borderColor:'#fff',hoverOffset:8}]
    },options:{responsive:false,maintainAspectRatio:false,animation:false,cutout:'50%',
      plugins:{legend:{position:'bottom',labels:{color:'#64748B',font:{size:10},padding:10,boxWidth:12}},
        tooltip:{callbacks:{label:c=>' '+c.label+'\n  '+fmt(c.raw)+' ('+((c.raw/corp)*100).toFixed(0)+'%)'}}}}});
  },80);
}
function resetM8(){hide('m8-results');show('m8-right-ph');}
function pullM8fromM1(){
  // Pull from M1: use GS corpus estimate (base scenario)
  const age=GS.age,ret=GS.ret,cc=GS.cc,mc=GS.mc,su=GS.su/100,inf=GS.inf/100;
  const yrs=ret-age;
  if(yrs<=0){alert('Set valid Age and Retirement Age in the User Profile first.');return;}
  const rates=getM1Rates();
  const corp=calcCorpus(cc,mc,su,rates[1],yrs);
  $('m8-corp').value=Math.round(corp);
  $('m8-ret').value=ret;
  $('m8-inf').value=GS.inf;
  $('m8-exp').value=Math.round(GS.exp); // today's monthly expense ‚Äî M8 inflates this itself
  alert('‚úÖ Pulled projected NPS corpus (base scenario) from Module 1: '+fmt(corp)+'\nExpenses set to today\'s value (‚Çπ'+Math.round(GS.exp).toLocaleString('en-IN')+'/mo) ‚Äî Module 8 will inflate these to retirement date.');
}
function pullM8fromM3(){
  if(!G3.totalCorpus){alert('Please run Corpus Integrator (Module 3) first.');return;}
  $('m8-corp').value=Math.round(G3.totalCorpus);
  $('m8-ret').value=G3.ret||GS.ret;
  $('m8-inf').value=Math.round((G3.inf||0.06)*100);
  // G3.retExp is already inflation-adjusted to retirement date; M8 expects today's monthly expense
  // Reverse-inflate to get today's value so M8 can re-inflate correctly
  const m8yrs=(G3.ret||GS.ret)-(n('m3-age')||GS.age);
  const todayExp=m8yrs>0&&G3.retExp?G3.retExp/Math.pow(1+(G3.inf||0.06),m8yrs):G3.retExp||0;
  $('m8-exp').value=Math.round(todayExp/12);
  $('m8-other').value=Math.round((G3.guarIncome||0)/12);
  alert('‚úÖ Pulled total corpus from Module 3: '+fmt(G3.totalCorpus)+'\nExpenses set to today\'s value (‚Çπ'+Math.round(todayExp/12).toLocaleString('en-IN')+'/mo) ‚Äî Module 8 will inflate these.\nGuaranteed income set as other income: '+fmt(G3.guarIncome/12)+'/mo');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODULE 9 ‚Äî Pre-Retirement Health Check + 35X
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcM9(){
  const age=n('m9-age'), ret=n('m9-ret'), income=n('m9-income'), exp=n('m9-exp');
  const ef=n('m9-ef'), term=n('m9-term'), health=n('m9-health');
  const savings=n('m9-savings'), rr=safeReturnRate(n('m9-rr'))/100, inf=n('m9-inf')/100;
  const yrs=ret-age;

  // Input guards
  if(age<=0||age>=100){alert('Please enter a valid current age.');return;}
  if(ret<=age){alert('Retirement age must exceed current age.');return;}
  if(income<0){alert('Income cannot be negative.');return;}
  if(exp<0){alert('Expenses cannot be negative.');return;}
  if(exp>income&&income>0){alert('Warning: Expenses exceed income. Check inputs ‚Äî proceeding anyway.');}

  hide('m9-right-ph'); show('m9-results');
  markModDone(8);
  // PFRDA premature exit warning: before age 60, NPS requires 80% annuity (not 40%)
  const earlyExitNote=$('m9-early-exit-note');
  if(ret<60){
    if(earlyExitNote){
      earlyExitNote.innerHTML='<strong>‚öñÔ∏è PFRDA Early Exit Rule:</strong> You plan to retire at age '+ret+', which is before age 60. Under PFRDA regulations, early exit from NPS (before 60) requires <strong>at least 80% of your corpus to be used to purchase annuity</strong> (vs. 40% at normal retirement). Only 20% can be withdrawn as lump sum. Plan your cash flow accordingly.';
      earlyExitNote.style.display='';
    }
  } else if(earlyExitNote){
    earlyExitNote.style.display='none';
  }

  // ‚îÄ‚îÄ Safety net checks ‚îÄ‚îÄ
  const annualIncome=income*12;
  const efMin=exp*6, efGood=exp*10;
  const termMin=annualIncome*8, termGood=annualIncome*12;
  const healthMin=500000, healthGood=1000000;
  const monthlySurplus=Math.max(0,income-exp);
  const savings_pct=income>0?(monthlySurplus/income)*100:0;

  function check(label, current, min, good, fmtFn, tip){
    const ok=current>=good, warn=current>=min&&current<good;
    const color=ok?'#15803D':warn?'#92400E':'#B91C1C';
    const bg=ok?'#dcfce7':warn?'#fef9c3':'#fecaca';
    const icon=ok?'‚úÖ':warn?'‚ö†Ô∏è':'üî¥';
    const label2=ok?'Good ‚úì':warn?'Minimum Met':'Below Minimum';
    return `<div style="display:flex;align-items:flex-start;gap:13px;padding:12px;border-radius:var(--r-sm);background:${bg};border:1px solid ${ok?'#86efac':warn?'#fde68a':'#fca5a5'};margin-bottom:10px">
      <div style="font-size:22px;flex-shrink:0">${icon}</div>
      <div style="flex:1">
        <div style="font-weight:700;font-size:13px;color:var(--navy)">${label} ‚Äî <span style="color:${color}">${label2}</span></div>
        <div style="font-size:11.5px;color:var(--muted);margin-top:3px">You have: <strong>${fmtFn(current)}</strong> &nbsp;|&nbsp; Minimum: <strong>${fmtFn(min)}</strong> &nbsp;|&nbsp; Ideal: <strong>${fmtFn(good)}</strong></div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px;line-height:1.6">${tip}</div>
      </div>
    </div>`;
  }

  const savingsRateOk=savings_pct>=30, savingsRateWarn=savings_pct>=15&&savings_pct<30;
  const srColor=savingsRateOk?'#15803D':savingsRateWarn?'#92400E':'#B91C1C';
  const srBg=savingsRateOk?'#dcfce7':savingsRateWarn?'#fef9c3':'#fecaca';

  $('m9-checks').innerHTML=
    (income===0?'<div style="padding:10px;color:var(--coral)">‚ö†Ô∏è Enter your income to see insurance adequacy checks.</div>':
      check('Term Insurance Cover', term, termMin, termGood, fmt,
        'Thumb rule: 8‚Äì12√ó annual income. Pure term plan ‚Äî not ULIP or endowment. Cover until at least retirement age. With '+(income>0?'your income of '+fmt(annualIncome)+', minimum cover is '+fmt(termMin):'this income')+'.')+
      check('Emergency Fund', ef, efMin, efGood, fmt,
        'Thumb rule: 6‚Äì10 months of expenses. Keep in liquid FD or savings account ‚Äî NOT market-linked. With expenses of '+fmt(exp)+'/mo, target minimum is '+fmt(efMin)+' (6 months).')+
      check('Health Insurance Cover', health, healthMin, healthGood, v=>'‚Çπ'+Math.round(v/100000).toFixed(1)+'L',
        'Recommended: ‚Çπ10L+ base cover + Super Top-Up policy for ‚Çπ1Cr total protection at low premium. Medical inflation in India runs 10‚Äì12% p.a. ‚Äî review every 3 years.')+
    `<div style="display:flex;align-items:flex-start;gap:13px;padding:12px;border-radius:var(--r-sm);background:${srBg};border:1px solid ${savingsRateOk?'#86efac':savingsRateWarn?'#fde68a':'#fca5a5'};margin-bottom:10px">
      <div style="font-size:22px;flex-shrink:0">${savingsRateOk?'‚úÖ':savingsRateWarn?'‚ö†Ô∏è':'üî¥'}</div>
      <div style="flex:1">
        <div style="font-weight:700;font-size:13px;color:var(--navy)">Savings Rate ‚Äî <span style="color:${srColor}">${savings_pct.toFixed(1)}% of take-home income</span></div>
        <div style="font-size:11.5px;color:var(--muted);margin-top:3px">Monthly surplus: <strong>${fmt(monthlySurplus)}</strong> &nbsp;|&nbsp; Ideal target: 30%+ for comfortable retirement</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">A savings rate below 15% makes it very hard to reach retirement goals. Aim to raise it by 1% each year using NPS step-up contributions.</div>
      </div>
    </div>`);

  // ‚îÄ‚îÄ 35X Rule ‚îÄ‚îÄ
  const retExpAnnual=exp*12*Math.pow(1+inf,yrs);
  const target35x=retExpAnnual*35;
  const target40x=retExpAnnual*40;
  // Corpus projection uses current savings + monthly surplus invested ‚Äî clarifies it's the
  // MAXIMUM possible if the entire surplus is invested (not just NPS contribution)
  // FIXED: Use step-up from GPS (GS.su/100) instead of hardcoded 0.
  // Old bug: calcCorpus(savings, monthlySurplus, 0, rr, yrs) ignored annual step-up entirely,
  // understating projected corpus by up to 55% for users with a positive step-up rate.
  const su9 = (n('m9-su') || GS.su) / 100;
  const corpusOnTrack=calcCorpus(savings, monthlySurplus, su9, rr, yrs);
  const pct35x=Math.min(200, target35x>0?(corpusOnTrack/target35x)*100:0);
  const needed35x=Math.max(0, reqPMT(target35x, savings, rr, yrs));

  $('m9-35x').innerHTML=[
    {l:'Annual Expense at Retirement',v:fmt(retExpAnnual)},
    {l:'35X Target Corpus',v:fmt(target35x),hl:true},
    {l:'40X Stretch Target',v:fmt(target40x)},
    {l:'Projected Corpus*',v:fmt(corpusOnTrack),hl:corpusOnTrack>=target35x},
    {l:'35X Readiness',v:pct35x.toFixed(1)+'%',hl:pct35x>=100},
    {l:'Monthly Saving Needed (35X)',v:fmt(needed35x),hl:true},
  ].map(c=>`<div class="rc${c.hl?' hl':''}"><div class="rc-lbl">${c.l}</div><div class="rc-val">${c.v}</div></div>`).join('');

  const barPct=Math.min(100,pct35x);
  const barColor=pct35x>=100?'#16A34A':pct35x>=70?'#D97706':'#DC2626';
  $('m9-35x-bar').innerHTML=`
    <div style="margin-bottom:5px;display:flex;justify-content:space-between;font-size:11px;font-weight:700;color:var(--navy)">
      <span>35X Readiness Progress</span><span style="color:${barColor}">${pct35x.toFixed(1)}%</span>
    </div>
    <div style="height:14px;background:var(--bg2);border-radius:10px;overflow:hidden">
      <div style="height:100%;width:${barPct}%;background:${barColor};border-radius:10px;transition:width .8s ease"></div>
    </div>
    <div style="font-size:10.5px;color:var(--muted);margin-top:5px">
      ${pct35x>=100?'‚úÖ On track to exceed 35X target!':pct35x>=70?'‚ö†Ô∏è Getting closer ‚Äî you need approx ‚Çπ'+fmt(needed35x)+'/mo additional saving':'üî¥ Significant gap ‚Äî ‚Çπ'+fmt(needed35x)+'/mo required to reach 35X by age '+ret}
    </div>
    <div style="font-size:10px;color:var(--faint);margin-top:4px">* Projected corpus assumes your full monthly surplus of ‚Çπ${fmt(monthlySurplus)} is invested at ${(rr*100).toFixed(1)}% p.a. with ${((su9||0)*100).toFixed(0)}% annual step-up. Actual corpus will depend on how much goes into NPS vs other instruments.</div>
    <div style="background:#EFF6FF;border:1px solid #BFDBFE;border-radius:8px;padding:10px 14px;margin-top:10px;font-size:11px;color:#1E40AF;line-height:1.7">
      <strong>üìñ 35X vs 40X Guide:</strong>
      Use <strong>35X</strong> if you plan a modest retirement with a mix of guaranteed income (NPS annuity, EPF), retire at age 58‚Äì60, and have post-retirement income sources. It assumes a 2.85% real withdrawal rate.
      Use <strong>40X</strong> as a safety buffer if you retire early (before 58), have high medical expenses or dependents, or want to account for longevity beyond 85.
      <em>üí° IRDAI mortality tables suggest 25% of 60-year-olds survive past 88. Consider planning to age 90 for safety.</em>
    </div>`;

  // ‚îÄ‚îÄ Sensitivity Table ‚Äî always include the user's planned retirement age ‚îÄ‚îÄ
  const baseAges=[50,52,55,58,60,62,65];
  const retAges=[...new Set([...baseAges,ret])].filter(a=>a>age).sort((a,b)=>a-b);
  $('m9-tbody').innerHTML=retAges.map(rAge=>{
    const ys=rAge-age;
    if(ys<=0) return '';
    const expAtRet=exp*12*Math.pow(1+inf,ys);
    const corp35x=expAtRet*35;
    const reqMC=Math.max(0,reqPMT(corp35x,savings,rr,ys));
    const pctIncome=income>0?(reqMC/income)*100:999;
    const feasible=pctIncome<=40, tight=pctIncome>40&&pctIncome<=70;
    const fColor=feasible?'#15803D':tight?'#92400E':'#B91C1C';
    const fTxt=feasible?'‚úÖ Feasible':tight?'‚ö†Ô∏è Stretch':'üî¥ Difficult';
    const isCurrent=rAge===ret;
    return `<tr style="border-bottom:1px solid var(--light);background:${isCurrent?'rgba(18,179,156,0.06)':''}">
      <td style="padding:10px 14px;font-family:var(--mono);font-size:13px;font-weight:${isCurrent?'700':'400'};color:${isCurrent?'var(--teal)':'var(--navy)'}">${rAge}${isCurrent?' ‚òÖ':''}</td>
      <td style="padding:10px 14px;font-family:var(--mono);font-size:12px;text-align:right">${ys} yrs</td>
      <td style="padding:10px 14px;font-family:var(--mono);font-size:12px;text-align:right;color:var(--navy)">${fmt(corp35x)}</td>
      <td style="padding:10px 14px;font-family:var(--mono);font-size:12px;text-align:right;color:var(--teal);font-weight:700">${fmt(reqMC)}</td>
      <td style="padding:10px 14px;font-family:var(--mono);font-size:12px;text-align:right">${income>0?pctIncome.toFixed(1)+'%':'‚Äî'}</td>
      <td style="padding:10px 14px;text-align:right"><span style="font-size:10.5px;font-weight:700;color:${fColor}">${fTxt}</span></td>
    </tr>`;
  }).join('');

  $('m9-advice').innerHTML=`<strong>üìã Summary:</strong> For a comfortable retirement at age <strong>${ret}</strong> you need <strong>${fmt(target35x)}</strong> (35√ó of ‚Çπ${fmt(retExpAnnual)}/yr). You are at <strong>${pct35x.toFixed(1)}% readiness</strong> (assuming full monthly surplus invested). ${pct35x>=100?'You are on track ‚Äî now focus on protecting what you\'ve built with adequate insurance and gradual de-risking as you near retirement.':'To bridge the gap, target investing at least ‚Çπ'+fmt(needed35x)+'/mo across NPS and other instruments. Use Module 7 to maximise the NPS tax advantage.'}`;

  setTimeout(()=>{
    dc('m9-sens');
    const sensData=retAges.map(rAge=>{
      const ys=rAge-age;
      return ys>0?Math.max(0,reqPMT(exp*12*Math.pow(1+inf,ys)*35,savings,rr,ys)):0;
    });
    const barColors9=retAges.map(a=>{
      const ys=a-age;
      if(ys<=0) return '#94A3B8';
      const pct=income>0?reqPMT(exp*12*Math.pow(1+inf,ys)*35,savings,rr,ys)/income*100:100;
      return pct<=40?'#16A34A':pct<=70?'#D97706':'#DC2626';
    });
    charts['m9-sens']=new Chart($('chart-m9-sens').getContext('2d'),{type:'bar',data:{
      labels:retAges.map(a=>a===ret?'Age '+a+' ‚òÖ':'Age '+a),
      datasets:[{label:'Monthly Saving Needed (‚Çπ)',data:sensData,backgroundColor:barColors9,borderRadius:8,borderWidth:0}]
    },options:{...CO,responsive:false,...noLegend,plugins:{...CO.plugins,legend:{display:false},tooltip:{callbacks:{label:c=>' ‚Çπ'+Math.round(c.raw).toLocaleString('en-IN')+'/month'}}}}});

    dc('m9-alloc');
    // Pie: expenses, savings to NPS, other savings, unused
    const npsMonthly=n('gps-mc')||0;
    const otherSavings=Math.max(0,monthlySurplus-npsMonthly);
    const allocRaw=[exp,npsMonthly,otherSavings,Math.max(0,income-exp-monthlySurplus)];
    const dataPoints=allocRaw.filter(v=>v>0);
    const dataLabels=['Monthly Expenses','NPS Contribution','Other Savings','Residual/Unaccounted'];
    const dataColours=['#DC2626','#0A7C6E','#1D4ED8','#94A3B8'];
    const nonZeroIdx=allocRaw.map((v,i)=>v>0?i:-1).filter(i=>i>=0);
    charts['m9-alloc']=new Chart($('chart-m9-alloc').getContext('2d'),{type:'doughnut',data:{
      labels:nonZeroIdx.map(i=>dataLabels[i]),
      datasets:[{data:nonZeroIdx.map(i=>dataPoints[nonZeroIdx.indexOf(i)]),
        backgroundColor:nonZeroIdx.map(i=>dataColours[i]),borderWidth:3,borderColor:'#fff',hoverOffset:8}]
    },options:{responsive:false,maintainAspectRatio:false,animation:false,cutout:'50%',
      plugins:{legend:{position:'bottom',labels:{color:'#64748B',font:{size:11},padding:10,boxWidth:12}},
        tooltip:{callbacks:{label:c=>' '+c.label+': '+fmt(c.raw)+'/mo'}}}}});
  },80);
}
function resetM9(){hide('m9-results');show('m9-right-ph');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INITIALISATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
$('m1-fund').addEventListener('change',m1FundChange);
// Init M7 sliders
setTimeout(()=>m7SlChange('e'),50);
// Init Global Profile Sync
initSync();
// Init tab scroll arrows
setTimeout(updateTabArrows, 200);
$('tabs-scroll').addEventListener('scroll', updateTabArrows);

</script>
</body>
</html>
